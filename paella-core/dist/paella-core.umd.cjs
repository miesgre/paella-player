(function(w,F){typeof exports=="object"&&typeof module<"u"?F(exports):typeof define=="function"&&define.amd?define(["exports"],F):(w=typeof globalThis<"u"?globalThis:w||self,F(w["paella-core"]={}))})(this,function(w){"use strict";var Ml=(w,F,ie)=>{if(!F.has(w))throw TypeError("Cannot "+ie)};var Je=(w,F,ie)=>(Ml(w,F,"read from private field"),ie?ie.call(w):F.get(w)),Gn=(w,F,ie)=>{if(F.has(w))throw TypeError("Cannot add the same private member more than once");F instanceof WeakSet?F.add(w):F.set(w,ie)},Vn=(w,F,ie,X)=>(Ml(w,F,"write to private field"),X?X.call(w,ie):F.set(w,ie),ie);var lt,ct;const F=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function ie(n,e,t,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(e)||(e=[e]),e.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:t,unregisterOnUnload:i})}),t}function X(n,e,t={}){n.__eventListeners__&&n.__eventListeners__[e]&&n.__eventListeners__[e].forEach(i=>i.callback(t))}function ht(n,e,t={}){n.ready&&X(n,e,t)}function Nl(n){if(n.__eventListeners__)for(const e in n.__eventListeners__)n.__eventListeners__[e]=n.__eventListeners__[e].filter(t=>t.unregisterOnUnload==!1),n.log.debug("Unregister event: "+n.__eventListeners__[e])}class ut{constructor(e){this._player=e}get player(){return this._player}}function Wi({tag:n="div",attributes:e={},children:t="",innerText:i="",parent:s=null}){const r=document.createElement(n);r.innerText=i;for(let a in e)r.setAttribute(a,e[a]);return r.innerHTML=t,s&&s.appendChild(r),r}function j(n,e=null){const t=document.createElement("div");t.innerHTML=n;const i=t.children[0];return e&&e.appendChild(i),i}class be extends ut{constructor(e,{tag:t="div",attributes:i=[],children:s="",parent:r=null}){super(e),this._element=Wi({tag:t,attributes:i,children:s,parent:r}),Object.defineProperty(this,t,{get:()=>this._element})}get element(){return this._element}get parent(){return this._element.parentElement}hide(){this.element.style.display="none"}show(e="block"){this.element.style.display=null}get isVisible(){const e=window.getComputedStyle(this.element);return e.display!=="none"&&e.display!==""}setAttribute(e,t){this._element.setAttribute(e,t)}removeFromParent(){var e;(e=this._element.parentElement)==null||e.removeChild(this._element)}setParent(e){this.removeFromParent(),e.appendChild(this._element)}}const Hn=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.25099,40.6376,0.938594)">
            <path d="M26,18.498C26,16.566 24.356,15 22.327,15C17.811,15 10.189,15 5.673,15C3.644,15 2,16.566 2,18.498C2,22.151 2,27.849 2,31.502C2,33.434 3.644,35 5.673,35C10.189,35 17.811,35 22.327,35C24.356,35 26,33.434 26,31.502C26,27.849 26,22.151 26,18.498Z" />
        </g>
        <path d="M-2.889,42.341L-16.002,42.341C-17.664,42.341 -19.01,41.345 -19.01,40.117L-19.01,11.346L-15.787,13.728L-15.787,36.879C-15.787,37.695 -15.348,38.478 -14.567,39.056C-13.785,39.633 -12.726,39.958 -11.621,39.958L-2.889,39.958L-2.889,42.341ZM30.962,18.512L30.962,8.485C30.962,7.669 30.523,6.886 29.741,6.308C28.96,5.731 27.9,5.406 26.795,5.406L-4.721,5.406L-7.945,3.024L31.181,3.024C32.842,3.024 34.189,4.019 34.189,5.247L34.189,18.512L30.962,18.512Z" />
        <g transform="matrix(-0.595969,-0.440448,-1.13993,0.842464,17.4661,11.4472)">
            <path d="M18.389,14.006L18.389,18L5,11L18.389,4L18.389,7.994L36,7.994L36,14.006L18.389,14.006Z" />
        </g>
    </g>
</svg>
`,_t=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.707107,0.707107,-0.707107,0.707107,20,-8.28427)">
        <path d="M23,17L23,4.998C23,4.203 22.684,3.44 22.122,2.878C21.56,2.316 20.797,2 20.002,2C20.001,2 19.999,2 19.998,2C19.203,2 18.44,2.316 17.878,2.878C17.316,3.44 17,4.203 17,4.998C17,9.375 17,17 17,17L4.998,17C4.203,17 3.44,17.316 2.878,17.878C2.316,18.44 2,19.203 2,19.998C2,19.999 2,20.001 2,20.002C2,20.797 2.316,21.56 2.878,22.122C3.44,22.684 4.203,23 4.998,23C9.375,23 17,23 17,23L17,35.002C17,35.797 17.316,36.56 17.878,37.122C18.44,37.684 19.203,38 19.998,38C19.999,38 20.001,38 20.002,38C20.797,38 21.56,37.684 22.122,37.122C22.684,36.56 23,35.797 23,35.002C23,30.625 23,23 23,23L35.002,23C35.797,23 36.56,22.684 37.122,22.122C37.684,21.56 38,20.797 38,20.002C38,20.001 38,19.999 38,19.998C38,19.203 37.684,18.44 37.122,17.878C36.56,17.316 35.797,17 35.002,17C30.625,17 23,17 23,17Z"/>
    </g>
</svg>`,xe=[];function Kn(n,e,t){if(e){e.setAttribute("aria-pressed",!0);const{top:i,left:s,right:r,bottom:a,width:o,height:l}=e.getBoundingClientRect(),c=s+o/2,h=i+l/2,u=document.body.scrollTop,d=window.innerWidth,g=window.innerHeight,f=window.innerWidth/2,m=window.innerHeight/2;if(t.style.left="",t.style.right="",t.style.bottom="",t.style.top="",t.style.width="",t.style.height="",t.classList.remove("static-position"),f>c&&m<=h){const p=g-(a-l);t.style.left=`${s}px`,t.style.bottom=`${p}px`,t.style.maxHeight=`calc(100vh - ${p}px - 10px)`}else if(f>c&&m>h)t.style.left=`${s}px`,t.style.top=`${i+l+u}px`,t.style.maxHeight=`calc(100vh - ${i+l}px - 10px)`;else if(f<=c&&m>h)t.style.right=`${d-r}px`,t.style.top=`${i+l+u}px`,t.style.maxHeight=`calc(100vh - ${i+l}px - 10px)`;else if(f<=c&&m<=h){const p=g-(a-l);t.style.right=`${d-r}px`,t.style.bottom=`${p}px`,t.style.maxHeight=`calc(100vh - ${p}px - 10px)`}setTimeout(()=>{t.offsetTop<0&&(t.style.top="0px")},100)}}function Ul(n){n.__hidePopUpActionContainer||(n.__hidePopUpActionContainer=j('<div class="hide-popup-action-container"></div>'),n.videoContainer.element.appendChild(n.__hidePopUpActionContainer),n.__hidePopUpActionContainer.style.position="absolute",n.__hidePopUpActionContainer.style.left="0px",n.__hidePopUpActionContainer.style.top="0px",n.__hidePopUpActionContainer.style.right="0px",n.__hidePopUpActionContainer.style.bottom="0px",n.__hidePopUpActionContainer.style.zIndex=500,n.__hidePopUpActionContainer.addEventListener("click",e=>{Le.HideAllPopUps(!1),e.stopPropagation()})),n.__hidePopUpActionContainer.style.display="block"}function Bl(n){n.__hidePopUpActionContainer&&(n.__hidePopUpActionContainer.style.display="none")}function $l(n,e,t,i){const l=e.left-n.x,c=e.top-n.y,h=n.width-l,u=n.height-c;switch(!0){case(l<=10&&c<=10&&i):return"RESIZE_NW";case(l<=10&&u<=10&&i):return"RESIZE_SW";case(l<=10&&i):return"RESIZE_W";case(h<=10&&c<=10&&i):return"RESIZE_NE";case(h<=10&&u<=10&&i):return"RESIZE_SE";case(h<=10&&i):return"RESIZE_E";case(c<=10&&i):return"RESIZE_N";case(u<=10&&i):return"RESIZE_S";case c<=10+t:return"MOVE";default:return""}}class Le extends be{static GetPopUps(){return xe}static IsSomePopUpVisible(){return xe.some(e=>e.isVisible)}static GetPopUp(e){return xe.find(t=>t.id===e)}static Contains(e){return xe.some(t=>t.element.contains(e))}static HideAllPopUps(e=!0){xe.forEach(t=>{(e&&t.isModal||!e)&&t._closeOnClickOut&&t.hide()})}static HideTopPopUp(){if(xe.length){let e=null;if(xe.slice().reverse().some(t=>(t.isVisible&&(e=t),e!==null)),e&&e._closeOnClickOut)return e.hide(),!0}return!1}static Unload(){xe.forEach(e=>{e.removeFromParent()}),xe.slice(0)}static HideNonAncestors(e){xe.forEach(t=>{e.isParent&&!e.isParent(t)&&t._closeOnClickOut&&t.hide()})}constructor(e,t,i=null,s=null,r=!0,a=!1,o=!1,l=""){const c={class:`${r?"popup-container":"popup-container no-modal"} ${l}`};a=a||o;const h=e.getCustomPluginIcon("paella-core","dock-popup")||Hn,u=e.getCustomPluginIcon("paella-core","close-popup")||_t,d=`
		<div class="popup-content${o?" resizeable":""}${a?" moveable":" fixed"}">
			<div class="border-top-left"></div><div class="border-top-center"></div><div class="border-top-right"></div>
			<div class="title-bar">
				<div class="title-bar-content"></div>
				<div class="popup-action-buttons">
					<button class="popup-action-button dock-button"><i>${h}</i></button>
					<button class="popup-action-button close-button"><i>${u}</i></button>
				</div>
			</div>
			<div class="center-container"></div>
			<div class="border-bottom-left"></div><div class="border-bottom-center"></div><div class="border-bottom-right"></div>
		</div>
		`;super(e,{attributes:c,children:d,parent:t}),this._lastFocusElement=document.activeElement,this._modal=r,this._contextObject=s,this._dragActionData=null,this._moveable=a||o,this._resizeable=o,this._id=Symbol(this),xe.push(this),this.element.getElementsByClassName("dock-button")[0].addEventListener("click",m=>{this.dock()});const f=this.element.getElementsByClassName("close-button")[0];f.addEventListener("click",()=>this.hide()),f.addEventListener("mousedown",m=>m.stopPropagation()),this._closeButton=f,this.element.addEventListener("click",()=>{this._closeOnClickOut&&this.hide()}),this._contentElement=this.element.getElementsByClassName("popup-content")[0],this._centerContainer=this.element.getElementsByClassName("center-container")[0],this._titleBar=this.element.getElementsByClassName("title-bar")[0],this._centerContainer.addEventListener("mousedown",m=>{m.stopPropagation()}),this._contentElement.addEventListener("mousedown",m=>{if(this.moveable||this.resizeable){this._element.style.pointerEvents="all",this._moved=!0;const p=this._contentElement.getBoundingClientRect();this._contentElement.classList.add("static-position"),this._contentElement.style.top=p.top+"px",this._contentElement.style.left=p.left+"px",this._contentElement.style.width=p.width+"px",this._contentElement.style.height=p.height+"px",this._contentElement.style.maxHeight="unset";const E=this._titleBar.getBoundingClientRect().height;this._centerContainer.style.height=`calc(100% - var(--popup-resizeable-border) * 2 - ${E}px)`;const T={left:m.clientX,top:m.clientY};this._dragActionData={popUp:this,action:$l(p,T,E,this._resizeable),event:m,initialPosition:T}}m.stopPropagation()}),this.element.addEventListener("mouseup",m=>{this._element.style.pointerEvents="",(this.moveable||this.resizeable)&&(this._dragActionData=null)}),this.element.addEventListener("mousemove",m=>{if(this._dragActionData){const p={left:m.clientX-this._dragActionData.initialPosition.left,top:m.clientY-this._dragActionData.initialPosition.top};this._dragActionData.initialPosition={left:m.clientX,top:m.clientY};const v=this._contentElement.getBoundingClientRect();this._dragActionData.action==="MOVE"?(this._contentElement.style.top=`${v.top+p.top}px`,this._contentElement.style.left=`${v.left+p.left}px`,this._contentElement.style.height=`${v.height}px`,this._contentElement.style.width=`${v.width}px`):this._dragActionData.action==="RESIZE_N"?(this._contentElement.style.height=`${v.height-p.top}px`,this._contentElement.style.top=`${v.top+p.top}px`):this._dragActionData.action==="RESIZE_NE"?(this._contentElement.style.height=`${v.height-p.top}px`,this._contentElement.style.top=`${v.top+p.top}px`,this._contentElement.style.width=`${v.width+p.left}px`,this._contentElement.style.left=`${v.left}px`):this._dragActionData.action==="RESIZE_E"?(this._contentElement.style.width=`${v.width+p.left}px`,this._contentElement.style.left=`${v.left}px`):this._dragActionData.action==="RESIZE_SE"?(this._contentElement.style.top=`${v.top}px`,this._contentElement.style.left=`${v.left}px`,this._contentElement.style.width=`${v.width+p.left}px`,this._contentElement.style.height=`${v.height+p.top}px`):this._dragActionData.action==="RESIZE_S"?(this._contentElement.style.top=`${v.top}px`,this._contentElement.style.height=`${v.height+p.top}px`):this._dragActionData.action==="RESIZE_SW"?(this._contentElement.style.top=`${v.top}px`,this._contentElement.style.height=`${v.height+p.top}px`,this._contentElement.style.width=`${v.width-p.left}px`,this._contentElement.style.left=`${v.left+p.left}px`):this._dragActionData.action==="RESIZE_NW"?(this._contentElement.style.width=`${v.width-p.left}px`,this._contentElement.style.left=`${v.left+p.left}px`,this._contentElement.style.height=`${v.height-p.top}px`,this._contentElement.style.top=`${v.top+p.top}px`):this._dragActionData.action==="RESIZE_W"&&(this._contentElement.style.width=`${v.width-p.left}px`,this._contentElement.style.left=`${v.left+p.left}px`)}}),this._contentElement.addEventListener("mouseup",m=>{this._dragActionData=null,this._element.style.pointerEvents="",m.stopPropagation()}),this._contentElement.addEventListener("click",m=>{m.stopPropagation()}),this._anchorElement=i,i&&Kn(e,i,this.contentElement),this._parentPopUp=null,this.hide()}dock(){this._moved=!1,this._centerContainer.style.height="",this.hide(),this.show()}get lastFocusElement(){return this._lastFocusElement}get isModal(){return this._modal}get contextObject(){return this._contextObject}get id(){return this._id}get contentElement(){return this._contentElement}get centerContainer(){return this._centerContainer}get content(){return this._popupContent}get parentPopUp(){return this._parentPopUp}get moveable(){return this._moveable}get resizeable(){return this._resizeable}get titleBar(){return this._titleBar}set title(e){this._title=e,this._titleBar.classList.remove("not-empty");const t=this._titleBar.getElementsByClassName("title-bar-content")[0];e!==null&&e instanceof Element?(t.innerHTML="",t.appendChild(e),this._titleBar.classList.add("not-empty")):e!==null&&(t.innerHTML="",t.innerHTML=this.player.translate(e),this._titleBar.classList.add("not-empty"))}get title(){return this._title}setCloseActions({clickOutside:e=!0,closeButton:t=!1}){this._closeOnClickOut=e,this._closeOnButton=t,this._closeOnButton?this._closeButton.style.display="block":this._closeButton.style.display="none"}isParent(e){return e===this?!0:this.parentPopUp===null?!1:this.parentPopUp===e?!0:this.parentPopUp.isParent(e)}setContent(e){this.centerContainer.innerHTML="",typeof e=="string"?this._popupContent=j(e,this.centerContainer):(this._popupContent=e,this.centerContainer.appendChild(e))}show(e=null,t=null){this._anchorElement&&!this._moved&&Kn(this.player,this._anchorElement,this.contentElement),e&&this.setParent(e),this._parentPopUp=t,t&&t.addChild(this),super.show(),Le.HideNonAncestors(this),this._closeOnClickOut&&Ul(this.player),X(this.player,F.SHOW_POPUP,{popUp:this,plugin:this.contextObject})}hide(){this.isVisible&&(this._children&&this._children.forEach(e=>{e._closeOnClickOut&&e.hide()}),this._parentPopUp&&this._parentPopUp.removeChild(this),X(this.player,F.HIDE_POPUP,{popUp:this,plugin:this.contextObject}),this._anchorElement&&this._anchorElement.setAttribute("aria-pressed",!1),super.hide(),this.lastFocusElement&&this.lastFocusElement.focus()),xe.some(e=>e.isVisible&&e._closeOnClickOut)||Bl(this.player)}addChild(e){this._children=this._children||[],this._children.find(t=>t===e)||this._children.push(e)}removeChild(e){this._children&&(this._children=this._children.filter(t=>t!==e))}destroy(){const e=xe.indexOf(this);e!==-1&&(xe.splice(e,1),this.removeFromParent())}}function Wn(n){return new Promise((e,t)=>{fetch(n).then(i=>i.text()).then(i=>{e(i)}).catch(i=>t(i))})}function Yn(n){const e=new URLSearchParams(window.location.search);return e.has(n)?e.get(n):null}function zn(n){const e=window.location.hash.replace("#","?"),t=new URLSearchParams(e);return t.has(n)?t.get(n):null}function We(n,e){const t=e||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+t),"")),s!==n.length-1&&(i=i.replace(new RegExp(t+"$"),"")),i)),n.join(t)}function jn(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function ei(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function qn(n){return n.split(".").reduce((e,t,i,s)=>i<s.length-1?e!==""?`${e}.${t}`:t:e,"")}function Yi(n){const e=t=>{const i=t.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(t[0]==="/"?`/${i}`:i)+"/"};try{const t=new URL(n);return t.origin+e(t.pathname)}catch{return e(n)}}function zi(n){return ei(n).split(".").pop()}function et(n,e){return jn(e)?e:We([n.manifestUrl,e])}function Xn(n){n.__hideTimerPaused__=!0}function Qn(n){n.__hideTimerPaused__=!1}function Zn(n,e="hideUiTime"){var r;n.__hideTimer__=null;const t=async()=>Le.IsSomePopUpVisible()?(n.log.debug("UI not hidden because there are visible pop ups"),!1):n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):i()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(r=n.config.ui)!=null&&r.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{t()});const i=()=>{const a=document.activeElement;return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(o=>a.tagName.toLowerCase(o))!==-1},s=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,t()||s()},n[e])};n.containerElement.addEventListener("mousemove",async a=>{s()}),ie(n,F.PLAY,async()=>{s()}),ie(n,F.PAUSE,async()=>{await n.showUserInterface()}),ie(n,F.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{s()})}function Jn(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function ji(n){const e=Math.floor(n/60/60),t=Math.floor(n/60)-e*60,i=Math.floor(n%60);return(e>0?e.toString().padStart(2,"0")+":":"")+t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function ti(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const i=t[1]!==void 0?Number(t[1]):0,s=Number(t[2]),r=Number(t[3]);return i*3600+s*60+r}return null}function qi(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const i=t[1]!==void 0?Number(t[1]):0,s=Number(t[2]),r=Number(t[3]),a=t[4]&&Number(t[4])||0;return i*36e5+s*6e4+r*1e3+a}return null}function dt(n,e,t=365){let i=new Date;i.setTime(i.getTime()+t*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${e};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function er(n,e,t,i,s=365){n.cookieConsent.getConsentForType(e)&&dt(t,i,s)}function tt(n){let e=n+"=",i=decodeURIComponent(document.cookie).split(";");for(let s=0;s<i.length;++s){let r=i[s];for(;r.charAt(0)==" ";)r=r.substring(1);if(r.indexOf(e)==0)return r.substring(e.length,r.length)}return""}function Gl(n){const e=tt(n),t=Number(e);return e!==""&&!isNaN(t)?t:null}function Vl(n){try{return JSON.parse(tt(n))}catch{return null}}function Xi(n,e=!0){return new Promise(t=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>t(i);const s=document.getElementsByTagName("head")[0];e&&s.appendChild(i),t()})}function tr(n){document.getElementsByTagName("head")[0].removeChild(n)}function Gt(n,e,t=!0){for(const i in e){const s=n[i];let r=e[i];t&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Gt(a,o,t),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Gt(s,r,t):n[i]=e[i]}}const Hl=Object.freeze(Object.defineProperty({__proto__:null,clearAutoHideTimer:Jn,getCookie:tt,getFileExtension:zi,getHashParameter:zn,getJSONCookie:Vl,getNumericCookie:Gl,getUrlFileName:ei,getUrlParameter:Yn,isAbsoluteUrl:jn,joinPath:We,loadStyle:Xi,loadSvgIcon:Wn,mergeObjects:Gt,pauseAutoHideUiTimer:Xn,removeExtension:qn,removeFileName:Yi,resolveResourcePath:et,resumeAutoHideUiTimer:Qn,secondsToTime:ji,setCookie:dt,setCookieIfAllowed:er,setupAutoHideUiTimer:Zn,timeToMilliseconds:qi,timeToSeconds:ti,unloadStyle:tr},Symbol.toStringTag,{value:"Module"}));async function ir(n,e){return e.log.debug("Using default configuration loading function."),(await fetch(n)).json()}async function sr(n,e){return e.log.debug("Using default getVideoId function"),zn("id")||Yn("id")||n.fallbackId}async function nr(n,e,t,i){return i.log.debug("Using default getManifestUrl function"),We([n,e])}async function rr(n,e,t,i){return i.log.debug("Using default getManifestFileUrl function"),We([n,e])}async function ar(n,e,t){t.log.debug("Using default loadVideoManifest function");const i=await fetch(n);if(i.ok)return await i.json();throw new Error(t.translate("Error loading video manifest: $1 $2",[i.status,i.statusText]))}const Kl=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1,0,0,1,3,-3.88857)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear1);"/>
    </g>
    <g transform="matrix(-1,1.22465e-16,-1.22465e-16,-1,258,251.914)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear2);"/>
    </g>
    <defs>
        <linearGradient id="_Linear1" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
        <linearGradient id="_Linear2" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
    </defs>
</svg>
`;class or extends be{constructor(e){super(e,{parent:e.containerElement}),this.element.className="loader-container"}async create(){j(`<i>${Kl}</i>`,this.element)}get debug(){return!1}}const Wl=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g id="Cancel" transform="matrix(5.54545,6.8353e-32,6.8353e-32,5.54545,-2567.37,-10735.5)">
        <path d="M486.05,1937C498.192,1937 508.05,1946.86 508.05,1959C508.05,1971.14 498.192,1981 486.05,1981C473.908,1981 464.05,1971.14 464.05,1959C464.05,1946.86 473.908,1937 486.05,1937ZM478.979,1950.52L477.565,1951.93L484.636,1959L477.565,1966.07L478.979,1967.49L486.05,1960.41L493.121,1967.49L494.535,1966.07L487.464,1959L494.535,1951.93L493.121,1950.52L486.05,1957.59L478.979,1950.52Z" style="fill:rgb(210,0,0);"/>
    </g>
</svg>
`;class Qi extends be{constructor(e,t=""){super(e,{parent:e.containerElement}),this.element.className="error-container",j(`
            <div>
                <i>${Wl}</i>
                <p>${t}</p>
            </div>`,this.element)}}class Ye extends ut{constructor(e,t){super(e),this._name=t}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var e;return((e=this._config)==null?void 0:e.order)||0}get description(){var e;return((e=this._config)==null?void 0:e.description)||""}get name(){return this._name}async isEnabled(){var e;return(e=this.config)==null?void 0:e.enabled}async load(){}async unload(){}}class ft extends Ye{get type(){return"video"}get streamType(){return"mp4"}async isCompatible(){return!1}async getVideoInstance(){return null}getCompatibleFileExtensions(){return[]}getManifestData(e){}}const ii=[];async function Yl(n){await Ae(n,"video",e=>{ii.push(e)})}async function zl(n){ii.slice(0)}function lr(n){if(ii.length===0)throw Error("No video plugins loaded. Note that `loadVideoPlugins()` must to be called before using `getVideoPlugins()`.");return ii}function jl(n,e){const t=zi(e);return lr().find(s=>s.getCompatibleFileExtensions().indexOf(t)!==-1)}async function ql(n,e){const t=lr();let i=null;for(const s of t)if(await s.isCompatible(e)){i=s;break}return i}async function cr(){return await new Promise(e=>{const t=document.createElement("audio"),i=setTimeout(()=>e(!1),100);t.addEventListener("volumechange",s=>{clearTimeout(i),e(!0)}),t.volume=.5})}class si extends be{constructor(e,t,i){const s={class:"video-player"};super(t,{tag:e,attributes:s,parent:i}),this._streamProvider=null,this._streamData=null,this._ready=!1}async isVolumeApiAvailable(){return await cr()}get streamData(){return this._streamData}get ready(){return this._ready}async load(e,t){return this._streamProvider=t,this._streamData=e,await this.loadStreamData(e)}get isMainAudioPlayer(){return this._streamProvider.mainAudioPlayer===this}onVideoEnded(e){this._videoEndedCallback=e}async play(){return!1}async pause(){return!1}async duration(){return-1}get currentTimeSync(){return-1}async currentTime(){return-1}async setCurrentTime(){return!1}async volume(){return-1}async setVolume(){return!1}initVolume(e){this._initialVolume=e}async paused(){return!0}async playbackRate(){return-1}async setPlaybackRate(){return!1}async getQualities(){return null}async setQuality(){return!1}get currentQuality(){return null}async getDimensions(){return null}async supportsMultiaudio(){return!1}async getAudioTracks(){return null}async setCurrentAudioTrack(){}get currentAudioTrack(){return null}async loadStreamData(e){return!1}get isEnabled(){return this._enabled}async enable(){this._enabled=!0}async disable(){this._enabled=!1}}class Vt extends ut{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}}const Ht={name:"paella-core",exports:{".":"./src/js/index.js","./*":"./src/js/*","./paella-core.css":"./dist/paella-core.css"},version:"2.0.0",description:"Multistream HTML video player",main:"dist/paella-core.js",files:["dist/paella-core.css","dist/paella-core.js"],module:"dist/paella-core.js",type:"module",scripts:{dev:"vite",build:"vite build --emptyOutDir"},repository:{type:"git",url:"git+https://github.com/polimediaupv/paella-player.git"},keywords:["html","player","video","hls"],author:"Fernando Serrano Carpena <ferserc1@gmail.com>",license:"ECL-2.0",bugs:{url:"https://github.com/polimediaupv/paella-player/issues"},homepage:"https://github.com/polimediaupv/paella-player#readme",devDependencies:{vite:"^5.0.8"},dependencies:{"@ferserc1/input-style-unifier":"^0.0.1","hls.js":"^1.0.4"}};let Zi=null;class it extends Vt{static Get(){return Zi||(Zi=new it),Zi}get moduleName(){return"paella-core default video formats"}get moduleVersion(){return Ht.version}}function Xl(n){return new Promise((e,t)=>{const i=new Image;i.addEventListener("load",s=>{e(i)}),i.addEventListener("error",s=>{t(new Error("Could not load preview image. The preview image is required in audio only streams"))}),i.src=n})}function Ql(n,e,t){return new Promise((i,s)=>{e.oncanplay=()=>i(),e.onerror=()=>s(new Error(n.translate("Error loading audio: $1",[t]))),e.src=et(n,t),i()})}class hr extends si{constructor(e,t,i){super("audio",e,t),this.isMainAudio=i,this._ready=!1}get streamType(){return"audio"}waitForLoaded(){return new Promise(e=>{const t=()=>{this._ready?e():setTimeout(t,100)};t()})}async play(){await this.waitForLoaded(),this.audio.play()}async pause(){await this.waitForLoaded(),this.audio.pause()}async duration(){return await this.waitForLoaded(),this.audio.duration}get currentTimeSync(){var e;return((e=this.audio)==null?void 0:e.currentTime)||0}async currentTime(){return await this.waitForLoaded(),this.audio.currentTime}async setCurrentTime(e){await this.waitForLoaded(),this.audio.currentTime=e}async volume(){return await this.waitForLoaded(),this.audio.volume}async setVolume(e){await this.waitForLoaded(),this.audio.volume=e}async paused(){return await this.waitForLoaded(),this.audio.paused}async playbackRate(){return await this.waitForLoaded(),this.audio.playbackRate}async setPlaybackRate(e){await this.waitForLoaded(),this.audio.playbackRate=e}async getDimensions(){return{w:this._previewImage.width,h:this._previewImage.height}}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.audioVideoFormat: loadStreamData");const t=this.player.videoManifest.metadata.preview;if(!t||t==null)throw new Error("Invalid video manifest data: preview image is required");if(this._previewImage=await Xl(t),this._imageContainer=document.createElement("div"),this._imageContainer.className="image-container",this.parent.appendChild(this._imageContainer),this._imageContainer.appendChild(this._previewImage),this._source=e.sources.audio&&e.sources.audio[0],!this._source)throw new Error("Invalid source in audio only video stream");if(!this.isMainAudioPlayer)throw new Error("Audio only video stream must be main audio player. Check the role property at video manifest");await Ql(this.player,this.audio,this._source.src);const i=()=>{const s=this.player.videoContainer.baseVideoRect.offsetWidth/this.player.videoContainer.baseVideoRect.offsetHeight,r=this._previewImage.width/this._previewImage.height;s>r?(this._previewImage.classList.add("landscape"),this._previewImage.classList.remove("portrait")):(this._previewImage.classList.add("portrait"),this._previewImage.classList.remove("landscape"))};this.player.frameList.frames.length>0&&this.audio.addEventListener("timeupdate",s=>{const r=this.player.frameList.getImage(s.target.currentTime,!0);this._previewImage.src!=r.url&&(this._previewImage.src=r.url,this._previewImage.onload=()=>i())}),window.addEventListener("resize",s=>i()),i(),this._ready=!0}}class ur extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.audioVideoFormat"}get streamType(){return"audio"}async isCompatible(e){return e.sources.audio!=null}async getVideoInstance(e,t){return new hr(this.player,e,t)}getCompatibleFileExtensions(){return["m4a","mp3"]}getManifestData(e){return{audio:e.map(t=>({src:t}))}}}let ni=null;function dr(n){if(!n)return!1;ni||(ni=document.createElement("video"));let e=ni.canPlayType(n);if(e==="maybe"||e==="probably")return!0;if(/video\/mp4/i.test(n))return e=ni.canPlayType("video/mp4"),e==="maybe"||e==="probably"}class ri extends si{constructor(e,t,i,s){super("video",e,t),this._config=s||{};const r=this._config.crossOrigin??"";this.element.setAttribute("playsinline","true"),r!==!1&&this.element.setAttribute("crossorigin",r),this.isMainAudio=i,this.element.setAttribute("autoplay","true"),this.element.autoplay=!0,i||(this.element.muted=!0),this._videoEnabled=!0}async play(){if(this._videoEnabled)return await this.waitForLoaded(),this.video.play();this._disabledProperties.paused=!1}async pause(){if(this._videoEnabled)return await this.waitForLoaded(),this.video.pause();this._disabledProperties.paused=!0}async duration(){return this._videoEnabled?(await this.waitForLoaded(),this.video.duration):this._disabledProperties.duration}get currentTimeSync(){return this._videoEnabled?this.ready?this.video.currentTime:-1:this._disabledProperties.currentTime}async currentTime(){return this._videoEnabled?(await this.waitForLoaded(),this.currentTimeSync):this._disabledProperties.currentTime}async setCurrentTime(e){return this._videoEnabled?(await this.waitForLoaded(),this.video.currentTime=e):(this._disabledProperties.currentTime=e,e)}async volume(){return this._videoEnabled?(await this.waitForLoaded(),this.video.volume):this._disabledProperties.volume}async setVolume(e){return this._videoEnabled?(await this.waitForLoaded(),e===0?this.video.setAttribute("muted",!0):this.video.removeAttribute("muted"),this.video.volume=e):(this._disabledProperties.volume=e,e)}async paused(){return this._videoEnabled?(await this.waitForLoaded(),this.video.paused):this._disabledProperties.paused}async playbackRate(){return this._videoEnabled?(await this.waitForLoaded(),await this.video.playbackRate):this._disabledProperties.playbackRate}async setPlaybackRate(e){return this._videoEnabled?(await this.waitForLoaded(),this.video.playbackRate=e):(this._disabledProperties.playbackRate=e,e)}async getQualities(){}async setQuality(){}get currentQuality(){return 0}async getDimensions(){return this._videoEnabled?(await this.waitForLoaded(),{w:this.video.videoWidth,h:this.video.videoHeight}):{w:this._disabledProperties.videoWidth,h:this._disabledProperties.videoHeight}}saveDisabledProperties(e){this._disabledProperties={duration:e.duration,volume:e.volume,videoWidth:e.videoWidth,videoHeight:e.videoHeight,playbackRate:e.playbackRate,paused:e.paused,currentTime:e.currentTime}}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.mp4VideoFormat: loadStreamData"),this._sources=null,this._currentQuality=0,this._sources=e.sources.mp4,this._sources.sort((t,i)=>Number(t.res.w)-Number(i.res.w)),this._currentQuality=this._sources.length-1,this._currentSource=this._sources[this._currentQuality],this.isMainAudioPlayer||(this.video.muted=!0),this._initialVolume&&(this.video.volume=this._initialVolume,this._initialVolume===0&&(this.video.muted=!0)),this.video.src=et(this.player,this._currentSource.src),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback),await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.mp4VideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}async clearStreamData(){this.video.src="",this.video.removeEventListener("ended",this._endedCallback),this._ready=!1}get isEnabled(){return this._videoEnabled}async enable(){this._videoEnabled=!0}async disable(){return this.isMainAudio?this.player.log.debug("video.disable() - the video is not disabled because it is the main audio source."):this._videoEnabled=!1,this._videoEnabled}waitForLoaded(){return new Promise((e,t)=>{if(this.ready)e();else{const i=()=>{this._waitTimer&&clearTimeout(this._waitTimer),this._waitTimer=null,this.video.error?t(new Error(this.player.translate("Error loading video: $1. Code: $2 $3",[this.video.src,this.video.error,this.video.error.message]))):this.video.readyState>=2?(this.video.pause(),this._ready=!0,e()):this._waitTimer=setTimeout(()=>i(),100)};i()}})}}class fr extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.mp4VideoFormat"}get streamType(){return"mp4"}async isCompatible(e){var i;const{mp4:t}=e.sources;return t&&dr((i=t[0])==null?void 0:i.mimetype)}async getVideoInstance(e,t){return new ri(this.player,e,t,this.config)}getCompatibleFileExtensions(){return["m4v","mp4"]}getManifestData(e){return{mp4:e.map(t=>({src:t,mimetype:"video/mp4"}))}}}class gt{constructor({label:e,shortLabel:t,isAuto:i=!1,index:s=0,src:r="",width:a=-1,height:o=-1,bitrate:l=-1}){this._label=e,this._shortLabel=t,this._index=s,this._src=r,this._res={w:a,h:o},this._bitrate=l,this._isAuto=i}get label(){return this._label}get shortLabel(){return this._shortLabel}get index(){return this._index}get src(){return this._src}get res(){return this._res}get bitrate(){return this._bitrate}get isAuto(){return this._isAuto}get quality(){return this._res.w!==-1&&this._res.h!==-1?this._res.w*this._res.h:this._bitrate}compare(e){return e.quality-this.quality}}class Ji{constructor({id:e,name:t,groupId:i="",language:s="",selected:r=!1}){this._id=e,this._name=t,this._groupId=i,this._lang=s,this._selected=r}get id(){return this._id}get name(){return this._name}get groupId(){return this._groupId}get language(){return this._lang}get selected(){return this._selected}set selected(e){this._selected=e}}const es={autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!0,debug:!1,defaultAudioCodec:void 0,initialLiveManifestSize:1,maxBufferLength:6,maxMaxBufferLength:6,maxBufferSize:600*1e3*1e3,maxBufferHole:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:500,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:500,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:500,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,appendErrorMaxRetry:3,enableWebVTT:!0,enableCEA708Captions:!0,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:5,abrEwmaSlowLive:9,abrEwmaFastVoD:4,abrEwmaSlowVoD:15,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,minAutoBitrate:0},gr={withCredentials:!0,requestHeaders:{"Access-Control-Allow-Headers":"Content-Type, Accept, X-Requested-With","Access-Control-Allow-Origin":"http://localhost:8000","Access-Control-Allow-Credentials":"true"}},ve={UNSUPPORTED:0,MEDIA_SOURCE_EXTENSIONS:1,NATIVE:2};let ts=null;async function is(){return ts||(console.debug("Loading HLS.js"),ts=(await Promise.resolve().then(()=>Mg)).default),ts}async function ke(n=!1){const e=await is(),t=document.createElement("video");return t.canPlayType("application/vnd.apple.mpegurl")&&n?ve.NATIVE:e.isSupported()?ve.MEDIA_SOURCE_EXTENSIONS:t.canPlayType("application/vnd.apple.mpegurl")?ve.NATIVE:ve.UNSUPPORTED}const Zl=async(n,e,t,i,s)=>{var l,c;const r=await is();s.withCredentials&&(i.xhrSetup=function(h,u){h.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];h.setRequestHeader(d,g)}}),i.autoStartLoad=!0;const a=new r(i),o=((c=(l=e==null?void 0:e.sources)==null?void 0:l.hls)==null?void 0:c.length)>0&&e.sources.hls[0];return[a,new Promise((h,u)=>{let d=!1;a.on(r.Events.LEVEL_SWITCHED,(p,v)=>{n.log.debug(`HLS: quality level switched to ${v.level}`),d||(a.currentLevel=-1,d=!0),X(n,F.VIDEO_QUALITY_CHANGED,{})}),a.on(r.Events.ERROR,(p,v)=>{if(v.fatal)switch(v.type){case r.ErrorTypes.NETWORK_ERROR:v.details===r.ErrorDetails.MANIFEST_LOAD_ERROR?u(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),a.startLoad());break;case r.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),a.recoverMediaError();break;default:a.destroy(),u(Error("hlsVideoFormat: Fatal error. Can not recover"))}else n.log.warn("HLS: error"),n.log.warn(v.details)}),a.on(r.Events.LEVEL_SWITCHING,()=>{n.log.debug("HLS media attached")}),a.on(r.Events.MEDIA_ATTACHED,()=>{n.log.debug("HLS media attached")}),a.on(r.Events.MEDIA_DETACHING,()=>{n.log.debug("HLS media detaching")}),a.on(r.Events.MEDIA_DETACHED,()=>{n.log.debug("HLS media detached")}),a.on(r.Events.MANIFEST_PARSED,()=>{n.log.debug("HLS manifest parsed"),a.startLoad(-1)});const g=Math.floor(Math.random()*1e11),f=o.src+(i.enableCache?/\?/.test(o.src)?`&cache=${g}`:`?cache=${g}`:"");a.loadSource(f),a.attachMedia(t);let m=!1;a._videoEventListener=()=>{m=!0,h()},t.addEventListener("canplay",a._videoEventListener),setTimeout(()=>{m||t.play()},1e3)})]};class ss extends ri{constructor(e,t,i,s){super(e,t,s,i),this._config=this._config||{audioTrackLabel:i.audioTrackLabel||"name",enableCache:i.enableCache||!1};for(const r in es)this._config[r]=es[r];for(const r in i.hlsConfig)this._config[r]=i.hlsConfig[r];this._cors={};for(const r in gr)this._cors[r]=gr[r];for(const r in i.corsConfig)this._cors[r]=i.corsConfig[r];this._ready=!1,this._autoQuality=!0,this._forceNative=i.forceNative||!1}get autoQuality(){return this._autoQuality}get forceNative(){return this._forceNative}async loadStreamData(e){var i,s;if(await ke(this.forceNative)===ve.NATIVE){e.sources.mp4=e.sources.hls;const r=await super.loadStreamData(e),a=await this.getAudioTracks();return this._currentAudioTrack=a.find(o=>o.selected),this._autoQuality=new gt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality,this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback),r}else{this.player.log.debug("Loading HLS stream");const r=((s=(i=e==null?void 0:e.sources)==null?void 0:i.hls)==null?void 0:s.length)&&e.sources.hls[0];this._config.audioTrackLabel=(r==null?void 0:r.audioLabel)||this._config.audioTrackLabel;const[a,o]=await Zl(this.player,e,this.video,this._config,this._cors);this._hls=a,await o,this.video.pause(),this._autoQuality=new gt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const l=await this.getAudioTracks();this._currentAudioTrack=l.find(c=>c.selected),this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback)}}async duration(){var e;if(this._videoEnabled){await this.waitForLoaded();let t=this.video.duration;return t===1/0&&(t=((e=this._hls)==null?void 0:e.liveSyncPosition)||0),t}else return this._disabledProperties.duration}async waitForLoaded(){if(await ke(this.forceNative)===ve.NATIVE)return super.waitForLoaded();await new Promise((t,i)=>{const s=()=>{this.video.readyState>=2?(this._ready=!0,t()):setTimeout(()=>s(),200)};s()})}async getQualities(){const e=[];return e.push(this._autoQuality),await ke(this.forceNative)===ve.MEDIA_SOURCE_EXTENSIONS&&(this._hls.levels.forEach((i,s)=>{e.push(new gt({index:s,label:`${i.width}x${i.height}`,shortLabel:`${i.height}p`,width:i.width,height:i.height}))}),e.sort((i,s)=>i.res.h-s.res.h)),e}async setQuality(e){const t=await ke(this.forceNative);if(this._videoEnabled){if(!(e instanceof gt))throw Error("Invalid parameter setting video quality. VideoQualityItem object expected.");t===ve.MEDIA_SOURCE_EXTENSIONS?(this._currentQuality=e,this._hls.currentLevel=e.index):this.player.log.warn("Could not set video quality of HLS stream, because the HLS support of this browser is native.")}}get currentQuality(){return this._currentQuality}async supportsMultiaudio(){var t;await this.waitForLoaded();const e=await ke(this.forceNative);return e===ve.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.length>1:e===ve.NATIVE?((t=this.video.audioTracks)==null?void 0:t.length)>1:!1}async getAudioTracks(){await this.waitForLoaded();const e=this._config.audioTrackLabel||"name",t=await ke(this.forceNative);return t===ve.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.map(s=>new Ji({id:s.id,name:s[e],language:s.lang,selected:this._hls.audioTrack===s.id})):t===ve.NATIVE?Array.from(this.video.audioTracks).map(s=>new Ji({id:s.id,name:s.label,language:s.language,selected:s.enabled})):null}async setCurrentAudioTrack(e){await this.waitForLoaded();const i=(await this.getAudioTracks()).find(r=>r.id===e.id),s=await ke(this.forceNative);return s===ve.MEDIA_SOURCE_EXTENSIONS&&i?this._hls.audioTrack=i.id:s===ve.NATIVE&&i&&Array.from(this.video.audioTracks).forEach(r=>{r.id===i.id?r.enabled=!0:r.enabled=!1}),this._currentAudioTrack=i,i}get currentAudioTrack(){return this._currentAudioTrack}async clearStreamData(){this.video.removeEventListener("canplay",this._hls._videoEventListener),this.video.src="",this._hls.destroy(),this._ready=!1}}class mr extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.hlsVideoFormat"}get streamType(){return"hls"}async isCompatible(e){const{hls:t}=e.sources;return t&&await ke()}async getVideoInstance(e,t){return new ss(this.player,e,this.config,t)}getCompatibleFileExtensions(){return["m3u8"]}getManifestData(e){return{hls:e.map(t=>({src:t,mimetype:"video/mp4"}))}}}const Jl=async(n,e,t,i,s)=>{var l,c;const r=await is();s.withCredentials&&(i.xhrSetup=function(h,u){h.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];h.setRequestHeader(d,g)}});const a=new r(i),o=((c=(l=e==null?void 0:e.sources)==null?void 0:l.hlsLive)==null?void 0:c.length)>0&&e.sources.hlsLive[0];return i.initialQualityLevel!==void 0&&i.initialQualityLevel,[a,new Promise((h,u)=>{let d=!1;a.on(r.Events.LEVEL_SWITCHED,(m,p)=>{(void 0).player.log.debug(`HLS: quality level switched to ${p.level}`),d||(a.currentLevel=-1,d=!0),X(n,F.VIDEO_QUALITY_CHANGED,{})}),a.on(r.Events.ERROR,(m,p)=>{if(p.fatal)switch(p.type){case r.ErrorTypes.NETWORK_ERROR:p.details===r.ErrorDetails.MANIFEST_LOAD_ERROR?u(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),a.startLoad());break;case r.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),a.recoverMediaError();break;default:a.destroy(),u(Error("hlsVideoFormat: Fatal error. Can not recover"))}}),a.on(r.Events.MANIFEST_PARSED,()=>{i.autoStartLoad||a.autoStartLoad()});const g=Math.floor(Math.random()*1e11),f=o.src+(i.enableCache?/\?/.test(o.src)?`&cache=${g}`:`?cache=${g}`:"");a.loadSource(f),a.attachMedia(t),a._videoEventListener=()=>{h()},t.addEventListener("canplay",a._videoEventListener)})]};class ec extends ss{async loadStreamData(e){if(await ke()===ve.NATIVE)return e.sources.hls=e.sources.hlsLive,super.loadStreamData(e);{this.player.log.debug("Loading HLS stream");const[i,s]=await Jl(this.player,e,this.video,this._config,this._cors);this._hls=i,await s,this._autoQuality=new gt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const r=await this.getAudioTracks();this._currentAudioTrack=r.find(a=>a.selected),this.saveDisabledProperties(this.video)}}}class tc extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.hlsLiveVideoFormat"}get streamType(){return"hlsLive"}async isCompatible(e){const t=await ke(),{hlsLive:i}=e.sources;return i&&t}async getVideoInstance(e,t){return new ec(this.player,e,this.config,t)}}class ic extends ri{constructor(e,t,i){super(e,t,i)}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.htmlVideoFormat: loadStreamData"),this._sources=e.sources.html,this._currentQuality=0,this.isMainAudioPlayer||(this.video.muted=!0),this._sources.forEach(({src:t,mimetype:i})=>{t=et(this.player,t);const s=document.createElement("source");s.src=t,s.type=i,this.video.appendChild(s)}),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback),await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.htmlVideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}}class sc extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.htmlVideoFormat"}get streamType(){return"html"}async isCompatible(e){const{html:t}=e.sources;return t&&t.some(i=>dr(i.mimetype))}async getVideoInstance(e,t){return new ic(this.player,e,t)}getCompatibleFileExtensions(){return["m4v","mp4","ogg","webm","ogv"]}getManifestData(e){const t=i=>{switch(zi(i)){case"mp4":case"m4v":return"video/mp4";case"webm":return"video/webm";case"ogg":case"ogv":return"video/ogg";default:return null}};return{html:e.map(i=>({src:i,mimetype:t(i)}))}}}function pr(n){let e=this._currentSource.frames[0];this._currentSource.frames.some(t=>{if(t.time<=this._currentTime)e=t;else return!0}),this.img.src=e.src}function nc(){this._startTimestamp=Date.now();const n=()=>{this._timer=setTimeout(n,250);const e=Date.now(),t=e-this._startTimestamp;this._currentTime+=t/1e3,this._startTimestamp=e,pr.apply(this,[this._currentTime])};n()}function rc(){this._timer&&(clearTimeout(this._timer),this._timer=null)}class yr extends si{constructor(e,t){super("img",e,t),this._currentTime=0,this._startTimesamp=0,this._playbackRate=1,this._timer=null,this.video=this.domElement}async play(){nc.apply(this)}async pause(){rc.apply(this)}async duration(){return this._currentSource.duration}get currentTimeSync(){return this._currentTime}async currentTime(){return this._currentTime}async setCurrentTime(e){this._currentTime=e,pr.apply(this,[e])}async volume(){return 0}async setVolume(e){}async paused(){return this._timer===null}async playbackRate(){return this._playbackRate}async setPlaybackRate(e){this._playbackRate=e}async getQualities(){return this._qualities}async setQuality(){}get currentQuality(){return this._currentQuality}async getDimensions(){return this._currentSource.res}async loadStreamData(e){return this._sources=e.sources.image,this._qualities=this._sources.map(t=>new gt({src:t.frames[0].src,label:`${t.res.w}x${t.res.h}`,shortLabel:`${t.res.h}p`,width:t.res.w,height:t.res.h})),this._currentQuality=this._qualities.length-1,this._qualities.forEach((t,i)=>{this._qualities[this._currentQuality].compare(t)>0&&(this._currentQuality=i)}),this._currentSource=this._sources[this._currentQuality],this._sources.forEach(t=>{t.frames.sort((i,s)=>i.time-s.time)}),!0}}class vr extends ft{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.imageVideoFormat"}get streamType(){return"image"}async isCompatible(e){return e.sources.image!=null}async getVideoInstance(e,t){return new yr(this.player,e,this.config,t)}}const ai=n=>{var e,t,i;return`alt:${((e=n.keyModifiers)==null?void 0:e.altKey)||!1}, ctrl:${((t=n.keyModifiers)==null?void 0:t.ctrlKey)||!1}, shift:${((i=n.keyModifiers)==null?void 0:i.shiftKey)||!1}`},ac=n=>`${n.keyCode}_${ai(n)}`,oc=n=>{n.keyModifiers=n.keyModifiers||{},n.keyModifiers.altKey=n.keyModifiers.altKey||!1,n.keyModifiers.shiftKey=n.keyModifiers.shiftKey||!1,n.keyModifiers.ctrlKey=n.keyModifiers.ctrlKey||!1},Er=n=>{const e=[];for(const t in n.__shortcuts__)n.__shortcuts__[t].forEach(s=>{s.disabled||e.push(s)});return e};async function lc(n){if(n.__shortcuts__=n.__shortcuts__||{},!window.__paella_shortcuts_player__)window.__paella_shortcuts_player__=n;else{n.log.warn("Warning: more than one paella player instance with enabled shortcut plugins."),n.log.warn("Check your code to ensure that only one instance of paella player registers keyboard shortcut plugins.");return}await Ae(n,"keyshortcut",async e=>{(await e.getKeys()).forEach(s=>{n.__shortcuts__[s.keyCode]=n.__shortcuts__[s.keyCode]||[],s.plugin=e,n.__shortcuts__[s.keyCode].push(s)});const i=await e.getDictionaries();for(const s in i){const r=i[s];n.addDictionary(s,r)}for(const s in n.__shortcuts__){const r=n.__shortcuts__[s],a={};r.length>0&&r.forEach(o=>{const l=ac(o);if(oc(o),!a[l])a[l]=o;else{n.log.warn(`Collision detected in shortcut for key code ${s}`);const c=a[l];n.log.warn("Enabled shortcut:"),n.log.warn(`plugin: ${c.plugin.name}, keyCode: ${c.keyCode}, modifiers: ${ai(c)}, description: ${c.description}`),n.log.warn("Collision shortcut (disabled):"),n.log.warn(`plugin: ${o.plugin.name}, keyCode: ${o.keyCode}, modifiers: ${ai(o)}, description: ${o.description}`),o.disabled=!0}})}}),n.__paella_key_event_listener__=async e=>{var a,o;const t=()=>document.activeElement&&document.activeElement!==document.body&&!/video/i.test(document.activeElement.tagName);if(!n.containerElement.contains(document.activeElement)&&!Le.Contains(document.activeElement)&&document.activeElement!==document.body)return;const i=document.activeElement;if(/input/i.test(i.tagName)&&/range/i.test(i.type)&&/Arrow/i.test(e.code)||(((a=n.config.accessibility)==null?void 0:a.clickWithSpacebar)!==void 0?(o=n.config.accessibility)==null?void 0:o.clickWithSpacebar:!0)&&e.code==="Space"&&t())return;const r=n.__shortcuts__[e.code];r&&await r.forEach(async l=>{var d,g,f,m,p,v;const c=!((d=l.keyModifiers)!=null&&d.altKey)||((g=l.keyModifiers)==null?void 0:g.altKey)&&e.altKey,h=!((f=l.keyModifiers)!=null&&f.ctrlKey)||((m=l.keyModifiers)==null?void 0:m.ctrlKey)&&e.ctrlKey,u=!((p=l.keyModifiers)!=null&&p.shiftKey)||((v=l.keyModifiers)==null?void 0:v.shiftKey)&&e.shiftKey;c&&h&&u&&!l.disabled?await l.action(e):c&&h&&u&&l.disabled&&(n.log.warn("Shortcut not triggered due to collision:"),n.log.warn(`plugin: ${l.plugin.name}, keyCode: ${l.keyCode}, modifiers: ${ai(l)}, description: ${l.description}`))})},window.addEventListener("keyup",n.__paella_key_event_listener__)}async function cc(n){delete n.__shortcuts__,n==window.__paella_shortcuts_player__&&(window.removeEventListener("keyup",n.__paella_key_event_listener__),delete window.__paella_key_event_listener__,delete window.__paella_shortcuts_player__)}const Te={Digit1:"Digit1",Digit2:"Digit2",Digit3:"Digit3",Digit4:"Digit4",Digit5:"Digit5",Digit6:"Digit6",Digit7:"Digit7",Digit8:"Digit8",Digit9:"Digit9",Digit0:"Digit0",KeyA:"KeyA",KeyB:"KeyB",KeyC:"KeyC",KeyD:"KeyD",KeyE:"KeyE",KeyF:"KeyF",KeyG:"KeyG",KeyH:"KeyH",KeyI:"KeyI",KeyJ:"KeyJ",KeyK:"KeyK",KeyL:"KeyL",KeyM:"KeyM",KeyN:"KeyN",KeyO:"KeyO",KeyP:"KeyP",KeyQ:"KeyQ",KeyR:"KeyR",KeyS:"KeyS",KeyT:"KeyT",KeyU:"KeyU",KeyV:"KeyV",KeyW:"KeyW",KeyX:"KeyX",KeyY:"KeyY",KeyZ:"KeyZ",Comma:"Comma",Period:"Period",Semicolon:"Semicolon",Quote:"Quote",BracketLeft:"BracketLeft",BracketRight:"BracketRight",Backquote:"Backquote",Backslash:"Backslash",Minus:"Minus",Equal:"Equal",AltLeft:"AltLeft",AltRight:"AltRight",CapsLock:"CapsLock",ControlLeft:"ControlLeft",ControlRight:"ControlRight",OSLeft:"OSLeft",OSRight:"OSRight",ShiftLeft:"ShiftLeft",ShiftRight:"ShiftRight",ContextMenu:"ContextMenu",Enter:"Enter",Space:"Space",Tab:"Tab",Delete:"Delete",End:"End",Help:"Help",Home:"Home",Insert:"Insert",PageDown:"PageDown",PageUp:"PageUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",ArrowUp:"ArrowUp",Escape:"Escape",PrintScreen:"PrintScreen",ScrollLock:"ScrollLock",Pause:"Pause"};class Tr extends Ye{get type(){return"keyshortcut"}async getKeys(){return[]}async getDictionaries(){return{}}}const ye=Object.freeze({TOP_LEFT:"topLeft",TOP_MIDDLE:"topMiddle",TOP_RIGHT:"topRight",CENTER_LEFT:"centerLeft",CENTER_MIDDLE:"centerMiddle",CENTER_RIGHT:"centerRight",BOTTOM_LEFT:"bottomLeft",BOTTOM_MIDDLE:"bottomMiddle",BOTTOM_RIGHT:"bottomRight"}),ze=(n,e,t,i,s)=>{i=i||"",t=t||1e3;const r=j(`
        <div class="message-content ${i}">
            ${n?`<i class="icon">${n}</i>`:""}
            ${e?`<p class="text">${e}</p>`:""}
        </div>
    `);return s.innerHTML="",s.appendChild(r),s.timer&&(clearTimeout(s.timer),s.timer=null),s.timer=setTimeout(()=>{s.removeChild(r)},t),r};class hc extends be{constructor(e,t){const i={class:"video-container-message"};super(e,{attributes:i,parent:t}),this._topLeftContainer=j('<div class="container top-left"></div>',this.element),this._topMiddleContainer=j('<div class="container top-middle"></div>',this.element),this._topRightContainer=j('<div class="container top-right"></div>',this.element),this._centerLeftContainer=j('<div class="container center-left"></div>',this.element),this._centerMiddleContainer=j('<div class="container center-middle"></div>',this.element),this._centerRightContainer=j('<div class="container center-right"></div>',this.element),this._bottomLeftContainer=j('<div class="container bottom-left"></div>',this.element),this._bottomMiddleContainer=j('<div class="container bottom-middle"></div>',this.element),this._bottomRightContainer=j('<div class="container bottom-right"></div>',this.element)}show({icon:e=null,text:t="",timeout:i=1e3,position:s=ye.CENTER_MIDDLE,cssClass:r=""}){switch(s){case ye.TOP_LEFT:ze.apply(this,[e,t,i,r,this._topLeftContainer]);break;case ye.TOP_MIDDLE:ze.apply(this,[e,t,i,r,this._topMiddleContainer]);break;case ye.TOP_RIGHT:ze.apply(this,[e,t,i,r,this._topRightContainer]);break;case ye.CENTER_LEFT:ze.apply(this,[e,t,i,r,this._centerLeftContainer]);break;case ye.CENTER_MIDDLE:ze.apply(this,[e,t,i,r,this._centerMiddleContainer]);break;case ye.CENTER_RIGHT:ze.apply(this,[e,t,i,r,this._centerRightContainer]);break;case ye.BOTTOM_LEFT:ze.apply(this,[e,t,i,r,this._bottomLeftContainer]);break;case ye.BOTTOM_MIDDLE:ze.apply(this,[e,t,i,r,this._bottomMiddleContainer]);break;case ye.BOTTOM_RIGHT:ze.apply(this,[e,t,i,r,this._bottomRightContainer]);break}}}const uc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mute" serif:id="volume mute" transform="matrix(1,0,0,1,-123,-4.71142)">
        <path d="M142,28.522L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L127.478,14L142,28.522ZM151.228,34.983L123,6.756L125.044,4.711L132.848,12.516L139.68,5C140.961,5 142,6.039 142,7.32L142,21.667L153.272,32.939L151.228,34.983Z"/>
    </g>
</svg>
`,dc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-low" serif:id="volume low" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
</svg>
`,fc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mid" serif:id="volume mid" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1.79727,0,0,1.79727,-145.137,-17.5434)">
                <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
</svg>
`,gc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g transform="matrix(1,0,0,1,-164.25,-6)">
        <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(1.79727,0,0,1.79727,-310.137,-22.5434)">
        <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(2.44245,0,0,2.44245,-427.303,-35.9308)">
        <path d="M184.199,14.815C184.625,14.866 186.828,16.03 187.775,17.801C189.443,20.92 187.935,25.329 184.388,26.637C184.388,26.637 183.459,26.646 183.677,26.009C183.808,25.624 184.344,25.578 184.77,25.344C187.184,24.016 188.202,20.604 186.8,18.153C186.181,17.07 185.166,16.228 183.988,15.807C183.988,15.807 183.242,14.787 184.199,14.815Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(1,0,0,1,-125,-5)">
        <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
    </g>
</svg>
`,z=Object.freeze({UNLOADED:0,LOADING_MANIFEST:1,MANIFEST:2,LOADING_PLAYER:3,LOADED:4,UNLOADING_MANIFEST:5,UNLOADING_PLAYER:6,ERROR:7});function ns(n){n.__timeLinePopUp||(n.__timeLinePopUp={popUps:[],current:null})}class Kt extends be{static HideUserInterface(e){if(ns(e),e.__timeLinePopUp.current){const t=e.__timeLinePopUp.current;e.__timeLinePopUp.current.hide(!0),e.__timeLinePopUp.current=t}}static ShowUserInterface(e){ns(e),e.__timeLinePopUp.current&&e.__timeLinePopUp.current.show(!0)}static HideAll(e){var t;(t=e==null?void 0:e.__timeLinePopUp)==null||t.popUps.forEach(i=>i.hide())}static Unload(e){e.__timeLinePopUp&&(e.__timeLinePopUp.current&&e.__timeLinePopUp.current.removeFromParent(),e.__timeLinePopUp.popUps.forEach(t=>{t.removeFromParent()}),e.__timeLinePopUp.popUps.slice(0),delete e.__timeLinePopUp)}constructor(e,t=null){ns(e);const i={class:"timeline-popup-content"},s=e.containerElement;super(e,{attributes:i,parent:s}),this._contextObject=t,e.__timeLinePopUp.popUps.forEach(r=>r.hide()),this._id=Symbol(this),e.__timeLinePopUp.popUps.push(this),e.__timeLinePopUp.current=this,X(this.player,F.SHOW_POPUP,{popUp:this,plugin:this.contextObject})}get contextObject(){return this._contextObject}show(e=!1){this.isVisible||(this.player.__timeLinePopUp.popUps.forEach(t=>t.hide()),super.show(),this.player.__timeLinePopUp.current=this,e!==!0&&X(this.player,F.SHOW_POPUP,{popUp:this,plugin:this.contextObject}))}hide(e=!1){this.isVisible&&(super.hide(),this.player.__timeLinePopUp.current=null,e!==!0&&X(this.player,F.HIDE_POPUP,{popUp:this,plugin:this.contextObject}))}setContent(e){e&&(this.element.innerHTML="",this.element.appendChild(e))}}let rs=null;class Ct extends Vt{static Get(){return rs||(rs=new Ct),rs}get moduleName(){return"paella-core default plugins"}get moduleVersion(){return Ht.version}}class Sr extends Tr{getPluginModuleInstance(){return Ct.Get()}get name(){return super.name||"es.upv.paella.defaultShortcuts"}getVolumeIcon(e){return e===0?this.player.getCustomPluginIcon(this.name,"volumeMuteIcon")||uc:e<.3?this.player.getCustomPluginIcon(this.name,"volumeLowIcon")||dc:e<.6?this.player.getCustomPluginIcon(this.name,"volumeMidIcon")||fc:this.player.getCustomPluginIcon(this.name,"volumeHighIcon")||gc}toggleCaptions(){var e,t,i;if(((i=(t=(e=this.player)==null?void 0:e.captionsCanvas)==null?void 0:t.captions)==null?void 0:i.length)>0)if(this.player.captionsCanvas.isVisible)this.player.captionsCanvas.disableCaptions();else{let s=null;navigator.languages.some(r=>this.player.captionsCanvas.captions.some((a,o)=>r==a.language?(s=o,!0):!1)),this.player.captionsCanvas.enableCaptions({index:s||0})}}async togglePlayPause(){await this.player.paused()?await this.player.play():await this.player.pause()}async toggleFullscreen(){this.player.isFullscreen?await this.player.exitFullscreen():await this.player.enterFullscreen()}async seek(e){const t=await this.player.videoContainer.streamProvider.currentTime();await this.player.videoContainer.streamProvider.setCurrentTime(t+e),e<0?this.player.videoContainer.message.show({text:`<< ${Math.abs(e)}s`,position:ye.CENTER_LEFT,timeout:500}):this.player.videoContainer.message.show({text:`${e}s >>`,position:ye.CENTER_RIGHT,timeout:500})}async incrementVolume(e){const t=await this.player.videoContainer.streamProvider.volume(),i=Math.min(Math.max(0,t+e*.01),1);await this.player.videoContainer.setVolume(i);const s=this.getVolumeIcon(i);this.player.videoContainer.message.show({text:`${Math.round(i*100)}%`,position:ye.CENTER_MIDDLE,icon:s})}closePopUp(){var e;!Le.HideTopPopUp()&&!Kt.HideAll(this.player)&&((e=document.activeElement)==null||e.blur())}async decreaseSpeed(){const e=await this.player.videoContainer.playbackRate();let t=0;this._validPlaybackRates.some(i=>{if(t===0&&(t=i),i<e)t=i;else return!0}),await this.player.videoContainer.setPlaybackRate(t),this.player.videoContainer.message.show({text:`${t}X`,position:ye.CENTER_MIDDLE})}async increaseSpeed(){const e=await this.player.videoContainer.playbackRate();let t=0;this._validPlaybackRates.some(i=>{if(i>e)return t=i,!0}),t===0&&(t=this._validPlaybackRates[this._validPlaybackRates.length-1]),await this.player.videoContainer.setPlaybackRate(t),this.player.videoContainer.message.show({text:`${t}X`,position:ye.CENTER_MIDDLE})}async toggleVolume(){const e=await this.player.videoContainer.volume();let t=0;e>0?(this._lastVolume=e,t=0):t=this._lastVolume||1,await this.player.videoContainer.setVolume(t);const i=this.getVolumeIcon(t);this.player.videoContainer.message.show({text:`volume: ${Math.round(t*100)}%`,position:ye.CENTER_MIDDLE,icon:i})}async load(){this._validPlaybackRates=this.config.validPlaybackRates||[.75,1,1.5,2],this._validPlaybackRates.sort((e,t)=>e-t)}async getKeys(){const e=this.player,t=this.config.skipBackwards||30,i=this.config.skipForward||30,s=()=>e.state===z.LOADED;return[{keyCode:Te.KeyM,description:"Toggle audio mute",keyModifiers:{ctrlKey:!1},action:async()=>{s()&&await this.toggleVolume()}},{keyCode:Te.KeyK,description:"Toggle play/pause",action:async()=>{await this.togglePlayPause()}},{keyCode:Te.KeyJ,get description(){return e.translate("Rewind $1 seconds",[t])},action:async()=>{s()&&await this.seek(-t)}},{keyCode:Te.KeyL,get description(){return e.translate("Forward $1 seconds",[i])},action:async()=>{s()&&await this.seek(i)}},{keyCode:Te.Space,description:"Toggle play/pause",action:async()=>{s()&&await this.togglePlayPause()}},{keyCode:Te.KeyF,description:"Toggle fullscreen",action:async()=>{s()&&await this.toggleFullscreen()}},{keyCode:Te.KeyC,description:"Toggle captions",action:async()=>{s()&&this.toggleCaptions()}},{keyCode:Te.ArrowLeft,get description(){return e.translate("Rewind $1 seconds",[t])},action:async()=>{s()&&await this.seek(-t)}},{keyCode:Te.ArrowRight,get description(){return e.translate("Forward $1 seconds",[i])},action:async()=>{s()&&await this.seek(i)}},{keyCode:Te.ArrowUp,description:"Volume up 10%",action:async()=>{s()&&this.incrementVolume(10)}},{keyCode:Te.ArrowDown,description:"Volume down 10%",action:async()=>{s()&&this.incrementVolume(-10)}},{keyCode:Te.Escape,description:"Close pop-up",action:async()=>{s()&&this.closePopUp()}},{keyCode:Te.KeyU,description:"Decrease playback speed",action:async()=>{s()&&await this.decreaseSpeed()}},{keyCode:Te.KeyO,description:"Increase playback speed",action:async()=>{s()&&this.increaseSpeed()}}]}}async function mc(n){const e=[];await Ae(n,"captions",async t=>{e.push(t)});for(let t in e){const s=await e[t].getCaptions(),r=n.captionsCanvas;s.forEach(a=>r.addCaptions(a))}}class as extends Ye{get type(){return"captions"}async load(){this.player.log.debug("load captions plugin")}async getCaptions(){return this.player.log.warn(`CaptionsPlugin ${this.name}: getCaptions() is not implemented.`),[]}}class os{get cues(){return this._cues}get label(){return this._label}get language(){return this._lang}set label(e){this._label=e}set language(e){this._lang=e}constructor(e="",t=""){this._cues=[],this._label=e,this._lang=t}addCue({label:e="",start:t,end:i,captions:s}){const r={label:e};if(typeof s=="string")r.captions=[s];else if(Array.isArray(s))r.captions=s;else throw Error("Invalid cue caption format: must be an array of strings or a string");if(typeof t=="string")r.start=ti(t),r.startString=t;else if(typeof t=="number")r.start=t,r.startString=ji(t);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");if(typeof i=="string")r.end=ti(i),r.endString=i;else if(typeof i=="number")r.end=i,r.endString=ji(i);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");return this._cues.push(r),r}getCue(e){if(typeof e=="string")e=ti(e);else if(typeof e!="number")throw Error("Invalid time instant format getting cue");let t=null;return this._cues.some(i=>{if(e>=i.start&&e<=i.end)return t=i,!0}),t}}function ls(n,e){const t={},s=new DOMParser().parseFromString(e,"text/xml");return Array.from(s.getElementsByTagName("div")).forEach(r=>{const a=r.getAttribute("xml:lang")||"unknonw";t[a]=t[a]||new os(n.translate(a),a),Array.from(r.getElementsByTagName("p")).forEach(o=>{const l=qi(o.getAttribute("begin"));t[a].addCue({label:`caption_${o.getAttribute("xml:id")||l}`,start:l/1e3,end:qi(o.getAttribute("end"))/1e3,captions:o.innerHTML})})}),t}class xr{constructor(e,t=""){this.player=e,this._text=t,this._captions=ls(this.player,t)}get text(){return this._text}set text(e){this._text=e,this._captions=ls(e)}get captions(){return this._captions}}class Lr extends as{getPluginModuleInstance(){return Ct.Get()}get name(){return super.name||"es.upv.paella.dfxpManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const e=[],t=[];return this.player.videoManifest.captions.forEach(i=>{t.push(new Promise(async(s,r)=>{if(/dfxp/i.test(i.format)){const a=et(this.player,i.url),o=await fetch(a);if(o.ok){let l=await o.text();l=l.replace(/[^\x09\x0A\x0D\x20-\xFF\x85\xA0-\uD7FF\uE000-\uFDCF\uFDE0-\uFFFD]/gm,""),l=l.replace(/&\w+;/gmi,""),l=l.replaceAll("<br>","");const c=new xr(this.player,l);Object.entries(c.captions).forEach(([h,u])=>{e.push(u)}),s()}else r()}else r()}))}),await Promise.allSettled(t),e}}class oi extends Ye{constructor(e,t,i){super(e,t,i),this.__uiPlugin=!0}async getDictionaries(){return null}}let cs="en",_r="";const bt={};function hs(n){const e=bt[cs]||{},t=bt[_r]||{};return e[n]||t[n]||n}function us(n){cs=n}function ds(){return cs}function fs(n,e){bt[n]=bt[n]||{};for(const t in e){const i=e[t];bt[n][t]=i}}function gs(){return bt}function ms(n){return n.config.defaultLanguage||navigator.language}let Cr=hs,br=us,Ar=ds,wr=fs,Rr=gs,Ir=ms;function mt(n,e=null){const t=Cr(n);if(Array.isArray(e)){let i=t;return e.forEach((s,r)=>{const a=`$${r+1}`;i=i.replace(a,s)}),i}else return t}function ps(n){br(n)}function Dr(){return Ar()}function At(n,e){wr(n,e)}function Pr(){return Rr()}function ys(n){return Ir(n)}function pc(n){Cr=n}function yc(n){br=n}function vc(n){Ar=n}function Ec(n){wr=n}function Tc(n){Rr=n}function Sc(n){Ir=n}function xc(n){_r=ys(n)}function vs(n){return n.__tabIndex=n.__tabIndex||0,++n.__tabIndex,n.__tabIndex}function Lc(n){return n.__tabIndex||0}async function Wt(n,e){var c,h;const t=j("<li></li>",e);t.plugin=n;const i=n.tabIndex,s=mt(n.ariaLabel),r=mt(n.description),a=n.dynamicWidth?"dynamic-width":"fixed-width",o=n.id?`id="${n.id}" `:"",l=n.buttonName?`name="${n.buttonName}" `:"";if(n.interactive){const u=j(`
			<button type="button" ${o}${l}class="${n.className} ${a} no-icon" tabindex="${i}" aria-label="${s}" title="${r}">
			</button>
		`,t);n._button=u,n._container=t,u._pluginData=n,t._pluginData=n,u.addEventListener("click",v=>{const E=u._pluginData;E.closePopUps&&E.popUp?Le.HideNonAncestors(E.popUp):E.closePopUps&&Le.HideAllPopUps(!1),X(E.player,F.BUTTON_PRESS,{plugin:E}),E.action(v),v.stopPropagation(),v.pageX!==0&&v.pageY!==0&&document.activeElement.blur()});let d=null;const g=()=>{d&&(clearTimeout(d),d=null)},f=()=>{g(),d=setTimeout(()=>{n.leftSideContainerPresent&&n.leftSideContainer.classList.add("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.add("hidden"),d=null},300)},m=()=>{g(),n.leftSideContainerPresent&&n.leftSideContainer.classList.remove("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.remove("hidden")};u.addEventListener("focus",m),u.addEventListener("mouseover",m),u.addEventListener("mouseout",f),u.addEventListener("blur",f),(((c=n.player.config.accessibility)==null?void 0:c.clickWithSpacebar)!==void 0?(h=n.player.config.accessibility)==null?void 0:h.clickWithSpacebar:!0)||(u.addEventListener("keyup",v=>{v.keyCode==32&&v.preventDefault()}),u.addEventListener("keydown",v=>{v.keyCode==32&&v.preventDefault()}))}else{const u=j(`
			<div ${o}${l} class="button-plugin ${n.className} non-interactive ${a} no-icon" title="${r}">
			</div>
		`,t);n._button=u,n._container=t,u._pluginData=n,t._pluginData=n}}const kr=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};class Es extends oi{constructor(){super(...arguments);Gn(this,lt,null);Gn(this,ct,null)}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return vs(this.player)}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){if(this._icon=t,t){const i=this._button.querySelector("i")||j("<i></i>",this._button);i.innerHTML=t}else{const i=this._button.querySelector("i");i&&this._button.removeChild(i)}}get title(){return this._title||""}set title(t){if(this._title=t,t){const i=this._button.querySelector("span")||j(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else{const i=this._button.querySelector("span");i&&this._button.removeChild(i)}}get titleSize(){return"medium"}get side(){var i;return((i=this.config)==null?void 0:i.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var i;return((i=this.config)==null?void 0:i.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return Je(this,lt)||(Vn(this,lt,kr()),this.container.appendChild(Je(this,lt))),Je(this,lt)}get leftSideContainerPresent(){return Je(this,lt)!==null}get rightSideContainer(){return Je(this,ct)||(Vn(this,ct,kr()),this.container.appendChild(Je(this,ct))),Je(this,ct)}get rightSideContainerPresent(){return Je(this,ct)!==null}async action(){this.player.log.warn(`Action not implemented in button plugin ${this.name}`)}onResize({width:t,height:i}){t<this.minContainerSize?this.hide():this.show()}}lt=new WeakMap,ct=new WeakMap;const _c=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 23 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="play" transform="matrix(1.36051e-16,0.480277,-0.550439,1.55927e-16,74.9184,-144.269)">
        <path d="M325.373,94.327L350.358,136.107L300.387,136.107L325.373,94.327Z"/>
    </g>
</svg>
`,Cc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 24 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="pause" transform="matrix(1,0,0,0.956522,-48,-7.65217)">
        <path d="M64,8L72,8L72,31L64,31L64,8ZM48,8L56,8L56,31L48,31L48,8Z"/>
    </g>
</svg>
`,bc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 42" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1.94013e-16,0.689169,-0.784942,2.23746e-16,110.436,-203.562)">
        <g id="play">
            <path d="M304.588,115.214C304.588,105.205 313.901,97.079 325.373,97.079C336.844,97.079 346.157,105.205 346.157,115.214C346.157,125.223 336.844,133.349 325.373,133.349L325.373,128.287C333.642,128.287 340.356,122.43 340.356,115.214C340.356,107.999 333.642,102.141 325.373,102.141C317.103,102.141 310.39,107.999 310.39,115.214L304.588,115.214Z"/>
            <g transform="matrix(-2.33361,-6.00363e-16,1.21708e-15,-2.59724,320.246,134.358)">
                <path d="M5.454,3.35L9.398,7.505L1.511,7.505L5.454,3.35Z"/>
            </g>
        </g>
    </g>
</svg>
`;class Fr extends Es{getPluginModuleInstance(){return Ct.Get()}get name(){return super.name||"es.upv.paella.playPauseButton"}async load(){const e=this.player.getCustomPluginIcon(this.name,"play")||_c,t=this.player.getCustomPluginIcon(this.name,"pause")||Cc,i=this.player.getCustomPluginIcon(this.name,"replay")||bc;this.icon=e,ie(this.player,F.PLAY,()=>{this.icon=t}),ie(this.player,F.PAUSE,()=>{this.icon=e}),ie(this.player,F.ENDED,()=>{this.icon=i}),ie(this.player,F.STOP,()=>{this.icon=e})}async action(){await this.player.paused()?await this.player.videoContainer.play():await this.player.videoContainer.pause()}}const Or="(?:\\d*:){1,2}\\d*(?:\\.\\d+)?",Ac=`(${Or})\\s*\\-\\->\\s*(${Or})`,wc={cueTiming:new RegExp(Ac)},Rc=(n,e,t,i)=>{const s=wc.cueTiming.exec(e);if(s){const r=i[t-1],a=[];for(let o=1;t+o<i.length&&i[t+o]!=="";++o)a.push(i[t+o]);n.addCue({label:r,start:s[1],end:s[2],captions:a})}};function Ts(n){const e=new os;return n!==""&&(n=n.replace(/\r\n/gm,`
`),n=n.replace(/\r/gm,`
`),n.split(/\n/).forEach((t,i,s)=>{Rc(e,t,i,s)})),e}class Mr{constructor(e=""){this._text=e,this._captions=Ts(e)}get text(){return this._text}set text(e){this._text=e,this._captions=Ts(e)}get captions(){return this._captions}}class Nr extends as{getPluginModuleInstance(){return Ct.Get()}get name(){return super.name||"es.upv.paella.vttManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const e=[],t=[];return this.player.videoManifest.captions.forEach(i=>{t.push(new Promise(async(s,r)=>{if(/vtt/i.test(i.format)){const a=et(this.player,i.url),o=await fetch(a);if(o.ok){const l=await o.text(),c=new Mr(l);c.captions.label=i.text,c.captions.language=i.lang,e.push(c.captions),s()}else r()}else r()}))}),await Promise.allSettled(t),e}}function li(n,e){return Os(n,"layout").filter(i=>i.config&&i.config.enabled&&i.canApply(e))}function Ur(n,e){const t=li(n,e),i=[];return t.forEach(s=>{i.push(...s.getValidContentIds(e))}),i}function Ic(n,e){const t=[];return Os(n,"layout").filter(i=>{var s,r;if((s=i.config)!=null&&s.enabled&&((r=i.config)!=null&&r.validContent))return i.config.validContent.every(a=>a.content.length===e)}).forEach(i=>i.config.validContent.forEach(s=>t.push(s.content))),t}function Br(n,e,t){const i=li(n,e);let s=null;return i.some(r=>{if(r.getValidContentIds(e).indexOf(t)!==-1)return s=r,!0}),s}function Dc(n,e){const t=li(n,e),i=Ur(n,e);let s=[];return t.forEach(r=>{s=[...s,...r.config.validContent]}),s.filter(r=>i.indexOf(r.id)!==-1)}function $r(n,e,t,i=null){const s=Br(n,e,t);if(s){const r=s.getLayoutStructure(e,t,i);return r.plugin=s,r}return null}class pt extends oi{get type(){return"layout"}get layoutType(){return"static"}getTabIndexStart(){return 10}get tabIndexStart(){var e;return((e=this.config)==null?void 0:e.tabIndexStart)||this.getTabIndexStart()}get identifier(){return"default"}get icon(){return"icon.png"}get validContent(){var e;return((e=this.config)==null?void 0:e.validContent)||[]}get validContentIds(){const e=[];return this.validContent.forEach(t=>e.push(t.id)),e}getValidContentIds(e){const t=[];return this.validContent.forEach(i=>{i.content.every(s=>e.some(r=>s===r.content))&&t.push(i.id)}),t}getValidStreams(e){const t=[];return this.validContent.forEach(i=>{let s=[];i.content.every(r=>e.some(a=>{if(r===a.content)return s.push(a),!0}))&&t.push(s)}),t}canApply(e){return this.getValidStreams(e).length>0}getLayoutStructure(){return{}}getVideoCanvasButtons(e,t,i){return[]}}function Pc(n){return{icon:n.icon,position:n.position,title:n.description,ariaLabel:n.ariaLabel,name:n.buttonName,click:async e=>{const t=n.player.videoContainer.streamProvider.streams[e];await n.action(e,t==null?void 0:t.player,t==null?void 0:t.canvas,t==null?void 0:t.canvasPlugin)}}}async function kc(n,e){const t=[];return await Ae(n,"canvasButton",async i=>{n.log.debug(` Canvas button plugin: ${i.name}`),t.push(i)}),t.filter(i=>i.content.indexOf(e.content)!==-1).map(i=>Pc(i))}class Fc extends oi{get type(){return"canvasButton"}get content(){return this._config.content||["presenter"]}get ariaLabel(){return this._config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return vs(this.player)}get description(){return this.config.description||this.getDescription()}getDescription(){return""}get icon(){return this._icon}set icon(e){this._icon=e}get side(){var e;return((e=this.config)==null?void 0:e.side)||"left"}get buttonName(){return this.name}get position(){switch(this.side){case"left":return ne.LEFT;case"center":return ne.CENTER;case"right":return ne.RIGHT;default:throw new Error(`Invalid CanvasButtonPlugin side set: ${this.side}`)}}async action(e){this.player.log.warn(`Action not implemented in canvas button plugin ${this.name}`)}}const Ss=[];async function Oc(n){await Ae(n,"canvas",e=>{Ss.push(e)})}async function Mc(n){}function Nc(n,e){if(Ss.length===0)throw Error("No canvas plugins loaded. Note that `loadCanvasPlugins()` must to be called before use `getCanvasPlugins()`");let t=null;return Ss.some(i=>{if(i.isCompatible(e))return t=i,!0}),t}const ne=Object.freeze({LEFT:"left",CENTER:"center",RIGHT:"right"}),Uc=function({icon:n,tabIndex:e,ariaLabel:t,title:i,className:s,position:r=ne.CENTER,click:a,content:o,name:l}){if(!n)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'icon' attribute.");if(!a)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'click' function.");let c=`class="align-${r}${s?" "+s:""}"`;t&&(c+=` aria-label="${t}"`),i&&(c+=` title="${i}"`),e!==void 0&&(c+=` tabindex="${e}"`),l!==void 0&&(c+=` name="${l}"`);const h=j(`
        <button ${c}><i class="button-icon" style="pointer-events: none">${n}</i></button>
    `);return this.buttonsArea.appendChild(h),h.addEventListener("click",async u=>(await a(o),u.stopPropagation(),!1)),h},xs=async(n,e,t,i,s)=>{const r=e.plugin;let a=r.tabIndexStart;const o=await kc(n,i),l=[];return[...o,...r.getVideoCanvasButtons(e,i.content,i,t)].forEach(h=>{h.tabIndex=a++,h.content=s;const u=Uc.apply(t,[h]);l.push(u)}),l},Ls=(n,e,t)=>{let{tabIndexStart:i}=e.plugin;t.sort((s,r)=>{const a=s.getBoundingClientRect().left,o=r.getBoundingClientRect().left;return a-o}).forEach(s=>{s.setAttribute("tabindex",i++)})};class _s extends be{constructor(e,t,i){super(t,{tag:e,parent:i}),this.element.className="video-canvas",this._userArea=null,this._buttonsArea=j(`
        <div class="button-area">
        </div>
        `,this.element)}async loadCanvas(e){throw Error(`${this.name}: loadCanvas() not implemented`)}get userArea(){return this._userArea||(this._userArea=document.createElement("div"),this._userArea.className="user-area",this.element.appendChild(this._userArea)),this._userArea}get buttonsArea(){return this._buttonsArea}showButtons(){this.buttonsArea.style.display=null}hideButtons(){this.buttonsArea.style.display="none"}}class Cs extends Ye{get type(){return"canvas"}get canvasType(){return""}isCompatible(e){return Array.isArray(e==null?void 0:e.canvas)?e.canvas.indexOf(this.canvasType)!==-1:e.canvas===this.canvasType}getCanvasInstance(e){throw Error(`${this.name} canvas plugin: getCanvasInstance() not implemented`)}}let bs=null;class st extends Vt{static Get(){return bs||(bs=new st),bs}get moduleName(){return"paella-core default video layouts"}get moduleVersion(){return Ht.version}}const As=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.920758,0,0,0.920758,2.50561,1.21236)">
        <path d="M11.937,17.699L11.937,21.044C11.937,21.656 11.573,22.209 11.012,22.451C10.45,22.693 9.798,22.578 9.354,22.158L1.874,15.1C1.568,14.811 1.394,14.408 1.394,13.986C1.394,13.564 1.568,13.161 1.874,12.872L9.354,5.814C9.798,5.394 10.45,5.279 11.012,5.521C11.573,5.763 11.937,6.316 11.937,6.928L11.937,10.272L22.937,10.272C23.783,10.272 24.469,10.958 24.469,11.804L24.469,16.168C24.469,17.014 23.783,17.699 22.937,17.699L11.937,17.699ZM26.063,23.11L26.063,19.765C26.063,19.153 26.427,18.6 26.988,18.358C27.55,18.116 28.201,18.231 28.646,18.651L36.126,25.709C36.432,25.999 36.606,26.402 36.606,26.823C36.606,27.245 36.432,27.648 36.126,27.937L28.646,34.996C28.201,35.415 27.55,35.53 26.988,35.288C26.427,35.046 26.063,34.493 26.063,33.882L26.063,30.537L15.063,30.537C14.217,30.537 13.531,29.851 13.531,29.005L13.531,24.641C13.531,23.795 14.217,23.11 15.063,23.11L26.063,23.11Z"/>
    </g>
</svg>
`,ci=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <path d="M-20.625,8.591C-20.625,6.174 -17.975,4.215 -14.704,4.215L31.492,4.215C34.763,4.215 37.413,6.174 37.413,8.591L37.413,35.582C37.413,37.998 34.763,39.957 31.492,39.957L-14.704,39.957C-17.975,39.957 -20.625,37.998 -20.625,35.582L-20.625,8.591ZM1.285,12.825L8.1,7.789L-15.786,7.789L-15.786,25.442L-8.972,20.406L6.737,32.016L16.994,24.435L1.285,12.825Z" />
    </g>
</svg>
`,Yt=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g>
        <path d="M18,13.029L18,26.971C18,27.509 17.786,28.025 17.406,28.406C17.025,28.786 16.509,29 15.971,29L3.029,29C2.491,29 1.975,28.786 1.594,28.406C1.214,28.025 1,27.509 1,26.971L1,13.029C1,12.491 1.214,11.975 1.594,11.594C1.975,11.214 2.491,11 3.029,11L15.971,11C16.509,11 17.025,11.214 17.406,11.594C17.786,11.975 18,12.491 18,13.029ZM39,13.029L39,26.971C39,27.509 38.786,28.025 38.406,28.406C38.025,28.786 37.509,29 36.971,29L24.029,29C23.491,29 22.975,28.786 22.594,28.406C22.214,28.025 22,27.509 22,26.971L22,13.029C22,12.491 22.214,11.975 22.594,11.594C22.975,11.214 23.491,11 24.029,11L36.971,11C37.509,11 38.025,11.214 38.406,11.594C38.786,11.975 39,12.491 39,13.029ZM21,7L21,33L19,33L19,7L21,7Z"/>
    </g>
</svg>
`,Bc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.19142,40.6376,-0.550686)">
            <path d="M38.001,14.89L16.256,14.89C15.767,14.89 15.297,15.084 14.951,15.43C14.605,15.776 14.41,16.246 14.41,16.735C14.41,21.528 14.41,33.999 14.41,33.999L5.673,33.999C3.644,33.999 2,32.355 2,30.327L2,7.673C2,5.644 3.644,4 5.673,4L34.329,4C36.358,4 38.001,5.644 38.001,7.673L38.001,14.89Z"/>
        </g>
        <g transform="matrix(-1.62701,0,0,1.19712,41.1319,-0.602464)">
            <path d="M39.174,17.858C39.174,17.501 39.032,17.158 38.781,16.906C38.529,16.653 38.188,16.511 37.833,16.511C33.587,16.511 20.516,16.511 17.043,16.511C16.816,16.511 16.598,16.602 16.438,16.763C16.278,16.924 16.188,17.142 16.188,17.37C16.188,20.366 16.188,30.369 16.188,34.019C16.188,34.376 16.329,34.719 16.581,34.971C16.832,35.224 17.173,35.366 17.529,35.366C21.597,35.366 33.765,35.366 37.833,35.366C38.188,35.366 38.529,35.224 38.781,34.971C39.032,34.719 39.174,34.376 39.174,34.019C39.174,30.548 39.174,21.329 39.174,17.858Z"/>
        </g>
    </g>
</svg>
`;class ws extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.pipContentIds=this.config.pipContentIds||[],this.allowSwitchSide=this.config.allowSwitchSide!==void 0?this.config.allowSwitchSide:!0}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconMaximize")||ci,a=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||Yt,o=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||As,l=this.player.getCustomPluginIcon(this.name,"iconClose")||_t,c=this.player.getCustomPluginIcon(this.name,"iconPiP")||Bc,h=()=>this._currentContent.find(f=>f.id===t),u=()=>h().size===25,d=()=>h().size>50,g=[];return u()||d()?g.push({icon:a,position:ne.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{this._currentContent.forEach(f=>{f.size=50}),await this.player.videoContainer.updateLayout()}}):g.push({icon:r,position:ne.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this._currentContent.forEach(f=>{f.size=f.id===t?75:25}),await this.player.videoContainer.updateLayout()}}),this.allowSwitchSide&&g.push({icon:o,position:ne.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{const f=this._currentContent[0].id,m=this._currentContent[1].id,p=this._currentContent[0].size,v=this._currentContent[1].size;this._currentContent[0].id=m,this._currentContent[0].size=v,this._currentContent[1].id=f,this._currentContent[1].size=p,await this.player.videoContainer.updateLayout()}}),g.push({icon:l,position:ne.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const m=this.player.videoContainer.validContentIds.filter(p=>p.indexOf("-")===-1).find(p=>p!=t);await this.player.videoContainer.setLayout(m)}}),this.pipContentIds.length>0&&g.push({icon:c,position:ne.LEFT,title:this.player.translate("Picture-in-picture"),ariaLabel:this.player.translate("Picture-in-picture"),name:this.name+":iconPiP",click:async()=>{const f=this.player.videoContainer.validContentIds.find(m=>this.pipContentIds.indexOf(m)!==-1);await this.player.videoContainer.setLayout(f,t)}}),g}getLayoutStructure(e,t,i){if(!this._currentContent){const{content:s}=this.validContent.find(r=>r.id===t);this._currentContent=s.map(r=>({id:r,size:50}))}return{id:"dual-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size},{content:this._currentContent[1].id,visible:!0,size:this._currentContent[1].size}]}}}const Gr=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.50139,0,0,1.10483,39.8625,1.72153)">
            <path d="M22.034,28.802C22.58,28.752 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.04,34.063 22.034,34.123L22.034,40.015L13,31.5L22.034,23.015L22.034,28.802Z" />
        </g>
        <g transform="matrix(1.50139,1.35303e-16,1.83867e-16,-1.10483,-24.8768,44.5033)">
            <path d="M22.161,28.786C22.706,28.736 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.167,34.048 22.161,34.107L22.161,40L13,31.5L22.161,23L22.161,28.786Z" />
        </g>
    </g>
</svg>
`;let Ne=0;const Rs=[{id:"side-by-side",videos:[{content:null,rect:[{aspectRatio:"16/9",width:560,height:315,top:218,left:712},{aspectRatio:"16/10",width:560,height:350,top:206,left:712},{aspectRatio:"4/3",width:560,height:420,top:173,left:712},{aspectRatio:"5/3",width:560,height:336,top:206,left:712},{aspectRatio:"5/4",width:560,height:448,top:160,left:712}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",width:688,height:387,top:166,left:10},{aspectRatio:"16/10",width:688,height:430,top:148,left:10},{aspectRatio:"4/3",width:688,height:516,top:111,left:10},{aspectRatio:"5/3",width:690,height:414,top:154,left:10},{aspectRatio:"5/4",width:690,height:552,top:96,left:10}],visible:!0,layer:"1"}],buttons:[]},{id:"pip-left",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]},{id:"pip-right",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]}];function $c(n){return Ne=(Ne+1)%Rs.length,Is(n)}function zt(n,e){return Ne=e<Rs.length?e:Ne,Is(n)}function Is(n){let e=JSON.parse(JSON.stringify(Rs[Ne]));return e.videos[0].content=n[0],e.videos[1].content=n[1],e}class Vr extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideo"}get identifier(){return"dual-video"}async load(){let e=tt("dualVideoLayoutIndex");e!==""&&(Ne=Number(e)),this.player.log.debug("Dual video layout loaded")}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===2)}switchContent(){const e=this._currentContent[0],t=this._currentContent[1];this._currentContent[0]=t,this._currentContent[1]=e,this.player.videoContainer.updateLayout()}async switchMinimized(){$c(this._currentContent),await this.player.videoContainer.updateLayout()}async minimizeVideo(e){let t=!0;if(e===this._currentContent[0]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,t=!1}Ne===1&&t?zt(this._currentContent,2):zt(this._currentContent,1),await this.player.videoContainer.updateLayout()}async maximizeVideo(e){let t=!0;if(e===this._currentContent[1]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,t=!1}Ne===1&&t?zt(this._currentContent,2):zt(this._currentContent,1),await this.player.videoContainer.updateLayout()}async setSideBySide(){zt(this._currentContent,0),await this.player.videoContainer.updateLayout()}get minimizedContent(){return Ne===0?"":this._currentContent[1]}async closeVideo(e){const i=this.player.videoContainer.validContentIds.filter(s=>s.indexOf("-")===-1).find(s=>s!=e);await this.player.videoContainer.setLayout(i)}getVideoCanvasButtons(e,t,i,s){if(e.id==="side-by-side")return[{icon:this.player.getCustomPluginIcon(this.name,"iconRotate")||Gr,position:ne.LEFT,title:this.player.translate("Swap position of the videos"),ariaLabel:this.player.translate("Swap position of the videos"),name:this.name+":iconRotate",click:async()=>{await this.switchContent()}},{icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||ci,position:ne.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.maximizeVideo(t)}},{icon:this.player.getCustomPluginIcon(this.name,"iconClose")||_t,position:ne.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}}];{const r=[];return t===this.minimizedContent?(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||ci,position:ne.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||As,position:ne.LEFT,title:this.player.translate("Place the video on the other side of the screen"),ariaLabel:this.player.translate("Place the video on the other side of the screen"),name:this.name+":iconSwitchSide",click:async()=>{await this.minimizeVideo(t)}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||_t,position:ne.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}})):(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMinimize")||Hn,position:ne.LEFT,title:this.player.translate("Minimize video"),ariaLabel:this.player.translate("Minimize video"),name:this.name+":iconMinimize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||Yt,position:ne.LEFT,title:this.player.translate("Put the videos side by side"),ariaLabel:this.player.translate("Put the videos side by side"),name:this.name+":iconSideBySide",click:async()=>{await this.setSideBySide()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||_t,position:ne.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}})),r}}getLayoutStructure(e,t){if(!this._currentContent||this._currentContentId!==t){const{content:r}=this.validContent.find(l=>l.id===t);this._currentContent=r,this._currentContentId=t;const a=tt("dualVideoLayoutContent0"),o=tt("dualVideoLayoutContent1");a!==""&&o!==""&&this._currentContent.indexOf(a)!==-1&&this._currentContent.indexOf(o)!==-1&&(this._currentContent[0]=a,this._currentContent[1]=o)}const i=Is(this._currentContent),s={id:i.id,player:this.player,name:{es:"Dos streams con posición dinámica"},hidden:!1,videos:i.videos,buttons:[]};return dt("dualVideoLayoutIndex",Ne),dt("dualVideoLayoutContent0",this._currentContent[0]),dt("dualVideoLayoutContent1",this._currentContent[1]),s}}const Hr={id:"pip-left",name:{es:"Dos streams imagen dentro de imagen"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:617,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262},{aspectRatio:"9/16",left:224,top:301,width:224,height:400}],visible:!0,layer:2}],buttons:[]},Gc={id:"pip-right",name:{es:"Dos streams imagen dentro de imagen a la derecha"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:242,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262},{aspectRatio:"9/16",left:887,top:304,width:224,height:400}],visible:!0,layer:2}],buttons:[]};class Vc extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideoPiP"}get identifier(){return"dual-video-pip"}async load(){this._currentLayout=Hr,this.dualVideoContentIds=this.config.dualVideoContentIds||[]}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===2)}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconClose")||_t,a=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||As,o=this.player.getCustomPluginIcon(this.name,"iconMaximize")||ci,l=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||Yt,c=[{icon:r,position:ne.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const u=this.player.videoContainer.validContentIds.filter(d=>d.indexOf("-")===-1).find(d=>d!==t);await this.player.videoContainer.setLayout(u)}}];return t===this._pipVideo?(c.push({icon:a,position:ne.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{this.switchSide(),await this.player.videoContainer.updateLayout(this._fullVideo)}}),c.push({icon:o,position:ne.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this.switchSources(),await this.player.videoContainer.updateLayout(this._fullVideo)}})):this.dualVideoContentIds.length>0&&c.push({icon:l,position:ne.LEFT,title:this.player.translate("Set side by side"),ariaLabel:this.player.translate("Set side by side"),name:this.name+":iconSideBySide",click:async()=>{const h=this.player.videoContainer.validContentIds,u=this.dualVideoContentIds.find(d=>h.indexOf(d)!==-1);u&&this.player.videoContainer.setLayout(u)}}),c}switchSide(){this._currentLayout.id==="pip-left"?this._currentLayout=Gc:this._currentLayout=Hr}switchSources(){const e=this._pipVideo;this._pipVideo=this._fullVideo,this._fullVideo=e}getLayoutStructure(e,t,i){const{content:s}=this.validContent.find(a=>a.id===t);i&&s.find(a=>a===i)?(this._fullVideo=i,this._pipVideo=s.find(a=>a!==i)):(!this._pipVideo||!this._fullVideo)&&(this._pipVideo=s[0],this._fullVideo=s[1]);const r=JSON.parse(JSON.stringify(this._currentLayout));return r.player=this.player,r.videos[0].content=this._fullVideo,r.videos[1].content=this._pipVideo,r}}class Kr extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.singleVideo"}get identifier(){return"single-video"}async load(){this.player.log.debug("Single video layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===1)}getVideoCanvasButtons(e,t,i,s){return this._multiStream?[{icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||Yt,position:ne.LEFT,title:this.player.translate("Two videos 50%"),ariaLabel:this.player.translate("Two videos 50%"),name:this.name+":iconSideBySide",click:()=>{const r=this.player.videoContainer.validContentIds,a=this.dualVideoContentIds.find(o=>r.indexOf(o)!==-1);a&&this.player.videoContainer.setLayout(a)}}]:[]}getLayoutStructure(e,t){const i=this.validContent.find(r=>r.id===t),s={player:this.player,name:{es:"One stream"},hidden:!1,videos:[{content:i.content[0],rect:[{aspectRatio:"1/1",left:280,top:0,width:720,height:720},{aspectRatio:"6/5",left:208,top:0,width:864,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"11/8",left:145,top:0,width:990,height:720},{aspectRatio:"1.41/1",left:132,top:0,width:1015,height:720},{aspectRatio:"1.43/1",left:125,top:0,width:1029,height:720},{aspectRatio:"3/2",left:100,top:0,width:1080,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"1.85/1",left:0,top:14,width:1280,height:692},{aspectRatio:"2.35/1",left:0,top:87,width:1280,height:544},{aspectRatio:"2.41/1",left:0,top:94,width:1280,height:531},{aspectRatio:"2.76/1",left:0,top:128,width:1280,height:463}],visible:!0,layer:1}],background:{content:"slide_professor_paella.jpg",zIndex:5,rect:{left:0,top:0,width:1280,height:720},visible:!0,layer:0},logos:[{content:"paella_logo.png",zIndex:5,rect:{top:10,left:10,width:49,height:42}}],buttons:[],onApply:function(){}};return e.length>1&&(this._multiStream=!0),s}}class Hc extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.singleVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.player.log.debug("Single video dynamic layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||Yt,a=[];return this._multiStream&&a.push({icon:r,position:ne.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{const o=this.player.videoContainer.validContentIds,l=this.dualVideoContentIds.find(c=>o.indexOf(c)!==-1);l&&this.player.videoContainer.setLayout(l)}}),a}getLayoutStructure(e,t,i){e.length>1&&(this._multiStream=!0);const{content:s}=this.validContent.find(r=>r.id===t);return this._currentContent=s.map(r=>({id:r,size:50})),{id:"single-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size}]}}}const Kc={videos:[{content:{},rect:[{aspectRatio:"16/9",left:239,top:17,width:803,height:451}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:44,top:482,width:389,height:218}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:847,top:482,width:389,height:218}],visible:!0,layer:1}],buttons:[{rect:{left:618,top:495,width:45,height:45},onClick:function(n){this.rotate()},label:"Rotate",icon:"icon_rotate.svg",layer:2}]};function Wc(n){let e=JSON.parse(JSON.stringify(Kc));return e.videos[0].content=n[0],e.videos[1].content=n[1],e.videos[2].content=n[2],e}class Wr extends pt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.tripleVideo"}get identifier(){return"triple-video"}async load(){this.player.log.debug("Triple video layout loaded")}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===3)}switchContent(){const e=this._currentContent[0],t=this._currentContent[1],i=this._currentContent[2];this._currentContent[0]=i,this._currentContent[1]=e,this._currentContent[2]=t,this.player.videoContainer.updateLayout()}getLayoutStructure(e,t){if(!this._currentContent||this._currentContentId!==t){this._currentContentId=t;const{content:r}=this.validContent.find(a=>a.id===t);this._currentContent=r}const i=Wc(this._currentContent);return{player:this.player,name:{es:"Three streams with dynamic position"},hidden:!1,videos:i.videos,buttons:[{rect:i.buttons[0].rect,onClick:()=>{this.switchContent()},label:"Switch",icon:Gr,layer:2,ariaLabel:"Swap the position of the videos",title:"Swap the position of the videos"}]}}}class Yc extends _s{constructor(e,t){super("div",e,t),this.element.classList.add("image-canvas")}async loadCanvas(e){e.element.style.width="100%",e.element.style.height="100%"}}class zc extends Cs{get name(){return super.name||"es.upv.paella.audioCanvas"}get canvasType(){return"audio"}getCanvasInstance(e){return new Yc(this.player,e)}}class Yr extends _s{constructor(e,t){super("div",e,t)}async loadCanvas(e){e.element.style.width="100%",e.element.style.height="100%"}}class zr extends Cs{get name(){return super.name||"es.upv.paella.videoCanvas"}get canvasType(){return"video"}async isCompatible(e){return!Array.isArray(e.canvas)||e.canvas.length===0?!0:await super.isCompatible(e)}getCanvasInstance(e){return new Yr(this.player,e)}}class Ds extends Ye{get type(){return"data"}get context(){return this.config.context||[]}async read(){throw Error(`DataPlugin.read() not implemented in data plugin '${this.name}'`)}async write(){throw Error(`DataPlugin.write() not implemented in data plugin '${this.name}'`)}async remove(){throw Error(`DataPlugin.remove() not implemented in data plugin '${this.name}'`)}}class jr extends ut{constructor(e){super(e),this._dataPlugins={},Ae(this.player,"data",async t=>{var i;(i=t.context)==null||i.forEach(s=>{this._dataPlugins[s]=this._dataPlugins[s]||[],this._dataPlugins[s].push(t)})})}getDataPlugin(e){let t=this._dataPlugins[e]&&this._dataPlugins[e].length>0&&this._dataPlugins[e][0];if(t||(t=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default[0]),!t)throw Error(`No data plugin found for context '${e}'`);return t}getDataPlugins(e){let t=this._dataPlugins[e]&&this._dataPlugins[e].length>0&&this._dataPlugins[e];if(t||(t=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default),!t)throw Error(`No data plugin found for context '${e}'`);return t}async read(e,t){return await this.getDataPlugin(e).read(e,t)}async write(e,t,i){const s=this.getDataPlugins(e);if(Array.isArray(s)){let r=null;for(let a=0;a<s.length;++a)r=await s[a].write(e,t,i);return r}else{if(s)return await s.write(e,t,i);this.player.log.warn(`No such data plugin found for context '${e}'`)}}async remove(e,t){const i=this.getDataPlugins(e);if(i.length>1){let s=null;for(let r=0;r<i.length;++r)s=await i[r].remove(e,t);return s}else return await i.remove(e,t)}}let Ps=null;class hi extends Vt{static Get(){return Ps||(Ps=new hi),Ps}get moduleName(){return"paella-core default data plugins"}get moduleVersion(){return Ht.version}}class jc extends Ds{getPluginModuleInstance(){return hi.Get()}get name(){return super.name||"es.upv.paella.cookieDataPlugin"}serializeKey(e,t){return typeof t=="object"&&(t=JSON.stringify(t)),`${e}|${t}`}async read(e,t){const i=this.serializeKey(e,t);let s=tt(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`CookieDataPlugin.read: ${i}`),s}async write(e,t,i){const s=this.serializeKey(e,t);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`CookieDataPlugin.write: ${s}: invalid data object.`),i=""}dt(s,i),this.player.log.debug(`CookieDataPlugin.write: ${s}`)}async remove(e,t){const i=this.serializeKey(e,t);dt(i,""),this.player.log.debug(`CookieDataPlugin.remove: ${i}`)}}class qc extends Ds{getPluginModuleInstance(){return hi.Get()}get name(){return super.name||"es.upv.paella.localStorageDataPlugin"}serializeKey(e,t){return typeof t=="object"&&(t=JSON.stringify(t)),`${e}|${t}`}async read(e,t){const i=this.serializeKey(e,t);let s=localStorage.getItem(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`LocalStorageDataPlugin.read: ${i}`),s}async write(e,t,i){const s=this.serializeKey(e,t);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`LocalStorageDataPlugin.write: ${s}: invalid data object.`),i=""}localStorage.setItem(s,i),this.player.log.debug(`LocalStorageDataPlugin.write: ${s}`)}async remove(e,t){const i=this.serializeKey(e,t);localStorage.setItem(i,""),this.player.log.debug(`LocalStorageDataPlugin.remove: ${i}`)}}const Xc=[{plugin:ur,config:{enabled:!1}},{plugin:mr,config:{enabled:!1}},{plugin:tc,config:{enabled:!1}},{plugin:sc,config:{enabled:!1}},{plugin:vr,config:{enabled:!1}},{plugin:fr,config:{enabled:!1}},{plugin:Sr,config:{enabled:!1}},{plugin:Lr,config:{enabled:!1}},{plugin:Fr,config:{enabled:!1}},{plugin:Nr,config:{enabled:!1}},{plugin:ws,config:{enabled:!1}},{plugin:Vr,config:{enabled:!1}},{plugin:Vc,config:{enabled:!1}},{plugin:Kr,config:{enabled:!1}},{plugin:Hc,config:{enabled:!1}},{plugin:ws,config:{enabled:!1}},{plugin:Wr,config:{enabled:!1}},{plugin:zc,config:{enabled:!1}},{plugin:zr,config:{enabled:!1}},{plugin:jc,config:{enabled:!1,context:["default"]}},{plugin:qc,config:{enable:!0,context:["default"]}}];function Qc(){const n=["modal","timeline","no-modal"],e=()=>this.player.log.warn(`Invalid popUpType set in "${this.name}" plugin. Alowed types are "modal", "timeline" and "no-modal"`);return n.indexOf(this.config.popUpType)!==-1?this.config.popUpType:n.indexOf(this.popUpType)!==-1?(this.config.popUpType&&e(),this.popUpType):(e(),"modal")}class ui extends Es{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(e){this._refreshContent=e}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(){await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(e){this._parentPopUp=e}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var i,s;const e=((i=this.config.closeActions)==null?void 0:i.clickOutside)??!0,t=((s=this.config.closeActions)==null?void 0:s.closeButton)??!1;return{clickOutside:e,closeButton:t}}async getContent(){return j("<p>Pop Up Button Plugin Content</p>")}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.closeParentPopUp?Le.HideAllPopUps(!1):this._popUp&&this._popUp.hide()}async showPopUp(){const e=this.player.isFullscreen?this.player.containerElement:document.body;if(this._popUp)if(this.popUpType==="timeline"&&this._popUp.isVisible)this._popUp.hide();else if(this._popUp.isVisible)this._popUp.hide();else{if(this.refreshContent){const t=await this.getContent();this._popUp.setContent(t),this.refreshContent=!1}this._popUp.show(e,this._parentPopUp)}else{this._popUp=null;const t=Qc.apply(this);if(t==="modal"||t==="no-modal"){const{clickOutside:s,closeButton:r}=this.closeActions;this._popUp=new Le(this.player,e,this.button,this,t==="modal",this.moveable,this.resizeable,this.customPopUpClass),this._popUp.setCloseActions({clickOutside:s,closeButton:r})}else t==="timeline"&&(this._popUp=new Kt(this.player,this));const i=await this.getContent();this._popUp.title=this.menuTitle,this._popUp.setContent(i),this._popUp.show(e,this._parentPopUp),this.refreshContent=!1}}}class qr extends ui{async load(){this._iconPath&&(this.icon=await Wn(this._iconPath))}get groupName(){var e;return((e=this.config)==null?void 0:e.groupName)||"buttonGroup"}get popUpType(){return"no-modal"}getClosePopUps(){return!1}async getContent(){const e=j('<div class="button-group"></div>');return this._firstItem=null,this._initialized||(this.player.log.debug(`Load button plugins into "${this.groupName}" container`),await Ae(this.player,"button",async t=>{this.player.log.debug(` Button plugin: ${t.name}`);const i=j('<div class="button-plugin-wrapper"></div>',e);if(t instanceof ui&&(t.parentPopUp=this._popUp),await Wt(t,i),j(`<a class="button-description">${mt(t.description)}</a>`,i).addEventListener("click",r=>{t.action(),r.stopPropagation()}),!this._firstItem){const r=i.getElementsByTagName("button");this._firstItem=r&&r[0]}},async t=>t.parentContainer===this.groupName?await t.isEnabled():!1),this._initialized=!0),e}async showPopUp(){await super.showPopUp(),setTimeout(()=>{this._firstItem&&this._firstItem.focus()},50),this.buttons.forEach(e=>{e.style.display==="none"?this.hideButtonContainer(e):this.showButtonContainer(e)})}get buttons(){return Array.from(this.popUp.element.getElementsByClassName("button-plugin"))}hideButtonContainer(e){var i;const t=(i=e.parentNode)==null?void 0:i.parentNode;t&&(t.style.display="none")}showButtonContainer(e){var i;const t=(i=e.parentNode)==null?void 0:i.parentNode;t&&(t.style.display=null)}}const ks=(n,e,t,i={})=>{const s=new n(e,t);return t=s.name||t,t?(e.config.plugins&&e.config.plugins[t]&&Gt(i,e.config.plugins[t],!1),s._config=i,s):(e.log.warn(`The instance of the ${n.name} plugin cannot be created because it is being loaded explicitly and does not have the name property implemented.`),null)};function Fs(n,e,t,i,s=!1){const r=t.type;let a=-1;if(n.__pluginData__.pluginInstances[r]&&n.__pluginData__.pluginInstances[r].find((l,c)=>{if(l.name===t.name)return a=c,!0})&&!s){n.log.info(`Plugin ${t.name} of type ${r} already registered.`);return}n.__pluginData__.pluginClasses[e]=i,n.__pluginData__.pluginInstances[r]=n.__pluginData__.pluginInstances[r]||[],a!==-1&&n.__pluginData__.pluginInstances[r].splice(a,1),n.__pluginData__.pluginInstances[r].push(t),n.__pluginModules=n.__pluginModules||[];const o=t.getPluginModuleInstance();if(o&&(o._player=o._player||n,!n.__pluginModules.find(l=>l.constructor.name===o.constructor.name))){const l=o.moduleName,c=o.moduleVersion;n.log.debug(`Plugin module imported: ${l}: v${c}`),n.__pluginModules.push(o)}}function Zc(n,e){let t=null,i={enabled:!0};if(typeof e=="function"?t=e:typeof e=="object"&&typeof e.plugin=="function"&&(t=e.plugin,i=e.config),!t)n.log.warn("Error importing plugin with explicit import API. Check the 'plugins' array at init params");else{const s=ks(t,n,null,i);if(!s)n.log.warn(`Unable to create an instance of the plugin ${t.name}`);else{const r=s.constructor.name;Fs(n,r,s,t,!0)}}}function Jc(n,e){const t=n.config;e.keys().forEach(i=>{const s=e(i),r=i.substring(2,i.length-3);if(t.plugins[r]){const a=s.default,o=ks(a,n,r,{});Fs(n,i,o,a,!1)}else if(/^[a-z0-9]+$/i.test(r)){n.__pluginModules=n.__pluginModules||[];const a=s.default,o=new a(n);if(!n.__pluginModules.find(l=>l.constructor.name===o.constructor.name)){const l=o.moduleName,c=o.moduleVersion;n.log.debug(`Plugin module imported: ${l}: v${c}`),n.__pluginModules.push(o)}}})}function eh(n){const e=n.config;if(n.__pluginData__=n.__pluginData__||{pluginClasses:[],pluginInstances:{}},n.__pluginData__.pluginClasses.length!==0)return;[...Xc,...n.initParams.plugins].forEach(i=>{Zc(n,i)});const{buttonGroups:t}=e;t&&t.forEach((i,s)=>{const r=`button_group_${s}`,a=ks(qr,n,r,i);a._iconPath=We([n.configResourcesUrl,i.icon]),Fs(n,a.type,a,`ButtonGroupPlugin${s}`,!1)}),n.log.debug("Plugins have been registered:")}function th(n){delete n.__pluginData__}function Os(n,e){var t;return((t=n.__pluginData__)==null?void 0:t.pluginInstances[e])||[]}async function Ae(n,e,t=null,i=null){if(!n.__pluginData__.pluginInstances[e]){n.log.info(`There are no defined plugins of type '${e}'`);return}n.__pluginData__.pluginInstances[e].sort((s,r)=>s.order-r.order),n.__pluginData__.pluginInstances[e].forEach(s=>n.log.debug(`type: ${e}, name: ${s.name}`)),typeof i!="function"&&(i=async function(s){return await s.isEnabled()});for(const s in n.__pluginData__.pluginInstances[e]){const r=n.__pluginData__.pluginInstances[e][s];if(await i(r)){if(r.__uiPlugin){const o=await r.getDictionaries();if(typeof o=="object")for(const l in o){const c=o[l];n.addDictionary(l,c)}}typeof t=="function"&&await t(r),await r.load()}}}async function Xr(n,e){var t;(t=n.__pluginData__.pluginInstances[e])==null||t.forEach(async i=>{await i.unload()})}function Qr(n){var t;const e=(i,s)=>{if(!i)throw new Error(`Invalid video manifest: ${s}`)};e(n.streams,"missing 'streams' object."),e(n.streams.length>0,"the 'streams' array is empty."),e((t=n.metadata)==null?void 0:t.preview,"the 'metadata.preview' field is required.")}class ih extends ut{constructor(e,t){super(e,t),this._videoContainer=t,this._streamData=null,this._streams=null,this._players=[],this._mainAudioPlayer=null,this._streamSyncTimer=null,this._trimming={enabled:!1,start:100,end:200}}async load(e){this._streamData=e,this._streams={};let t=this.player.config.defaultAudioStream||"presenter";this._streamData.length===1&&(t=this._streamData[0].content),e.some(s=>{if(s.role==="mainAudio")return t=s.content,!0}),this.player.log.debug("Finding compatible video plugins"),await Oc(this.player);for(const s of this._streamData){const r=Nc(this.player,s);if(!r)throw Error(`Canvas plugin not found: ${s.canvas}`);const a=s.content===t,o=await ql(this.player,s);if(!o)throw Error(`Incompatible stream type: ${s.content}`);this._streams[s.content]={stream:s,isMainAudio:a,videoPlugin:o,canvasPlugin:r}}let i=null;for(const s in this._streams){const r=this._streams[s];r.canvas=await r.canvasPlugin.getCanvasInstance(this._videoContainer),r.player=await r.videoPlugin.getVideoInstance(r.canvas.element,r.isMainAudio),t===s?(this._mainAudioPlayer=r.player,r.player.initVolume(1)):r.player.initVolume(0),await r.player.load(r.stream,this),await r.canvas.loadCanvas(r.player),r.player.onVideoEnded(()=>{i===null&&(ht(this.player,F.ENDED),i=setTimeout(()=>{i=null},2e3))}),this._players.push(r.player)}if(this.mainAudioPlayer===null)throw this.player.log.error("The video stream containing the audio track could not be identified. The `role` attribute must be specified in the main video stream, or the `defaultAudioStream` attribute must be set correctly in the player configuration."),new Error("The video stream containing the audio track could not be identified.")}async unload(){this.stopStreamSync(),await Mc(this.player)}get players(){return this._players}get streamData(){return this._streamData}get streams(){return this._streams}get mainAudioPlayer(){return this._mainAudioPlayer}get isTrimEnabled(){var e,t,i;return((e=this._trimming)==null?void 0:e.enabled)&&((t=this._trimming)==null?void 0:t.end)>((i=this._trimming)==null?void 0:i.start)}get trimStart(){var e;return(e=this._trimming)==null?void 0:e.start}get trimEnd(){var e;return(e=this._trimming)==null?void 0:e.end}async setTrimming({enabled:e,start:t,end:i}){if(t>=i)throw Error(`Error setting trimming: start time (${t}) must be lower than end time ${i}`);this._trimming={enabled:e,start:t,end:i};const s=await this.currentTime();ht(this.player,F.TIMEUPDATE,{currentTime:e?t+s:s})}startStreamSync(){this._timeSync=!0;const e=async()=>{if(!this._players.length){this.player.log.warn("Player not yet loaded. Waiting for video sync.");return}let t=this.mainAudioPlayer.currentTimeSync;const i=.2;if(this.players.length>1)for(let s=0;s<this.players.length;++s){const r=this.players[s];if(r!==this.mainAudioPlayer){const a=r.currentTimeSync;Math.abs(t-a)>i&&(this.player.log.debug("Video synchronization triggered"),r.setCurrentTime(t))}}if(this.isTrimEnabled){let s=t-this.trimStart;if(this.trimEnd<=t){await this.executeAction("pause"),await this.setCurrentTime(0),this.stopStreamSync(),t=0,ht(this.player,F.ENDED,{});return}else t<this.trimStart&&(await this.setCurrentTime(0),t=this.trimStart,s=0);ht(this.player,F.TIMEUPDATE,{currentTime:s}),this._timeupdateTimer=setTimeout(()=>{this._timeSync&&e()},250)}else this._timeSync&&(ht(this.player,F.TIMEUPDATE,{currentTime:t}),this._timeupdateTimer=setTimeout(()=>{e()},250))};e()}stopStreamSync(){this._timeSync=!1,this._timeupdateTimer&&clearTimeout(this._timeupdateTimer)}executeAction(e,t=[]){return Array.isArray(t)||(t=[t]),new Promise(i=>{let s=[],r=[];this.players.forEach(a=>{r.push(new Promise(o=>{a[e](...t).then(l=>{s.push(l),o()})}))}),Promise.allSettled(r).then(()=>i(s))})}get isLiveStream(){return this._streamData.some(e=>Array.from(Object.keys(e.sources)).indexOf("hlsLive")!==-1)}async play(){return this.startStreamSync(),await this.executeAction("play")}async pause(){return this.stopStreamSync(),await this.executeAction("pause")}async stop(){this.stopStreamSync(),await this.executeAction("pause"),await this.executeAction("setCurrentTime",0)}async paused(){return(await this.executeAction("paused"))[0]}async setCurrentTime(e){const t=await this.duration();e<0?e=0:e>t&&(e=t);const i=(await this.executeAction("currentTime"))[0];let s=null;if(this.isTrimEnabled){e=e+this.trimStart,e=e>=this.trimEnd?this.trimEnd:e;const a=(await this.executeAction("setCurrentTime",[e]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i-this.trimStart,newTime:o-this.trimStart}}else{const a=(await this.executeAction("setCurrentTime",[e]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i,newTime:o}}const r=await this.currentTime();return ht(this.player,F.TIMEUPDATE,{currentTime:r}),s}async currentTime(){const e=await this.mainAudioPlayer.currentTime();return this.isTrimEnabled?e-this.trimStart:e}async currentTimeIgnoringTrimming(){return await this.mainAudioPlayer.currentTime()}async volume(){return this.mainAudioPlayer?await this.mainAudioPlayer.volume():(await this.executeAction("volume"))[0]}async setVolume(e){return this.mainAudioPlayer?await this.mainAudioPlayer.setVolume(e):(await this.executeAction("setVolume",[e]))[0]}async duration(){return this.isTrimEnabled?this.trimEnd-this.trimStart:(await this.executeAction("duration"))[0]}async durationIgnoringTrimming(){return(await this.executeAction("duration"))[0]}async playbackRate(){return(await this.executeAction("playbackRate"))[0]}async setPlaybackRate(e){return(await this.executeAction("setPlaybackRate",[e]))[0]}async getQualityReferencePlayer(){let e=null,t=[];if(Object.keys(this.streams).length>0)for(const i in this.streams){const s=this.streams[i],r=await s.player.getQualities()||[];!e&&r.length>t.length&&(t=r,e=s.player)}return e||this.mainAudioPlayer}async getCurrentQuality(){return(await this.getQualityReferencePlayer()).currentQuality}async getQualities(){return await(await this.getQualityReferencePlayer()).getQualities()}async setQuality(e){const i=await(await this.getQualityReferencePlayer()).getQualities(),s=i.length;let r=-1;if(i.some((a,o)=>(e.index===a.index&&(r=o),r!==-1)),r>=0){const a=r/s;for(const o in this.streams){const l=this.streams[o],c=await l.player.getQualities()||[];if(this.player.log.debug(c),c.length>1){const h=Math.round(c.length*a),u=c[h];await l.player.setQuality(u)}}}}async supportsMultiaudio(){return this.mainAudioPlayer.supportsMultiaudio()}async getAudioTracks(){return this.mainAudioPlayer.getAudioTracks()}async setCurrentAudioTrack(e){return this.mainAudioPlayer.setCurrentAudioTrack(e)}get currentAudioTrack(){return this.mainAudioPlayer.currentAudioTrack}}function sh(n,e){return Array.isArray[e]||(e=[e]),jl(n,e).getManifestData(e)}async function nh(n){return{w:1280,h:720}}async function Zr(n){var e;for(const t in this.streamProvider.streams){const i=((e=n==null?void 0:n.videos)==null?void 0:e.find(r=>r.content===t))!=null,s=this.streamProvider.streams[t];i&&!s.player.isEnabled?await s.player.enable():!i&&s.player.isEnabled&&await s.player.disable()}}function Jr(){for(const n in this.streamProvider.streams){const e=this.streamProvider.streams[n];e.canvas.element.style.display="none",this._hiddenVideos.appendChild(e.canvas.element)}}async function rh(){var c,h;const n=$r(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await Zr.apply(this,[n]),Jr.apply(this);const e=await nh(this.player),t=this.elementSize,i=100/e.w,s=100/e.h,r=t.w/t.h,a=e.w/e.h,o=r>a?{w:t.h*a,h:t.h}:{w:t.w,h:t.w/a};if(this.baseVideoRect.style.width=o.w+"px",this.baseVideoRect.style.height=o.h+"px",this.baseVideoRect.classList.remove("dynamic"),(c=n==null?void 0:n.videos)!=null&&c.length){const u=[];for(const d of n.videos){const g=this.streamProvider.streams[d.content],{stream:f,player:m,canvas:p}=g,v=await m.getDimensions(),E=v.w/v.h;let T=Number.MAX_VALUE,_=null;p.buttonsArea.innerHTML="",u.push(await xs(this.player,n,p,d,d.content)),d.rect.forEach(S=>{const A=/^(\d+.?\d*)\/(\d+.?\d*)$/.exec(S.aspectRatio),b=A?Number(A[1])/Number(A[2]):1,D=Math.abs(E-b);D<T&&(_=S,T=D)}),p.element.style.display="block",p.element.style.position="absolute",p.element.style.left=`${(_==null?void 0:_.left)*i}%`,p.element.style.top=`${(_==null?void 0:_.top)*s}%`,p.element.style.width=`${(_==null?void 0:_.width)*i}%`,p.element.style.height=`${(_==null?void 0:_.height)*s}%`,p.element.style.zIndex=d.layer,this.baseVideoRect.appendChild(p.element)}setTimeout(()=>{Ls(this.player,n,u.flat())},100)}const l=this.baseVideoRect.getElementsByClassName("video-layout-button");return Array.from(l).forEach(u=>this.baseVideoRect.removeChild(u)),(h=n==null?void 0:n.buttons)==null||h.forEach(u=>{const d=Wi({tag:"button",attributes:{class:"video-layout-button","aria-label":mt(u.ariaLabel),title:mt(u.title),style:`
                    left: ${u.rect.left*i}%;
                    top: ${u.rect.top*s}%;
                    width: ${u.rect.width*i}%;
                    height: ${u.rect.height*s}%;
                    z-index: ${u.layer};
                `},parent:this.baseVideoRect,children:u.icon});d.layout=n,d.buttonAction=u.onClick,d.addEventListener("click",async g=>{X(this.player,F.BUTTON_PRESS,{plugin:n.plugin,layoutStructure:n}),await g.target.buttonAction.apply(g.target.layout),g.stopPropagation()}),this._layoutButtons.push(d)}),!0}async function ah(){var a,o,l,c,h,u;const n=$r(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await Zr.apply(this,[n]),Jr.apply(this),this.baseVideoRect.style.width="",this.baseVideoRect.style.height="",this.baseVideoRect.style.display="flex",this.baseVideoRect.classList.add("dynamic"),this.baseVideoRect.innerHTML="";const e=this.element.clientWidth,t=this.element.clientHeight,i=e>t;if(this.baseVideoRect.classList.remove("align-center"),this.baseVideoRect.classList.remove("align-top"),this.baseVideoRect.classList.remove("align-bottom"),this.baseVideoRect.classList.remove("align-left"),this.baseVideoRect.classList.remove("align-right"),i){const d=((o=(a=this.player.config.videoContainer)==null?void 0:a.dynamicLayout)==null?void 0:o.landscapeVerticalAlignment)||"align-center";this.baseVideoRect.classList.remove("portrait"),this.baseVideoRect.classList.add("landscape"),this.baseVideoRect.classList.add(d)}else{const d=((c=(l=this.player.config.videoContainer)==null?void 0:l.dynamicLayout)==null?void 0:c.portraitHorizontalAlignment)||"align-center";this.baseVideoRect.classList.add("portrait"),this.baseVideoRect.classList.remove("landscape"),this.baseVideoRect.classList.add(d)}const s=this.baseVideoRect.clientWidth,r=this.element.clientHeight;if(((h=n==null?void 0:n.videos)==null?void 0:h.length)===1){const d=[],g=[],f=n.videos[0],m=this.streamProvider.streams[f.content],{player:p,canvas:v}=m;v.buttonsArea.innerHTML="",g.push(await xs(this.player,n,v,f,f.content)),v.element.style={},v.element.style.display="block",v.element.style.width="100%",v.element.style.height="100%",v.element.style.overflow="hidden",v.element.style.position="relative",d.push(v.element),v.element.sortIndex=0,d.forEach(E=>this.baseVideoRect.appendChild(E)),setTimeout(()=>{Ls(this.player,n,g.flat())},100)}else if((u=n==null?void 0:n.videos)!=null&&u.length){let d=0;const g=[],f=[];for(const m of n.videos){const p=this.streamProvider.streams[m.content],{player:v,canvas:E}=p,T=await v.getDimensions(),_=T.w/T.h,S=s,A=r,b=(i?S:A)*m.size/100;let D=Math.round(i?b:b*_),k=Math.round(i?b/_:b);D>S&&(D=S,k=Math.round(D/_)),k>A&&(k=A,D=Math.round(k*_)),E.buttonsArea.innerHTML="",f.push(await xs(this.player,n,E,m,m.content)),E.element.style={},E.element.style.display="block",E.element.style.width=`${D}px`,E.element.style.height=`${k}px`,E.element.style.overflow="hidden",E.element.style.position="relative",E.element.sortIndex=d++,g.push(E.element)}if(i){const m=j('<div class="landscape-container"></div>',this.baseVideoRect);g.forEach(p=>m.appendChild(p))}else g.forEach(m=>this.baseVideoRect.appendChild(m));setTimeout(()=>{Ls(this.player,n,f.flat())},100)}return!0}class oh extends be{constructor(e,t){var a;const i="base-video-rect",s={class:"video-container"};(a=e.config.videoContainer)!=null&&a.overPlaybackBar&&(s.class+=" over-playback-bar");const r=`
            <div class="${i}"></div>
            <div class="hidden-videos-container" style="display: none"></div>
        `;super(e,{attributes:s,children:r,parent:t}),this._hiddenVideos=this.element.getElementsByClassName("hidden-videos-container")[0],this._baseVideoRect=this.element.getElementsByClassName(i)[0],this.element.addEventListener("click",async()=>{await this.paused()?await this.play():await this.pause()}),this._ready=!1,this._players=[],this._streamProvider=new ih(this.player,this.baseVideoRect)}get layoutId(){return this._layoutId}get mainLayoutContent(){return this._mainLayoutContent}async setLayout(e,t=null){var i,s;if(this.validContentIds.indexOf(e)===-1)return!1;{const r=(s=(i=this.player.config.videoContainer)==null?void 0:i.restoreVideoLayout)==null?void 0:s.global;await this.player.preferences.set("videoLayout",e,{global:r}),await this.player.preferences.set("videoLayoutMainContent",t,{global:r});const a=this._layoutId;this._layoutId=e,this._mainLayoutContent=t,await this.updateLayout(),a!==e&&X(this.player,F.LAYOUT_CHANGED,{prevLayout:a,layoutId:e})}}get validContentIds(){return this._validContentIds}get validContentSettings(){return this._validContentSettings}get validLayouts(){return li(this.player,this.streamData)}get streamData(){return this._streamData}get baseVideoRect(){return this._baseVideoRect}get streamProvider(){return this._streamProvider}async create(){this._baseVideoRect.style.display="none",await Ae(this.player,"layout"),await Yl(this.player)}async load(e){var o,l,c,h,u,d,g,f,m,p;if(this._streamData=e,(l=(o=this.player.config.videoContainer)==null?void 0:o.restoreVideoLayout)!=null&&l.enabled){const v=(h=(c=this.player.config.videoContainer)==null?void 0:c.restoreVideoLayout)==null?void 0:h.global;this._layoutId=await this.player.preferences.get("videoLayout",{global:v})||this.player.config.defaultLayout,this._mainLayoutContent=await this.player.preferences.get("videoLayoutMainContent",{global:v})||null}else this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null;await this.streamProvider.load(e),this._validContentIds=Ur(this.player,e),this._validContentSettings=Dc(this.player,e),await this.updateLayout(null,!0);const t=j('<div class="button-plugins left-side"></div>',this.element),i=j('<div class="button-plugins right-side"></div>',this.element);this._buttonPlugins=[t,i],this.player.log.debug("Loading videoContainer button plugins"),await Ae(this.player,"button",async v=>{this.player.log.debug(` Button plugin: ${v.name}`),v.side==="left"?await Wt(v,t):v.side==="right"&&await Wt(v,i)},async v=>v.parentContainer==="videoContainer"?await v.isEnabled():!1),this._baseVideoRect.style.display="";const s=await this.player.preferences.get("volume",{global:!0}),r=await this.player.preferences.get("playbackRate",{global:!0}),a=await this.player.preferences.get("lastKnownTime",{global:!1});if((u=this.player.config.videoContainer)!=null&&u.restoreVolume&&s!==null&&s!==void 0&&await this.streamProvider.setVolume(s),(d=this.player.config.videoContainer)!=null&&d.restorePlaybackRate&&r!==null&&r!==void 0&&await this.streamProvider.setPlaybackRate(r),this.player.videoManifest.trimming&&await this.player.videoContainer.setTrimming(this.player.videoManifest.trimming),(f=(g=this.player.config.videoContainer)==null?void 0:g.restoreLastTime)!=null&&f.enabled&&!this.streamProvider.isLiveStream){const v=async()=>{if(!await this.paused()){const T=await this.currentTime();await this.player.preferences.set("lastKnownTime",T,{global:!1})}setTimeout(v,1e3)};if(a){const E=await this.player.preferences.get("lastKnownTime",{global:!1}),T=await this.duration(),_=(p=(m=this.player.config.videoContainer)==null?void 0:m.restoreLastTime)==null?void 0:p.remainingSeconds;T-E>_&&await this.setCurrentTime(E)}v()}this._messageContainer=new hc(this.player,this.element),this._ready=!0}async unload(){this.removeFromParent(),await Xr(this.player,"layout"),await zl(this.player),await this.streamProvider.unload()}async updateLayout(e=null){const t=arguments[1];if(e&&(this._mainLayoutContent=e),!t&&this.player.state!==z.LOADED)return;if(this._updateInProgress)return this.player.log.warn("Recursive update layout detected"),!1;this._updateInProgress=!0;let i=!0;this._layoutButtons=[],(!this._layoutId||this._validContentIds.indexOf(this._layoutId)===-1)&&(this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null,this._validContentIds.indexOf(this._layoutId)===-1&&(this._layoutId=this._validContentIds[0]),i=!1);const s=Br(this.player,this.streamProvider.streamData,this._layoutId);return s.layoutType==="static"?i=rh.apply(this):s.layoutType==="dynamic"&&(i=ah.apply(this)),this._updateInProgress=!1,i}hideUserInterface(){if(this._layoutButtons&&this._buttonPlugins){this.player.log.debug("Hide video container user interface");const e=t=>{t._prevDisplay=t.style.display,t.style.display="none"};this._layoutButtons.forEach(e),this._buttonPlugins.forEach(e);for(const t in this.streamProvider.streams)this.streamProvider.streams[t].canvas.hideButtons()}}showUserInterface(){if(this._layoutButtons&&this._buttonPlugins){const e=t=>t.style.display=t._prevDisplay||"block";this._layoutButtons.forEach(e),this._buttonPlugins.forEach(e);for(const t in this.streamProvider.streams)this.streamProvider.streams[t].canvas.showButtons()}}get message(){return this._messageContainer}get elementSize(){return{w:this.element.offsetWidth,h:this.element.offsetHeight}}get ready(){return this._ready}get isLiveStream(){return this.streamProvider.isLiveStream}async play(){const e=await this.streamProvider.play();return X(this.player,F.PLAY),e}async pause(){const e=await this.streamProvider.pause();return X(this.player,F.PAUSE),e}async stop(){this.streamProvider.stop(),X(this.player,F.STOP)}async paused(){return this.streamProvider.paused()}async setCurrentTime(e){const t=await this.streamProvider.setCurrentTime(e);return X(this.player,F.SEEK,{prevTime:t.prevTime,newTime:t.newTime}),t.result}async currentTime(){return this.streamProvider.currentTime()}async volume(){return this.streamProvider.volume()}async setVolume(e){const t=await this.streamProvider.setVolume(e);return X(this.player,F.VOLUME_CHANGED,{volume:e}),await this.player.preferences.set("volume",e,{global:!0}),t}async duration(){return await this.streamProvider.duration()}async playbackRate(){return await this.streamProvider.playbackRate()}async setPlaybackRate(e){const t=await this.streamProvider.setPlaybackRate(e);return X(this.player,F.PLAYBACK_RATE_CHANGED,{newPlaybackRate:e}),await this.player.preferences.set("playbackRate",e,{global:!0}),t}get isTrimEnabled(){return this.streamProvider.isTrimEnabled}get trimStart(){return this.streamProvider.trimStart}get trimEnd(){return this.streamProvider.trimEnd}async setTrimming({enabled:e,start:t,end:i}){const s=await this.streamProvider.setTrimming({enabled:e,start:t,end:i});return X(this.player,F.TRIMMING_CHANGED,{enabled:e,start:t,end:i}),s}getVideoRect(e=null){var i;let t=this.baseVideoRect;return typeof e=="string"&&(t=(i=this.streamProvider.streams[e])==null?void 0:i.canvas.element),{x:t==null?void 0:t.offsetLeft,y:t==null?void 0:t.offsetTop,width:t==null?void 0:t.offsetWidth,height:t==null?void 0:t.offsetHeight,element:t}}appendChild(e,t=null,i=1){if(t){const{width:s,height:r}=this.getVideoRect();t.x=t.x*100/s,t.width=t.width*100/s,t.y=t.y*100/r,t.height=t.height*100/r,e.style.position="absolute",e.style.left=`${t.x}%`,e.style.top=`${t.y}%`,e.style.width=`${t.width}%`,e.style.height=`${t.height}%`,i!==null&&(e.style.zIndex=i)}return this.baseVideoRect.appendChild(e),e}removeChild(e){this.baseVideoRect.removeChild(e)}}const lh=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 300 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <rect id="Play" x="0" y="0" width="300" height="300" style="fill:none;"/>
    <g id="Play1" serif:id="Play">
        <g transform="matrix(1.21457,0,0,1.21457,-55.8704,-35.2227)">
            <circle cx="169.5" cy="152.5" r="123.5" style="fill:rgb(128,128,128);"/>
            <path d="M169.5,29C237.662,29 293,84.338 293,152.5C293,220.662 237.662,276 169.5,276C101.338,276 46,220.662 46,152.5C46,84.338 101.338,29 169.5,29ZM169.5,37.233C233.117,37.233 284.767,88.883 284.767,152.5C284.767,216.117 233.117,267.767 169.5,267.767C105.883,267.767 54.233,216.117 54.233,152.5C54.233,88.883 105.883,37.233 169.5,37.233Z" style="fill:rgb(235,235,235);"/>
        </g>
        <g transform="matrix(6.12323e-17,1,-1,6.12323e-17,347,-59)">
            <path d="M209,82L317,253L101,253L209,82Z" style="fill:rgb(235,235,235);"/>
        </g>
    </g>
</svg>
`,ch=`
    background-color: #e4e4e4;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: absolute;
    top: 50%;
    transform: translateY(-50%); 
`,Ms=`
    width: 100%;
`,hh=`
    position: absolute; 
    top: 0px; 
    left: 0px; 
    right: 0px; 
    bottom: 0px; 
    display: flex;
    align-content: center;
    justify-content: center;
    align-items: center;
`,uh=`
    pointer-events: none;
    width: 20%;
    max-width: 400px;
    min-width: 100px;
    opacity: 0.6;
`,dh=`
    display: block;
    width: 20%;
    background: none;
    border: none;
    cursor: pointer;
`;class fh extends be{constructor(e,t,i,s){const r={class:"preview-container",style:ch,role:"button","aria-label":"Play video"};super(e,{attributes:r,parent:t}),this._img=j(`
        <div style="${Ms}">
            ${i?`<img style="${Ms}" src="${i}" class="preview-image-landscape" alt=""/>`:""}
            ${s?`<img style="${Ms}" src="${s}" class="preview-image-portrait" alt=""/>`:""}
            <div style="${hh}">
                <button style="${dh}" role="button" aria-label="Play video">
                    <i class="preview-play-icon" style="${uh}">${lh}</i>
                </button>
            </div>
        </div>
        `,this.element),this.element.setAttribute("id","playerContainerClickArea"),this.element.addEventListener("click",l=>{e.play()});const a=i&&s,o=()=>{if(a){const l=this.element.clientWidth/this.element.clientHeight,c=Array.from(this.element.getElementsByClassName("preview-image-landscape")),h=Array.from(this.element.getElementsByClassName("preview-image-portrait"));l>=1?(c.forEach(u=>u.style.display=""),h.forEach(u=>u.style.display="none")):(c.forEach(u=>u.style.display="none"),h.forEach(u=>u.style.display=""))}};window.addEventListener("resize",()=>{o()}),o()}loadBackgroundImage(e){this._img.setAttribute("src",e)}}function ea({container:n,duration:e=1e3,currentTime:t=0,precision:i=100}){n.classList.add("progress-indicator"),n.innerHTML=`
        <div class="range-container">
            <div class="elapsed"></div>
            <div class="remaining"></div>
            <ul class="markers-container"></ul>
            <input type="range" min="0" max="${e*i}" value="${t*i}" class="slider">
        </div>
    `;const s=n.querySelector(".elapsed"),r=n.querySelector(".remaining"),a=n.querySelector(".slider");let o=!1,l=null;const c={elapsed:s,remaining:r,range:a,markersContainer:n.querySelector(".markers-container"),addMarker({time:h,duration:u}){const d=document.createElement("li");d.style.left=`${h/u*100}%`,this.markersContainer.appendChild(d)},updateRemaining(){const h=this.range.value/this.range.max*100;this.elapsed.style.width=`${h}%`,this.remaining.style.width=`${100-h}%`},setDuration(h){o||(this.range.max=h*i,this.updateRemaining())},setCurrentTime(h){o||(this.range.value=h*i,this.updateRemaining())},onChange(h){l=h}};return a.addEventListener("pointerdown",()=>{o=!0}),a.addEventListener("pointerup",()=>{o=!1,typeof l=="function"&&l(a.value/i)}),a.addEventListener("input",()=>{c.updateRemaining()}),c.updateRemaining(),c}class gh extends be{constructor(e,t){var r;const i=((r=e.config.progressIndicator)==null?void 0:r.inlineMode)??!1,s={class:"playback-bar"};super(e,{attributes:s,parent:t}),this.element.addEventListener("mouseenter",()=>Xn(e)),this.element.addEventListener("mouseleave",()=>Qn(e)),this._topContainer=j("<div></div>"),this._navContainer=j("<nav></nav>"),this._buttonPluginsLeft=j("<ul></ul>",this._navContainer),this._centerContainer=j("<div></div>",this._navContainer),this._buttonPluginsRight=j("<ul></ul>",this._navContainer),i?this._progressIndicator=ea({container:this._centerContainer}):(this.element.appendChild(this._topContainer),this._progressIndicator=ea({container:this._topContainer})),this._progressIndicator.onChange(async a=>{await e.videoContainer.setCurrentTime(a)}),this.element.appendChild(this._navContainer),this.element.addEventListener("click",()=>{Le.HideAllPopUps(!1)}),this._enabled=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._enabled?this.showUserInterface():this.hide()}async load(){this._enabledPlugins=[],this.player.log.debug("Loading button plugins"),await Ae(this.player,"button",async t=>{this.player.log.debug(` Button plugin: ${t.name}`),this._enabledPlugins.push(t),t.side==="left"?await Wt(t,this.buttonPluginsLeft):t.side==="right"&&await Wt(t,this.buttonPluginsRight)},async t=>t.parentContainer==="playbackBar"?await t.isEnabled():!1);const e=await this.player.videoContainer.duration();this._progressIndicator.setDuration(e),this.player.frameList.frames.forEach(t=>{this._progressIndicator.addMarker({time:t.time,duration:e})}),this.player.bindEvent([this.player.Events.TIMEUPDATE,this.player.Events.SEEK],t=>{this._progressIndicator.setCurrentTime(t.newTime??t.currentTime)}),this.player.bindEvent(this.player.Events.TRIMMING_CHANGED,async t=>{const i=t.end-t.start;this._progressIndicator.setDuration(i);const s=await this.player.videoContainer.currentTime();this._progressIndicator.setCurrentTime(s)}),this.onResize()}async unload(){this.removeFromParent(),await Xr(this.player,"button"),this._buttonPluginsLeft.innerHTML="",this._buttonPluginsRight.innerHTML=""}hideUserInterface(){this.player.log.debug("Hide playback bar user interface"),this.hide()}showUserInterface(){var e;if(this._enabled){const i=((e=this.player.config.progressIndicator)==null?void 0:e.inlineMode)??!1?"flex":"block";this.show(i),this.onResize()}}get buttonPluginsRight(){return this._buttonPluginsRight}get buttonPluginsLeft(){return this._buttonPluginsLeft}get timerContainer(){return this._timerContainer}get progressIndicator(){return this._progressIndicator}get containerSize(){const e=this.element.clientWidth,t=this.element.clientHeight;return{width:e,height:t}}onResize(){const{containerSize:e}=this;this._enabledPlugins.forEach(t=>t.onResize(e))}}const ta=[{maxWidth:400,className:"size-s"},{maxWidth:600,className:"size-m"},{maxWidth:900,className:"size-l"},{maxWidth:1100,className:"size-xl"},{className:"size-xxl"}],mh=n=>ta.find(e=>e.maxWidth&&e.maxWidth>=n||e.maxWidth===void 0).className;class ph extends be{constructor(e,t){const i={class:"captions-canvas visible-ui"};super(e,{tag:"div",attributes:i,parent:t}),this._captionsContainer=j(`
            <div class="text-container">
            </div>
        `,this.element),this._captions=[],this.hide(),this._currentCaptions=null;const s=async r=>{const o=(e.videoContainer.isTrimEnabled?e.videoContainer.trimStart:0)+(r.currentTime||r.newTime||0);if(this._currentCaptions){const l=this._currentCaptions.getCue(o);this._captionsContainer.innerHTML="",l&&l.captions.forEach(c=>{this._captionsContainer.innerHTML+=c,this._captionsContainer.innerHTML+="<br/>"}),l?this._captionsContainer.style.display=null:this._captionsContainer.style.display="none",this.resize()}};ie(this.player,F.TIMEUPDATE,s),ie(this.player,F.SEEK,s),ie(this.player,F.RESIZE,()=>this.resize()),ie(this.player,F.SHOW_UI,()=>this.element.classList.add("visible-ui")),ie(this.player,F.HIDE_UI,()=>this.element.classList.remove("visible-ui"))}async load(){await mc(this.player)}unload(){}resize(){const e=mh(this._captionsContainer.clientWidth);ta.forEach(t=>this.element.classList.remove(t.className)),this.element.classList.add(e)}addCaptions(e){this._captions.push(e),X(this.player,F.CAPTIONS_CHANGED,{captions:this._captions})}get captions(){return this._captions}get currentCaptions(){return this._currentCaptions}getCaptions({label:e,index:t,lang:i}){if(e===void 0&&t===void 0&&i===void 0)throw Error("Could not find captions: you must specify the label, the index or the language");return t!==void 0?this._captions[t]:this._captions.find(s=>{if(e!==void 0)return s.label===e;if(i!==void 0)return s.language===i})}enableCaptions(e){const t=this.getCaptions(e);if(t!==this._currentCaptions&&(this._currentCaptions=t,this.currentCaptions)){const{language:i,label:s}=this.currentCaptions;X(this.player,F.CAPTIONS_ENABLED,{language:i,label:s})}this.show()}disableCaptions(){this.currentCaptions&&X(this.player,F.CAPTIONS_DISABLED),this._currentCaptions=null,this.hide()}}async function yh(n){await Ae(n,"eventLog",async e=>{e.events.forEach(t=>{ie(n,t,async i=>{await e.onEvent(t,i)})})})}async function vh(n){}class Eh extends Ye{get type(){return"eventLog"}get events(){return[]}async onEvent(e,t){this.player.log.warn(`${this.name}: onEvent() function is not overwritten.`)}}const Ns=n=>!1,Us=n=>n.description;class Th{constructor(e,t){this._player=e,this._cookieConsentData=e.config.cookieConsent||[],this._getConsentCallback=t.getConsent||Ns,this._getDescriptionCallback=t.getDescription||Us,this._cookieConsentData.forEach(i=>{i.description=this._getDescriptionCallback(i)}),this.updateConsentData()}updateConsentData(){this._cookieConsentData.forEach(e=>{e.value=this._getConsentCallback(e.type)||e.required}),X(this._player,F.COOKIE_CONSENT_CHANGED,{cookieConsent:this})}getConsentForType(e){const t=this._cookieConsentData.find(i=>i.type===e);return(t==null?void 0:t.value)||!1}}const ce=Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5});let ia=ce.INFO;const sa=(n,e=null)=>{const t=typeof n=="string"?ce[n.toUpperCase()]:n;if(t<ce.DISABLED||t>ce.VERBOSE)throw Error(`setLogLevel: invalid log level ${t}`);e?(e.__logSettings=e.__logSettings||{},e.__logSettings.logLevel=t):ia=t},na=(n=null)=>n?n.__logSettings.logLevel:ia,jt=({msg:n,level:e=ce.INFO,player:t=null,context:i="paella-core"})=>{t&&!t.__logSettings&&sa(t,ce.INFO);const s=na(t);if(e<ce.DISABLED)throw Error(`printMessage: invalid log level ${e}`);if(t&&X(t,F.LOG,{severity:e,context:i,message:n,currentLogLevel:s}),e<=s)switch(e){case ce.ERROR:console.error(`${i} - Error: ${n}`);break;case ce.WARN:console.warn(`${i} - Warning: ${n}`);break;case ce.INFO:console.info(`${i} - Info: ${n}`);break;case ce.DEBUG:console.debug(`${i} - Debug: ${n}`);break;case ce.VERBOSE:console.log(`${i} - Verbose: ${n}`);break}},nt={setLevel:(n,e=null)=>{sa(n,e)},currentLevel:(n=null)=>na(n),error:(n,e=null,t="paella-core")=>{jt({msg:n,level:ce.ERROR,player:e,context:t})},warn:(n,e=null,t="paella-core")=>{jt({msg:n,level:ce.WARN,player:e,context:t})},info:(n,e=null,t="paella-core")=>{jt({msg:n,level:ce.INFO,player:e,context:t})},debug:(n,e=null,t="paella-core")=>{jt({msg:n,level:ce.DEBUG,player:e,context:t})},verbose:(n,e=null,t="paella-core")=>{jt({msg:n,level:ce.VERBOSE,player:e,context:t})}};class ra{constructor(e,t="paella-core"){this._player=e,this._context=t}get context(){return this._context}get player(){return this._player}setLevel(e){nt.setLevel(e,this._player)}currentLevel(){return nt.currentLevel(this._player)}error(e,t=null){nt.error(e,this._player,t||this._context)}warn(e,t=null){nt.warn(e,this._player,t||this._context)}info(e,t=null){nt.info(e,this._player,t||this._context)}debug(e,t=null){nt.debug(e,this._player,t||this._context)}verbose(e,t=null){nt.verbose(e,this._player,t||this._context)}}const aa={},Bs='{ "global": {}, "videos": {} }';async function oa(){switch(this.source.name){case"cookie":try{return JSON.parse(tt("preferences"))}catch{return JSON.parse(Bs)}case"dataPlugin":try{return await this.player.data.read(this.source.context,{})||JSON.parse(Bs)}catch{return JSON.parse(Bs)}}}async function Sh(n){switch(this.source.name){case"cookie":er(this.player,this.source.consentType,"preferences",JSON.stringify(n));break;case"dataPlugin":await this.player.data.write(this.source.context,{},n);break}}class xh extends ut{constructor(e){super(e);const{currentSource:t,sources:i}=e.config.preferences||{currentSource:"cookie",sources:{cookie:{consentType:"necessary"}}};if(this.source=i[t],this.source.name=t,this._loaded=!1,!this.source)throw Error("Invalid configuration in preferences. Check the configuration file.")}async set(e,t,{global:i=!1}={}){const s=await oa.apply(this);i?s.global[e]=t:(s.videos[this.player.videoId]=s.videos[this.player.videoId]||{},s.videos[this.player.videoId][e]=t),await Sh.apply(this,[s])}async get(e,{global:t=!1}={}){const i=await oa.apply(this);return t?i.global[e]:i.videos[this.player.videoId]&&i.videos[this.player.videoId][e]||void 0}}function Lh(n){var e;(e=this._skinData)!=null&&e.configOverrides&&Gt(n,this._skinData.configOverrides)}async function _h(){var n;if((n=this._skinData)!=null&&n.styleSheets){const e=[];this._skinData.styleSheets.forEach(t=>{if(!/\{.*/.test(t))if(this._externalResourcesAllowed){const i=We([this._skinUrl,t]);e.push(new Promise(async s=>{await Xi(i,!1),s()}))}else throw new Error("No external resources allowed loading skin object")}),await Promise.allSettled(e)}}async function Ch(){var n;if(this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],(n=this._skinData)!=null&&n.styleSheets){const e=[];this._skinData.styleSheets.forEach(t=>{if(/\{.*/.test(t))e.push(new Promise(i=>{const s=document.createElement("style");s.innerHTML=t,this.player.__skinStyleSheets__.push(s),document.head.appendChild(s),i()}));else{const i=We([this._skinUrl,t]);e.push(new Promise(async s=>{const r=await Xi(i);this.player.__skinStyleSheets__.push(r),s()}))}}),await Promise.allSettled(e)}}function la(){this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],this.player.__skinStyleSheets__.forEach(n=>{tr(n)}),this.player.__skinStyleSheets__=[]}async function bh(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:e,identifier:t,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")s();else if(this._externalResourcesAllowed){const o=We([this._skinUrl,i]);(await fetch(o)).ok?s():r(new Error(`Skin icon not found at URL '${o}'`))}else throw new Error("No external resources allowed loading skin object")})))}async function Ah(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:e,identifier:t,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")this.player.addCustomPluginIcon(e,t,i),s();else{const o=We([this._skinUrl,i]),l=await fetch(o);if(l.ok){const c=await l.text();this.player.addCustomPluginIcon(e,t,c),s()}else r(new Error(`Skin icon not found at URL '${o}'`))}})))}class wh{constructor(e){this._player=e}get player(){return this._player}async loadSkin(e){if(typeof e=="string"){this._skinUrl=Yi(e),this._externalResourcesAllowed=!0;const t=await fetch(e);if(!t.ok)throw new Error(`Error loading skin from URL ${e}`);this._skinData=await t.json()}else typeof e=="object"&&(this._skinUrl="",this._externalResourcesAllowed=!1,this._skinData=e);try{await _h.apply(this),await bh.apply(this),(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&await this._player.reload()}catch(t){throw this._skinUrl="",this._externalResourcesAllowed=!0,this._skinData={},t}}unloadSkin(){var e,t;Array.isArray((e=this._skinData)==null?void 0:e.icons)&&((t=this._skinData)==null||t.icons.forEach(({plugin:i,identifier:s})=>{this.player.removeCustomPluginIcon(i,s)})),this._skinUrl=null,this._skinData={},(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&this._player.reload()}}class ca{constructor(e,t){this._player=t,this._videoManifest=JSON.parse(JSON.stringify(e)),this._metadata=this._videoManifest.metadata||{},this._streams={},this._frameList={},this._trimming=this._videoManifest.trimming,this._captions=this._videoManifest.captions,this._visibleTimeLine=this._videoManifest.visibleTimeLine;function i(){if(this.streams.length!==1)return null;if(this.isAudioOnly)return this.audioOnlySource.src;const s=this.streams[0];if(!(s.sources.mp4||s.sources.hls||s.sources.hlsLive))return null;const a=document.createElement("video");if(s.sources.mp4&&s.sources.mp4.length&&a.canPlayType(s.sources.mp4[0].mimetype||"video/mp4")==="probably")return s.sources.mp4[0].src;const o=s.sources.hls||s.sources.hlsLive;return o&&o.length&&a.canPlayType(o[0].mimetype||"application/vnd.apple.mpegurl")!==""&&/safari/i.test(navigator.userAgent)?o[0].src:null}this._streams={streams:this._videoManifest.streams,get contents(){return this.streams.map(s=>s.content)},getStream(s){return this.streams.find(r=>r.content===s)},getSourceTypes(s){const r=this.getStream(s);return r&&Object.keys(r.sources)||null},getCanvasTypes(s){const r=this.getStream(s);return r?r.canvas||["video"]:null},get isAudioOnly(){const s=this.contents.length===1&&this.contents[0],r=s&&this.getCanvasTypes(s)||[],a=this.getStream(s);return r.length===1&&r[0]==="audio"&&a.sources.audio&&a.sources.audio.length>0},get audioOnlySource(){return this.isAudioOnly?this.getStream(this.contents[0]).sources.audio[0]:null},get isNativelyPlayable(){return i.apply(this)!==null},get nativeSource(){return i.apply(this)},get nativeType(){return this.isNativelyPlayable?this.isAudioOnly?"audio":"video":null},get nativePlayer(){const s=this.nativeType;if(s){const r=document.createElement(s);return r.src=this.nativeSource,r}else return null}},this._videoManifest.frameList&&!Array.isArray(this._videoManifest.frameList)&&typeof this._videoManifest.frameList=="object"&&typeof this._videoManifest.frameList.targetContent=="string"&&Array.isArray(this._videoManifest.frameList.frames)?this._frameList=this._videoManifest.frameList:Array.isArray(this._videoManifest.frameList)&&(this._frameList={targetContent:null,frames:this._videoManifest.frameList}),this._frameList.getImage=(s,r=!1)=>{var a,o;return(a=this._player)!=null&&a.videoContainer&&this._player._videoContainer.isTrimEnabled&&!r?s+=this._player.videoContainer.trimStart:!((o=this._player)!=null&&o._videoContainer)&&!r&&console.warn("frameList.getImage(): player instance is null. The trimming information will be ignored."),[...this._frameList.frames].sort((l,c)=>c.time-l.time).find(l=>l.time<s)},Object.defineProperty(this._frameList,"isEmpty",{get(){return Array.isArray(e.frameList)&&e.frameList.length===0||!e.frameList}}),Object.freeze(this._metadata),Object.freeze(this._streams),Object.freeze(this._trimming),Object.freeze(this._captions)}get metadata(){return this._metadata}get streams(){return this._streams}get frameList(){return this._frameList}get captions(){return this._captions}get trimming(){return this._trimming}get visibleTimeLine(){return this._visibleTimeLine}}const Fe=Object.freeze(["UNLOADED","LOADING_MANIFEST","MANIFEST","LOADING_PLAYER","LOADED","UNLOADING_MANIFEST","UNLOADING_PLAYER","ERROR"]);function ha(){var t,i,s,r,a,o,l,c;const n=((i=(t=this.videoManifest)==null?void 0:t.metadata)==null?void 0:i.preview)&&et(this,(r=(s=this.videoManifest)==null?void 0:s.metadata)==null?void 0:r.preview)||this.defaultVideoPreview,e=((o=(a=this.videoManifest)==null?void 0:a.metadata)==null?void 0:o.previewPortrait)&&et(this,(c=(l=this.videoManifest)==null?void 0:l.metadata)==null?void 0:c.previewPortrait)||this.defaultVideoPreviewPortrait;this._previewContainer=new fh(this,this._containerElement,n,e)}async function ua(){this._playerState=z.LOADING_MANIFEST,this._manifestLoaded=!0,this.log.debug("Loading paella player"),this._config=await this.initParams.loadConfig(this.configUrl,this),Lh.apply(this.skin,[this._config]),xc(this),this._defaultVideoPreview=this._config.defaultVideoPreview||this._initParams.defaultVideoPreview||"",this._defaultVideoPreviewPortrait=this._config.defaultVideoPreviewPortrait||this._initParams.defaultVideoPreviewPortrait||"",this._cookieConsent=new Th(this,{getConsent:this._initParams.getCookieConsentFunction,getDescription:this._initParams.getCookieDescriptionFunction}),this._preferences=new xh(this);const n=new URLSearchParams(window.location.search),e=new URLSearchParams;for(const[s,r]of n)e.append(s.toLowerCase(),r);const t=e.get("loglevel"),i=t&&Array.from(Object.keys(ce)).indexOf(t.toUpperCase())!==-1?t:this._config.logLevel||"INFO";this._log.setLevel(i),await this._initParams.loadDictionaries(this),eh(this),await yh(this),await lc(this),this._videoContainer=new oh(this,this._containerElement),await this.videoContainer.create();for(const s of this.pluginModules){const r=s.getDictionaries&&await s.getDictionaries();if(r)for(const a in r)At(a,r[a])}}async function da(){var n,e;this.log.debug("Video manifest loaded:"),this.log.debug(this.videoManifest),this._data=new jr(this);for(const t in aa){const i=aa[t];At(t,i)}if(this._playerState=z.MANIFEST,X(this,F.MANIFEST_LOADED),(e=(n=this.videoManifest)==null?void 0:n.metadata)!=null&&e.preview)ha.apply(this);else throw new Error("No preview image found in video manifest, and no default preview image defined.");Qr(this._videoManifest),__paella_instances__.length===1&&(this._loadKeypressHandler=this._loadKeypressHandler||(async t=>{/space/i.test(t.code)&&await this.play()}),window.addEventListener("keypress",this._loadKeypressHandler,!0))}class Rh{constructor(e,t={}){this._log=new ra(this),this._packageData=Ht,this._log.setLevel(ce.VERBOSE),window.__paella_instances__=window.__paella_instances__||[],window.__paella_instances__.push(this),this.log.debug("New paella player instance"),typeof e=="string"&&(e=document.getElementById(e)),e.classList.add("player-container"),this.log.debug("Loading skin manager"),this._skin=new wh(this),this._containerElement=e,this._initParams=t,this._initParams.manifestFileName=this._initParams.manifestFileName||"data.json",this._initParams.loadConfig=this._initParams.loadConfig||ir,this._initParams.getVideoId=this._initParams.getVideoId||sr,this._initParams.getManifestUrl=this._initParams.getManifestUrl||nr,this._initParams.getManifestFileUrl=this._initParams.getManifestFileUrl||rr,this._initParams.loadVideoManifest=this._initParams.loadVideoManifest||ar,this._initParams.customPluginContext=this._initParams.customPluginContext||[],this._initParams.translateFunction=this._initParams.translateFunction||hs,this._initParams.getLanguageFunction=this._initParams.getLanguageFunction||ds,this._initParams.setLanguageFunction=this._initParams.setLanguageFunction||us,this._initParams.addDictionaryFunction=this._initParams.addDictionaryFunction||fs,this._initParams.getDictionariesFunction=this._initParams.getDictionariesFunction||gs,this._initParams.getDefaultLanguageFunction=this._initParams.getDefaultLanguageFunction||ms,this._initParams.Loader=this._initParams.customLoader||or,this._initParams.getCookieConsentFunction=this._initParams.getCookieConsentFunction||Ns,this._initParams.getCookieDescriptionFunction=this._initParams.getCookieDescriptionFunction||Us,this._initParams.loadDictionaries=this._initParams.loadDictionaries||async function(r){At("en",{Hello:"Hello",World:"World"}),At("es",{Hello:"Hola",World:"Mundo"}),ps(navigator.language.substring(0,2))};const i=this._initParams.plugins||[];this._initParams.plugins=[...i],pc(this._initParams.translateFunction),yc(this._initParams.setLanguageFunction),vc(this._initParams.getLanguageFunction),Ec(this._initParams.addDictionaryFunction),Tc(this._initParams.getDictionariesFunction),Sc(this._initParams.getDefaultLanguageFunction),this._config=null,this._defaultVideoPreview="",this._defaultVideoPreviewPortrait="",this._videoId=null,this._manifestUrl=null,this._manifestFileUrl=null,this._manifestData=null,this._videoManifest=null,this._playerLoaded=!1;const s=()=>{this.resize()};window.addEventListener("resize",s),this.containerElement.addEventListener("fullscreenchange",()=>{X(this,F.FULLSCREEN_CHANGED,{status:this.isFullscreen}),this.isFullscreen?X(this,F.ENTER_FULLSCREEN):X(this,F.EXIT_FULLSCREEN)}),this._playerState=z.UNLOADED,this._customPluginIcons={}}get version(){return this._packageData.version}get pluginModules(){return this.__pluginModules||[]}get log(){return this._log}get ready(){return this._playerState===z.LOADED}get state(){return this._playerState}get stateText(){return Fe[this.state]}get Events(){return F}get preferences(){return this._preferences}get skin(){return this._skin}translate(e,t=null){return mt(e,t)}setLanguage(e){ps(e)}getLanguage(){return Dr()}addDictionary(e,t){At(e,t)}getDictionaries(){return Pr()}getDefaultLanguage(){return ys(this)}bindEvent(e,t,i=!0){ie(this,e,s=>t(s),i)}getShortcuts(){return Er(this)}getPlugin(e,t=null){if(t){const i=this.__pluginData__.pluginInstances[t];if(i)return i.find(s=>{if(s.name===e)return s})}else{const i={};for(const s in this.__pluginData__.pluginInstances){const a=this.__pluginData__.pluginInstances[s].find(o=>{if(o.name===e)return o});a&&(i[s]=a)}return i}}get hideUiTime(){return this._hideUiTime}set hideUiTime(e){this._hideUiTime=e}get containerSize(){return{w:this._containerElement.offsetWidth,h:this._containerElement.offsetHeight}}get containerElement(){return this._containerElement}get initParams(){return this._initParams}get cookieConsent(){return this._cookieConsent}get configLoaded(){return this.configUrl!==null}get videoManifestLoaded(){return this.videoManifest!==null}get videoLoaded(){var e;return((e=this.videoContainer)==null?void 0:e.ready)||!1}get playerLoaded(){return this._playerLoaded}get configResourcesUrl(){var e;return((e=this._initParams)==null?void 0:e.configResourcesUrl)||"config/"}get configUrl(){var e;return((e=this._initParams)==null?void 0:e.configUrl)||"config/config.json"}get config(){return this._config}get defaultVideoPreview(){return this._defaultVideoPreview}get defaultVideoPreviewPortrait(){return this._defaultVideoPreviewPortrait}get videoId(){return this._videoId}get repositoryUrl(){var e,t;return((e=this._initParams)==null?void 0:e.repositoryUrl)||((t=this.config)==null?void 0:t.repositoryUrl)||""}get manifestUrl(){return this._manifestUrl}get manifestFileName(){var e,t;return((e=this.config)==null?void 0:e.manifestFileName)||((t=this._initParams)==null?void 0:t.manifestFileName)||""}get manifestFileUrl(){return this._manifestFileUrl}get videoManifest(){return this._videoManifest}get previewContainer(){return this._previewContainer}get videoContainer(){return this._videoContainer}get playbackBar(){return this._playbackBar}get captionsCanvas(){return this._captionsCanvas}get data(){return this._data}get PlayerState(){return z}get PlayerStateNames(){return Fe}get metadata(){var e;return((e=this._manifestParser)==null?void 0:e.metadata)||{}}get streams(){var e;return((e=this._manifestParser)==null?void 0:e.streams)||[]}get frameList(){var e;return((e=this._manifestParser)==null?void 0:e.frameList)||{}}get captions(){var e;return((e=this._manifestParser)==null?void 0:e.captions)||[]}get trimming(){var e;return((e=this._manifestParser)==null?void 0:e.trimming)||{}}get visibleTimeLine(){var e;return((e=this._manifestParser)==null?void 0:e.visibleTimeLine)||!0}waitState(e){return new Promise((t,i)=>{const s=()=>{this.state===e?t():setTimeout(s,50)};typeof e=="string"&&(e=z[e]),(e<0||e>Object.values(z).length)&&i(Error(`Invalid player state '${e}'`)),s()})}async loadUrl(e,{title:t,duration:i,preview:s,previewPortrait:r}={}){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[Fe[this._playerState]]));if(this._manifestLoaded)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[Fe[this._playerState]]));if(!e)throw new Error(this.translate("loadUrl(): No URL specified."));Array.isArray(e)||(e=[e]),t||(t=ei(e[0]),this.log.warn("Paella.loadUrl(): no title specified. Using URL file name as video name."));try{if(await ua.apply(this),!s&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!==""))s=this.defaultVideoPreview,r=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.");else if(!s&&!r)throw new Error("Paella.loadUrl(): no preview image specified and no default preview image configured.");this._videoId=qn(ei(e[0])),this._manifestUrl=Yi(e[0]),this._manifestFileUrl=e[0],this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`);const a=Ic(this,e.length)[0];this._videoManifest={metadata:{duration:i,title:t,preview:s,previewPortrait:r},streams:e.map((o,l)=>({sources:sh(this,o),content:a[l],role:l===0?"mainAudio":null}))},await da.apply(this)}catch(a){throw this._playerState=z.ERROR,this.log.error(a),this._errorContainer=new Qi(this,this.translate(a.message)),a}}async loadManifest(){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));if(!this._manifestLoaded)try{if(await ua.apply(this),this._videoId=await this.initParams.getVideoId(this._config,this),this.videoId===null)throw new Error("No video identifier specified");this._manifestUrl=await this.initParams.getManifestUrl(this.repositoryUrl,this.videoId,this._config,this),this._manifestFileUrl=await this.initParams.getManifestFileUrl(this._manifestUrl,this.manifestFileName,this._config,this),this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`),this._videoManifest=await this.initParams.loadVideoManifest(this.manifestFileUrl,this._config,this),this._videoManifest.metadata=this._videoManifest.metadata||{},!this._videoManifest.metadata.preview&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!=="")&&(this._videoManifest.metadata.preview=this.defaultVideoPreview,this._videoManifest.metadata.previewPortrait=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.")),this._manifestParser=new ca(this.videoManifest,this),la.apply(this.skin),await Ah.apply(this.skin),await Ch.apply(this.skin),await da.apply(this)}catch(e){throw this._playerState=z.ERROR,this.log.error(e),this._errorContainer=new Qi(this,this.translate(e.message)),e}}async loadPlayer(){var e,t,i;try{if(this._captionsCanvas=new ph(this,this._containerElement),this._playerState!==z.MANIFEST)throw new Error(this.translate("loadPlayer(): Invalid current player state: $1",[Fe[this._playerState]]));this._playerState=z.LOADING_PLAYER,(e=this._previewContainer)==null||e.removeFromParent(),this._loader=new this.initParams.Loader(this),await this._loader.create(),await this.videoContainer.load((t=this.videoManifest)==null?void 0:t.streams),X(this,F.STREAM_LOADED),this._playbackBar=new gh(this,this.containerElement),await this._playbackBar.load(),this._hideUiTime=((i=this.config.ui)==null?void 0:i.hideUITimer)??5e3,Zn(this),this._captionsCanvas.load(),this._playerState=z.LOADED,X(this,F.PLAYER_LOADED),!(this.videoManifest.metadata.visibleTimeLine??!0)&&this.playbackBar.progressIndicator.hideTimeLine(),this._loader.debug||(this._loader.removeFromParent(),this._loader=null)}catch(s){throw this._playerState=z.ERROR,this._loader&&(this._loader.removeFromParent(),this._loader=null),this._errorContainer=new Qi(this,s.message),s}}async load(){switch(this.state){case z.UNLOADED:await this.loadManifest(),await this.loadPlayer();break;case z.MANIFEST:await this.loadPlayer();break;case z.LOADED:break;default:throw new Error(this.translate("Could not load player: state transition in progress: $1",[Fe[this.state]]))}}async unload(){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:case z.ERROR:await this.unloadPlayer(),await this.unloadManifest();break;default:throw new Error(this.translate("Could not unload player: state transition in progress: $1",[Fe[this.state]]))}}async unloadManifest(){var e;if(this._playerState!==z.MANIFEST&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_MANIFEST,this.log.debug("Unloading paella player"),await vh(),await cc(this),await th(this),this._manifestLoaded=!1,(e=this._previewContainer)==null||e.removeFromParent(),this._preferences=null,this._playerState=z.UNLOADED,la.apply(this.skin)}async unloadPlayer(){var e,t,i,s,r;if(this._playerState!==z.LOADED&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_PLAYER,await((e=this._videoContainer)==null?void 0:e.unload()),this._videoContainer=null,await((t=this._playbackBar)==null?void 0:t.unload()),this._playbackBar=null,(i=this._captionsCanvas)==null||i.unload(),this._captionsCanvas=null,Jn(this),X(this,F.PLAYER_UNLOADED),Le.Unload(),Kt.Unload(this),(r=(s=this.videoManifest)==null?void 0:s.metadata)!=null&&r.preview&&ha.apply(this),Nl(this),this._playerState=z.MANIFEST}async reload(e=null){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:await this.unload();break}typeof e=="function"&&await e(),await this.load()}async resize(){var e,t;if((e=this.videoContainer)==null||e.updateLayout(),(t=this.playbackBar)==null||t.onResize(),this.videoContainer){const i=()=>({w:this.videoContainer.element.offsetWidth,h:this.videoContainer.element.offsetHeight});X(this,F.RESIZE,{size:i()}),this._resizeEndTimer&&clearTimeout(this._resizeEndTimer),this._resizeEndTimer=setTimeout(()=>{X(this,F.RESIZE_END,{size:i()})},1e3)}}async hideUserInterface(){var e,t,i;await((e=this.videoContainer)==null?void 0:e.paused())||(this._uiHidden=!0,(t=this.videoContainer)==null||t.hideUserInterface(),(i=this.playbackBar)==null||i.hideUserInterface(),Kt.HideUserInterface(this),X(this,F.HIDE_UI))}async showUserInterface(){var e,t;(e=this.videoContainer)==null||e.showUserInterface(),(t=this.playbackBar)==null||t.showUserInterface(),Kt.ShowUserInterface(this),this._uiHidden&&X(this,F.SHOW_UI),this._uiHidden=!1}async play(){this._loadKeypressHandler&&(window.removeEventListener("keypress",this._loadKeypressHandler,!0),this._loadKeypressHandler=null),this.videoContainer.ready||await this.loadPlayer(),await this.videoContainer.play()}async pause(){var e;await((e=this.videoContainer)==null?void 0:e.pause())}async paused(){return this.videoContainer?this.videoContainer.paused():!0}async stop(){var e;await((e=this.videoContainer)==null?void 0:e.stop())}isFullScreenSupported(){return this.containerElement.requestFullscreen||this.containerElement.webkitRequestFullScreen}async enterFullscreen(){let e=null;return this.containerElement.requestFullscreen?e=this.containerElement.requestFullscreen():this.containerElement.webkitRequestFullScreen&&(this.log.debug("Safari enter fullscreen"),e=this.containerElement.webkitRequestFullScreen()),setTimeout(()=>this.resize(),500),e}async exitFullscreen(){if(document.exitFullscreen&&this.isFullscreen)return document.exitFullscreen();if(document.webkitCancelFullScreen&&this.isFullscreen)return this.log.debug("Safari exit fullscreen"),document.webkitCancelFullScreen()}get isFullscreen(){return document.fullscreenElement===this.containerElement||document.webkitFullscreenElement===this.containerElement}addCustomPluginIcon(e,t,i){this._customPluginIcons[`${e}-${t}`]=i}removeCustomPluginIcon(e,t){this._customPluginIcons[`${e}-${t}`]=null}getCustomPluginIcon(e,t){return this._requestedCustomIcons=this._requestedCustomIcons||[],this._requestedCustomIcons.find(i=>i.pluginName===e&&i.iconName===t)||this._requestedCustomIcons.push({pluginName:e,iconName:t}),this._customPluginIcons[`${e}-${t}`]}get requestedCustomIcons(){return this._requestedCustomIcons||[]}}class Ih extends ui{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}async getContent(){const e=j('<ul class="menu-button-content"></ul>');this.menuTitle;const t=await this.getMenu();this._menuItems=t;let i=!1,s=null;return t.forEach(r=>{const a=j('<li class="menu-button-item"></li>',e);let o="";this.buttonType==="button"?o="menu-item-type-button":this.buttonType==="check"?o="menu-item-type-button"+(r.selected?" selected":""):this.buttonType==="radio"&&(o="menu-item-type-button",!i&&r.selected&&(o+=" selected",i=!0));let l="";const c=r.title instanceof Element?r.title:null;r.icon&&r.title&&this.showTitles&&!c&&(l=`
				<i class="menu-icon">${r.icon}</i>
				<span class="menu-title">${r.title}</span>
				`),r.icon&&c&&this.showTitles?l=`
				<i class="menu-icon">${r.icon}</i>
				<span class="menu-title"></span>
				`:r.icon?l=`
				<i class="menu-icon">${r.icon}</i>
				`:r.title&&!c?l=`
				<span class="menu-title">${r.title}</span>
				`:c&&(l=`
				<span class="menu-title"></span>
				`);const h=j(`
				<button class="${o}" aria-label="${r.title}" title="${r.title}">${l}</button>`,a);c&&h.getElementsByClassName("menu-title")[0].appendChild(c),s||(s=h),r.buttonElement=h,h._itemData=r,h.addEventListener("click",d=>{this.buttonType==="check"?(d.target._itemData.selected=!d.target._itemData.selected,d.target._itemData.selected?d.target.classList.add("selected"):d.target.classList.remove("selected")):this.buttonType==="radio"&&(this.menuItems.forEach(g=>{g.selected=!1,g.buttonElement.classList.remove("selected")}),d.target._itemData.selected=!d.target._itemData.selected,d.target._itemData.selected?d.target.classList.add("selected"):d.target.classList.remove("selected")),this.itemSelected(d.target._itemData,this._menuItems),d.stopPropagation(),this.closeOnSelect&&this.closeMenu()});const u=h.getElementsByTagName("svg");u.length>0&&(/%$/.test(u[0].getAttribute("width"))&&u[0].removeAttribute("width"),/%$/.test(u[0].getAttribute("height"))&&u[0].removeAttribute("height"))}),setTimeout(()=>{s.focus()},50),e}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}buttonType(){return"button"}itemSelected(e,t){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.config.closeParentPopUp?Le.HideAllPopUps(!1):this._popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp()}}class Dh extends Ye{get type(){return"progressIndicator"}get minHeight(){return 0}get minHeightHover(){return 0}drawForeground(e,t,i,s){}drawBackground(e,t,i,s){}requestUpdate(){this.player.playbackBar.progressIndicator.requestUpdateCanvas()}}function Ph(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var fa={exports:{}};(function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,h){if(h=h||{},l=l.trim(),c=c.trim(),!c){if(!h.alwaysNormalize)return l;var u=o.parseURL(l);if(!u)throw new Error("Error trying to parse base URL.");return u.path=o.normalizePath(u.path),o.buildURLFromParts(u)}var d=o.parseURL(c);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return h.alwaysNormalize?(d.path=o.normalizePath(d.path),o.buildURLFromParts(d)):c;var g=o.parseURL(l);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var f=s.exec(g.path);g.netLoc=f[1],g.path=f[2]}g.netLoc&&!g.path&&(g.path="/");var m={scheme:g.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(m.netLoc=g.netLoc,d.path[0]!=="/"))if(!d.path)m.path=g.path,d.params||(m.params=g.params,d.query||(m.query=g.query));else{var p=g.path,v=p.substring(0,p.lastIndexOf("/")+1)+d.path;m.path=o.normalizePath(v)}return m.path===null&&(m.path=h.alwaysNormalize?o.normalizePath(d.path):d.path),o.buildURLFromParts(m)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};n.exports=o})()})(fa);var $s=fa.exports;function ga(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function fe(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ga(Object(t),!0).forEach(function(i){Oh(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ga(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function kh(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Fh(n){var e=kh(n,"string");return typeof e=="symbol"?e:String(e)}function Oh(n,e,t){return e=Fh(e),e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function he(){return he=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},he.apply(this,arguments)}const N=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},Mh=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=Nh},Nh=Number.MAX_SAFE_INTEGER||9007199254740991;let y=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n}({}),$=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),C=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.UNKNOWN="unknown",n}({});const yt=function(){},Gs={trace:yt,debug:yt,log:yt,warn:yt,info:yt,error:yt};let qt=Gs;function Uh(n){const e=self.console[n];return e?e.bind(self.console,`[${n}] >`):yt}function Bh(n,...e){e.forEach(function(t){qt[t]=n[t]?n[t].bind(n):Uh(t)})}function $h(n,e){if(typeof console=="object"&&n===!0||typeof n=="object"){Bh(n,"debug","log","info","warn","error");try{qt.log(`Debug logs enabled for "${e}" in hls.js version 1.5.1`)}catch{qt=Gs}}else qt=Gs}const x=qt,Gh=/^(\d+)x(\d+)$/,ma=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ae{constructor(e){typeof e=="string"&&(e=ae.parseAttrList(e)),he(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Gh.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={},s='"';for(ma.lastIndex=0;(t=ma.exec(e))!==null;){let r=t[2];r.indexOf(s)===0&&r.lastIndexOf(s)===r.length-1&&(r=r.slice(1,-1));const a=t[1].trim();i[a]=r}return i}}function Vh(n){return n!=="ID"&&n!=="CLASS"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function Hh(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"}class Vs{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const s in i)if(Object.prototype.hasOwnProperty.call(e,s)&&e[s]!==i[s]){x.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=s;break}e=he(new ae({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);N(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return e!==null?new Date(this._startDate.getTime()+e*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(N(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&N(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Xt{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var te={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Hs{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[te.AUDIO]:null,[te.VIDEO]:null,[te.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2);let s;i.length===1?s=(t==null?void 0:t.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=$s.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class di extends Hs{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Xt,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!N(this.programDateTime))return null;const e=N(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,a=!1){const{elementaryStreams:o}=this,l=o[e];if(!l){o[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:a};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[te.AUDIO]=null,e[te.VIDEO]=null,e[te.AUDIOVIDEO]=null}}class pa extends Hs{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Xt,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const a=e.enumeratedString("BYTERANGE");a&&this.setByteRange(a,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const Kh=10;class ya{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?N(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Kh}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function Ks(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function Wh(n){const e=Ws(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function Yh(n){const e=function(i,s,r){const a=i[s];i[s]=i[r],i[r]=a};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function zh(n){const e=n.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",a=s[1];r?(i.splice(-1,1),t=Ks(a)):t=Wh(a)}}return t}function Ws(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}const wt=typeof self<"u"?self:void 0;var re={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Se={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function va(n){switch(n){case Se.FAIRPLAY:return re.FAIRPLAY;case Se.PLAYREADY:return re.PLAYREADY;case Se.WIDEVINE:return re.WIDEVINE;case Se.CLEARKEY:return re.CLEARKEY}}var Ea={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function jh(n){if(n===Ea.WIDEVINE)return re.WIDEVINE}function Ta(n){switch(n){case re.FAIRPLAY:return Se.FAIRPLAY;case re.PLAYREADY:return Se.PLAYREADY;case re.WIDEVINE:return Se.WIDEVINE;case re.CLEARKEY:return Se.CLEARKEY}}function Ys(n){const{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[re.FAIRPLAY,re.WIDEVINE,re.PLAYREADY,re.CLEARKEY].filter(s=>!!e[s]):[];return!i[re.WIDEVINE]&&t&&i.push(re.WIDEVINE),i}const Sa=function(n){return wt!=null&&(n=wt.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function qh(n,e,t,i){let s;switch(n){case re.FAIRPLAY:s=["cenc","sinf"];break;case re.WIDEVINE:case re.PLAYREADY:s=["cenc"];break;case re.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return Xh(s,e,t,i)}function Xh(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs="${r}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs="${r}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function vt(n,e,t){return Uint8Array.prototype.slice?n.slice(e,t):new Uint8Array(Array.prototype.slice.call(n,e,t))}const zs=(n,e)=>e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,xa=(n,e)=>e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,Qt=(n,e)=>{const t=e;let i=0;for(;zs(n,e);){i+=10;const s=fi(n,e+6);i+=s,xa(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)},fi=(n,e)=>{let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t},Qh=(n,e)=>zs(n,e)&&fi(n,e+6)+10<=n.length-e,js=n=>{const e=_a(n);for(let t=0;t<e.length;t++){const i=e[t];if(La(i))return su(i)}},La=n=>n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp",Zh=n=>{const e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=fi(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}},_a=n=>{let e=0;const t=[];for(;zs(n,e);){const i=fi(n,e+6);e+=10;const s=e+i;for(;e+8<s;){const r=Zh(n.subarray(e)),a=Jh(r);a&&t.push(a),e+=r.size+10}xa(n,e)&&(e+=10)}return t},Jh=n=>n.type==="PRIV"?eu(n):n.type[0]==="W"?iu(n):tu(n),eu=n=>{if(n.size<2)return;const e=Ue(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}},tu=n=>{if(n.size<2)return;if(n.type==="TXXX"){let t=1;const i=Ue(n.data.subarray(t),!0);t+=i.length+1;const s=Ue(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Ue(n.data.subarray(1));return{key:n.type,data:e}},iu=n=>{if(n.type==="WXXX"){if(n.size<2)return;let t=1;const i=Ue(n.data.subarray(t),!0);t+=i.length+1;const s=Ue(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Ue(n.data);return{key:n.type,data:e}},su=n=>{if(n.data.byteLength===8){const e=new Uint8Array(n.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}},Ue=(n,e=!1)=>{const t=nu();if(t){const c=t.decode(n);if(e){const h=c.indexOf("\0");return h!==-1?c.substring(0,h):c}return c.replace(/\0/g,"")}const i=n.length;let s,r,a,o="",l=0;for(;l<i;){if(s=n[l++],s===0&&e)return o;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:r=n[l++],o+=String.fromCharCode((s&31)<<6|r&63);break;case 14:r=n[l++],a=n[l++],o+=String.fromCharCode((s&15)<<12|(r&63)<<6|(a&63)<<0);break}}return o};let qs;function nu(){if(!navigator.userAgent.includes("PlayStation 4"))return!qs&&typeof self.TextDecoder<"u"&&(qs=new self.TextDecoder("utf-8")),qs}const Be={hexDump:function(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}},gi=Math.pow(2,32)-1,ru=[].push,Ca={video:1,audio:2,id3:3,text:4};function ue(n){return String.fromCharCode.apply(null,n)}function ba(n,e){const t=n[e]<<8|n[e+1];return t<0?65536+t:t}function G(n,e){const t=Aa(n,e);return t<0?4294967296+t:t}function Aa(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function Xs(n,e,t){n[e]=t>>24,n[e+1]=t>>16&255,n[e+2]=t>>8&255,n[e+3]=t&255}function au(n){const e=n.byteLength;for(let t=0;t<e;){const i=G(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function K(n,e){const t=[];if(!e.length)return t;const i=n.byteLength;for(let s=0;s<i;){const r=G(n,s),a=ue(n.subarray(s+4,s+8)),o=r>1?s+r:i;if(a===e[0])if(e.length===1)t.push(n.subarray(s+8,o));else{const l=K(n.subarray(s+8,o),e.slice(1));l.length&&ru.apply(t,l)}s=o}return t}function ou(n){const e=[],t=n[0];let i=8;const s=G(n,i);i+=4;const r=0,a=0;t===0?i+=8:i+=16,i+=2;let o=n.length+a;const l=ba(n,i);i+=2;for(let c=0;c<l;c++){let h=i;const u=G(n,h);h+=4;const d=u&2147483647;if((u&2147483648)>>>31===1)return x.warn("SIDX has hierarchical references (not supported)"),null;const f=G(n,h);h+=4,e.push({referenceSize:d,subsegmentDuration:f,info:{duration:f/s,start:o,end:o+d-1}}),o+=d,h+=4,i=h}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:l,references:e}}function wa(n){const e=[],t=K(n,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],a=K(r,["tkhd"])[0];if(a){let o=a[0];const l=G(a,o===0?12:20),c=K(r,["mdia","mdhd"])[0];if(c){o=c[0];const h=G(c,o===0?12:20),u=K(r,["mdia","hdlr"])[0];if(u){const d=ue(u.subarray(8,12)),g={soun:te.AUDIO,vide:te.VIDEO}[d];if(g){const f=K(r,["mdia","minf","stbl","stsd"])[0],m=lu(f);e[l]={timescale:h,type:g},e[g]=fe({timescale:h,id:l},m)}}}}}return K(n,["moov","mvex","trex"]).forEach(s=>{const r=G(s,4),a=e[r];a&&(a.default={duration:G(s,12),flags:G(s,20)})}),e}function lu(n){const e=n.subarray(8),t=e.subarray(86),i=ue(e.subarray(4,8));let s=i;const r=i==="enca"||i==="encv";if(r){const o=K(e,[i])[0].subarray(i==="enca"?28:78);K(o,["sinf"]).forEach(c=>{const h=K(c,["schm"])[0];if(h){const u=ue(h.subarray(4,8));if(u==="cbcs"||u==="cenc"){const d=K(c,["frma"])[0];d&&(s=ue(d))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const a=K(t,["avcC"])[0];s+="."+mi(a[1])+mi(a[2])+mi(a[3]);break}case"mp4a":{const a=K(e,[i])[0],o=K(a.subarray(28),["esds"])[0];if(o&&o.length>12){let l=4;if(o[l++]!==3)break;l=Qs(o,l),l+=2;const c=o[l++];if(c&128&&(l+=2),c&64&&(l+=o[l++]),o[l++]!==4)break;l=Qs(o,l);const h=o[l++];if(h===64)s+="."+mi(h);else break;if(l+=12,o[l++]!==5)break;l=Qs(o,l);const u=o[l++];let d=(u&248)>>3;d===31&&(d+=1+((u&7)<<3)+((o[l]&224)>>5)),s+="."+d}break}case"hvc1":case"hev1":{const a=K(t,["hvcC"])[0],o=a[1],l=["","A","B","C"][o>>6],c=o&31,h=G(a,2),u=(o&32)>>5?"H":"L",d=a[12],g=a.subarray(6,12);s+="."+l+c,s+="."+h.toString(16).toUpperCase(),s+="."+u+d;let f="";for(let m=g.length;m--;){const p=g[m];(p||f)&&(f="."+p.toString(16).toUpperCase()+f)}s+=f;break}case"dvh1":case"dvhe":{const a=K(t,["dvcC"])[0],o=a[2]>>1&127,l=a[2]<<5&32|a[3]>>3&31;s+="."+$e(o)+"."+$e(l);break}case"vp09":{const a=K(t,["vpcC"])[0],o=a[4],l=a[5],c=a[6]>>4&15;s+="."+$e(o)+"."+$e(l)+"."+$e(c);break}case"av01":{const a=K(t,["av1C"])[0],o=a[1]>>>5,l=a[1]&31,c=a[2]>>>7?"H":"M",h=(a[2]&64)>>6,u=(a[2]&32)>>5,d=o===2&&h?u?12:10:h?10:8,g=(a[2]&16)>>4,f=(a[2]&8)>>3,m=(a[2]&4)>>2,p=a[2]&3;s+="."+o+"."+$e(l)+c+"."+$e(d)+"."+g+"."+f+m+p+"."+$e(1)+"."+$e(1)+"."+$e(1)+"."+0;break}}return{codec:s,encrypted:r}}function Qs(n,e){const t=e+5;for(;n[e++]&128&&e<t;);return e}function mi(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function $e(n){return(n<10?"0":"")+n}function cu(n,e){if(!n||!e)return n;const t=e.keyId;return t&&e.isCommonEncryption&&K(n,["moov","trak"]).forEach(s=>{const a=K(s,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=K(a,["enca"]);const l=o.length>0;l||(o=K(a,["encv"])),o.forEach(c=>{const h=l?c.subarray(28):c.subarray(78);K(h,["sinf"]).forEach(d=>{const g=Ra(d);if(g){const f=g.subarray(8,24);f.some(m=>m!==0)||(x.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${Be.hexDump(f)} -> ${Be.hexDump(t)}`),g.set(t,8))}})})}),n}function Ra(n){const e=K(n,["schm"])[0];if(e){const t=ue(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return K(n,["schi","tenc"])[0]}return x.error("[eme] missing 'schm' box"),null}function hu(n,e){return K(e,["moof","traf"]).reduce((t,i)=>{const s=K(i,["tfdt"])[0],r=s[0],a=K(i,["tfhd"]).reduce((o,l)=>{const c=G(l,4),h=n[c];if(h){let u=G(s,4);if(r===1){if(u===gi)return x.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;u*=gi+1,u+=G(s,8)}const d=h.timescale||9e4,g=u/d;if(N(g)&&(o===null||g<o))return g}return o},null);return a!==null&&N(a)&&(t===null||a<t)?a:t},null)}function uu(n,e){let t=0,i=0,s=0;const r=K(n,["moof","traf"]);for(let a=0;a<r.length;a++){const o=r[a],l=K(o,["tfhd"])[0],c=G(l,4),h=e[c];if(!h)continue;const u=h.default,d=G(l,0)|(u==null?void 0:u.flags);let g=u==null?void 0:u.duration;d&8&&(d&2?g=G(l,12):g=G(l,8));const f=h.timescale||9e4,m=K(o,["trun"]);for(let p=0;p<m.length;p++){if(t=du(m[p]),!t&&g){const v=G(m[p],4);t=g*v}h.type===te.VIDEO?i+=t/f:h.type===te.AUDIO&&(s+=t/f)}}if(i===0&&s===0){let a=0;const o=K(n,["sidx"]);for(let l=0;l<o.length;l++){const c=ou(o[l]);c!=null&&c.references&&(a+=c.references.reduce((h,u)=>h+u.info.duration||0,0))}return a}return i||s}function du(n){const e=G(n,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const s=G(n,4);for(let r=0;r<s;r++){if(e&256){const a=G(n,t);i+=a,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function fu(n,e,t){K(e,["moof","traf"]).forEach(i=>{K(i,["tfhd"]).forEach(s=>{const r=G(s,4),a=n[r];if(!a)return;const o=a.timescale||9e4;K(i,["tfdt"]).forEach(l=>{const c=l[0],h=t*o;if(h){let u=G(l,4);if(c===0)u-=h,u=Math.max(u,0),Xs(l,4,u);else{u*=Math.pow(2,32),u+=G(l,8),u-=h,u=Math.max(u,0);const d=Math.floor(u/(gi+1)),g=Math.floor(u%(gi+1));Xs(l,4,d),Xs(l,8,g)}}})})})}function gu(n){const e={valid:null,remainder:null},t=K(n,["moof"]);if(t.length<2)return e.remainder=n,e;const i=t[t.length-1];return e.valid=vt(n,0,i.byteOffset-8),e.remainder=vt(n,i.byteOffset-8),e}function we(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Ia(n,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let a=!1;return K(i,["moof"]).map(l=>{const c=l.byteOffset-8;K(l,["traf"]).map(u=>{const d=K(u,["tfdt"]).map(g=>{const f=g[0];let m=G(g,4);return f===1&&(m*=Math.pow(2,32),m+=G(g,8)),m/s})[0];return d!==void 0&&(n=d),K(u,["tfhd"]).map(g=>{const f=G(g,4),m=G(g,0)&16777215,p=(m&1)!==0,v=(m&2)!==0,E=(m&8)!==0;let T=0;const _=(m&16)!==0;let S=0;const A=(m&32)!==0;let b=8;f===r&&(p&&(b+=8),v&&(b+=4),E&&(T=G(g,b),b+=4),_&&(S=G(g,b),b+=4),A&&(b+=4),e.type==="video"&&(a=mu(e.codec)),K(u,["trun"]).map(D=>{const k=D[0],R=G(D,0)&16777215,P=(R&1)!==0;let W=0;const O=(R&4)!==0,H=(R&256)!==0;let J=0;const Y=(R&512)!==0;let V=0;const oe=(R&1024)!==0,M=(R&2048)!==0;let U=0;const Z=G(D,4);let q=8;P&&(W=G(D,q),q+=4),O&&(q+=4);let ee=W+c;for(let Ce=0;Ce<Z;Ce++){if(H?(J=G(D,q),q+=4):J=T,Y?(V=G(D,q),q+=4):V=S,oe&&(q+=4),M&&(k===0?U=G(D,q):U=Aa(D,q),q+=4),e.type===te.VIDEO){let pe=0;for(;pe<V;){const le=G(i,ee);if(ee+=4,pu(a,i[ee])){const Ze=i.subarray(ee,ee+le);Da(Ze,a?2:1,n+U/s,t)}ee+=le,pe+=le+4}}n+=J/s}}))})})}),t}function mu(n){if(!n)return!1;const e=n.indexOf("."),t=e<0?n:n.substring(0,e);return t==="hvc1"||t==="hev1"||t==="dvh1"||t==="dvhe"}function pu(n,e){if(n){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Da(n,e,t,i){const s=Pa(n);let r=0;r+=e;let a=0,o=0,l=0;for(;r<s.length;){a=0;do{if(r>=s.length)break;l=s[r++],a+=l}while(l===255);o=0;do{if(r>=s.length)break;l=s[r++],o+=l}while(l===255);const c=s.length-r;let h=r;if(o<c)r+=o;else if(o>c){x.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(s[h++]===181){const d=ba(s,h);if(h+=2,d===49){const g=G(s,h);if(h+=4,g===1195456820){const f=s[h++];if(f===3){const m=s[h++],p=31&m,v=64&m,E=v?2+p*3:0,T=new Uint8Array(E);if(v){T[0]=m;for(let _=1;_<E;_++)T[_]=s[h++]}i.push({type:f,payloadType:a,pts:t,bytes:T})}}}}}else if(a===5&&o>16){const u=[];for(let f=0;f<16;f++){const m=s[h++].toString(16);u.push(m.length==1?"0"+m:m),(f===3||f===5||f===7||f===9)&&u.push("-")}const d=o-16,g=new Uint8Array(d);for(let f=0;f<d;f++)g[f]=s[h++];i.push({payloadType:a,pts:t,uuid:u.join(""),userData:Ue(g),userDataBytes:g})}}}function Pa(n){const e=n.byteLength,t=[];let i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;const s=e-t.length,r=new Uint8Array(s);let a=0;for(i=0;i<s;a++,i++)a===t[0]&&(a++,t.shift()),r[i]=n[a];return r}function yu(n){const e=n[0];let t="",i="",s=0,r=0,a=0,o=0,l=0,c=0;if(e===0){for(;ue(n.subarray(c,c+1))!=="\0";)t+=ue(n.subarray(c,c+1)),c+=1;for(t+=ue(n.subarray(c,c+1)),c+=1;ue(n.subarray(c,c+1))!=="\0";)i+=ue(n.subarray(c,c+1)),c+=1;i+=ue(n.subarray(c,c+1)),c+=1,s=G(n,12),r=G(n,16),o=G(n,20),l=G(n,24),c=28}else if(e===1){c+=4,s=G(n,c),c+=4;const u=G(n,c);c+=4;const d=G(n,c);for(c+=4,a=2**32*u+d,Mh(a)||(a=Number.MAX_SAFE_INTEGER,x.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=G(n,c),c+=4,l=G(n,c),c+=4;ue(n.subarray(c,c+1))!=="\0";)t+=ue(n.subarray(c,c+1)),c+=1;for(t+=ue(n.subarray(c,c+1)),c+=1;ue(n.subarray(c,c+1))!=="\0";)i+=ue(n.subarray(c,c+1)),c+=1;i+=ue(n.subarray(c,c+1)),c+=1}const h=n.subarray(c,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:a,presentationTimeDelta:r,eventDuration:o,id:l,payload:h}}function vu(n,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function Eu(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;if(e){i=1,s=new Uint8Array(e.length*16);for(let o=0;o<e.length;o++){const l=e[o];if(l.byteLength!==16)throw new RangeError("Invalid key");s.set(l,o*16)}}else i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const a=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(a.buffer).setUint32(0,t.byteLength,!1),vu([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,a,t||new Uint8Array)}function Tu(n){if(!(n instanceof ArrayBuffer)||n.byteLength<32)return null;const e={version:0,systemId:"",kids:null,data:null},t=new DataView(n),i=t.getUint32(0);if(n.byteLength!==i&&i>44||t.getUint32(4)!==1886614376||(e.version=t.getUint32(8)>>>24,e.version>1))return null;e.systemId=Be.hexDump(new Uint8Array(n,12,16));const r=t.getUint32(28);if(e.version===0){if(i-32<r)return null;e.data=new Uint8Array(n,32,r)}else if(e.version===1){e.kids=[];for(let a=0;a<r;a++)e.kids.push(new Uint8Array(n,32+a*16,16))}return e}let pi={};class Rt{static clearKeyUriToKeyIdMap(){pi={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&e!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Se.FAIRPLAY:case Se.WIDEVINE:case Se.PLAYREADY:case Se.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof e!="number"&&(this.method==="AES-128"&&!this.iv&&x.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=Su(e);return new Rt(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=zh(this.uri);if(t)switch(this.keyFormat){case Se.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case Se.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Eu(i,null,t);const s=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(s)),a=r.substring(r.indexOf("<"),r.length),c=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("KID")[0];if(c){const h=c.childNodes[0]?c.childNodes[0].nodeValue:c.getAttribute("VALUE");if(h){const u=Ks(h).subarray(0,16);Yh(u),this.keyId=u}}break}default:{let i=t.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=pi[this.uri];if(!i){const s=Object.keys(pi).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),pi[this.uri]=i}this.keyId=i}return this}}function Su(n){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}const ka=/\{\$([a-zA-Z0-9-_]+)\}/g;function Fa(n){return ka.test(n)}function _e(n,e,t){if(n.variableList!==null||n.hasVariableRefs)for(let i=t.length;i--;){const s=t[i],r=e[s];r&&(e[s]=Zs(n,r))}}function Zs(n,e){if(n.variableList!==null||n.hasVariableRefs){const t=n.variableList;return e.replace(ka,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function Oa(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const a=new self.URL(t).searchParams;if(a.has(s))r=a.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(a){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${a.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function xu(n,e,t){const i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function Et(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const yi={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Lu(n,e){const t=yi[e];return!!t&&!!t[n.slice(0,4)]}function Js(n,e,t=!0){return!n.split(",").some(i=>!Ma(i,e,t))}function Ma(n,e,t=!0){var i;const s=Et(t);return(i=s==null?void 0:s.isTypeSupported(Zt(n,e)))!=null?i:!1}function Zt(n,e){return`${e}/mp4;codecs="${n}"`}function Na(n){if(n){const e=n.substring(0,4);return yi.video[e]}return 2}function vi(n){return n.split(",").reduce((e,t)=>{const i=yi.video[t];return i?(i*2+e)/(e?3:2):(yi.audio[t]+e)/(e?2:1)},0)}const en={};function _u(n,e=!0){if(en[n])return en[n];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[n];for(let i=0;i<t.length;i++)if(Ma(t[i],"audio",e))return en[n]=t[i],t[i];return n}const Cu=/flac|opus/i;function Ei(n,e=!0){return n.replace(Cu,t=>_u(t.toLowerCase(),e))}function Ua(n,e){return n&&n!=="mp4a"?n:e}function bu(n){const e=n.split(".");if(e.length>2){let t=e.shift()+".";return t+=parseInt(e.shift()).toString(16),t+=("000"+parseInt(e.shift()).toString(16)).slice(-4),t}return n}const Ba=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,$a=/#EXT-X-MEDIA:(.*)/g,Au=/^#EXT(?:INF|-X-TARGETDURATION):/m,Ga=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),wu=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Ge{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static resolve(e,t){return $s.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return Au.test(e)}static parseMasterPlaylist(e,t){const i=Fa(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];Ba.lastIndex=0;let a;for(;(a=Ba.exec(e))!=null;)if(a[1]){var o;const c=new ae(a[1]);_e(s,c,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const h=Zs(s,a[2]),u={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:Ge.resolve(h,t)},d=c.decimalResolution("RESOLUTION");d&&(u.width=d.width,u.height=d.height),Ru(c.CODECS,u),(o=u.unknownCodecs)!=null&&o.length||r.push(u),s.levels.push(u)}else if(a[3]){const c=a[3],h=a[4];switch(c){case"SESSION-DATA":{const u=new ae(h);_e(s,u,["DATA-ID","LANGUAGE","VALUE","URI"]);const d=u["DATA-ID"];d&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[d]=u);break}case"SESSION-KEY":{const u=Va(h,t,s);u.encrypted&&u.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(u)):x.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${h}"`);break}case"DEFINE":{{const u=new ae(h);_e(s,u,["NAME","VALUE","QUERYPARAM"]),Oa(s,u,t)}break}case"CONTENT-STEERING":{const u=new ae(h);_e(s,u,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:Ge.resolve(u["SERVER-URI"],t),pathwayId:u["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=Ha(h);break}}}const l=r.length>0&&r.length<s.levels.length;return s.levels=l?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},a=i.levels,o={AUDIO:a.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:a.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for($a.lastIndex=0;(s=$a.exec(e))!==null;){const c=new ae(s[1]),h=c.TYPE;if(h){const u=o[h],d=r[h]||[];r[h]=d,_e(i,c,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const g=c.LANGUAGE,f=c["ASSOC-LANGUAGE"],m=c.CHANNELS,p=c.CHARACTERISTICS,v=c["INSTREAM-ID"],E={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||g||"",type:h,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:g,url:c.URI?Ge.resolve(c.URI,t):""};if(f&&(E.assocLang=f),m&&(E.channels=m),p&&(E.characteristics=p),v&&(E.instreamId=v),u!=null&&u.length){const T=Ge.findGroup(u,E.groupId)||u[0];Ka(E,T,"audioCodec"),Ka(E,T,"textCodec")}d.push(E)}}return r}static parseLevelPlaylist(e,t,i,s,r,a){const o=new ya(t),l=o.fragments;let c=null,h=0,u=0,d=0,g=0,f=null,m=new di(s,t),p,v,E,T=-1,_=!1,S=null;for(Ga.lastIndex=0,o.m3u8=e,o.hasVariableRefs=Fa(e);(p=Ga.exec(e))!==null;){_&&(_=!1,m=new di(s,t),m.start=d,m.sn=h,m.cc=g,m.level=i,c&&(m.initSegment=c,m.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null,S&&(m.setByteRange(S),S=null)));const k=p[1];if(k){m.duration=parseFloat(k);const R=(" "+p[2]).slice(1);m.title=R||null,m.tagList.push(R?["INF",k,R]:["INF",k])}else if(p[3]){if(N(m.duration)){m.start=d,E&&za(m,E,o),m.sn=h,m.level=i,m.cc=g,l.push(m);const R=(" "+p[3]).slice(1);m.relurl=Zs(o,R),Wa(m,f),f=m,d+=m.duration,h++,u=0,_=!0}}else if(p[4]){const R=(" "+p[4]).slice(1);f?m.setByteRange(R,f):m.setByteRange(R)}else if(p[5])m.rawProgramDateTime=(" "+p[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),T===-1&&(T=l.length);else{if(p=p[0].match(wu),!p){x.warn("No matches on slow regex match for level playlist!");continue}for(v=1;v<p.length&&!(typeof p[v]<"u");v++);const R=(" "+p[v]).slice(1),P=(" "+p[v+1]).slice(1),W=p[v+2]?(" "+p[v+2]).slice(1):"";switch(R){case"PLAYLIST-TYPE":o.type=P.toUpperCase();break;case"MEDIA-SEQUENCE":h=o.startSN=parseInt(P);break;case"SKIP":{const O=new ae(P);_e(o,O,["RECENTLY-REMOVED-DATERANGES"]);const H=O.decimalInteger("SKIPPED-SEGMENTS");if(N(H)){o.skippedSegments=H;for(let Y=H;Y--;)l.unshift(null);h+=H}const J=O.enumeratedString("RECENTLY-REMOVED-DATERANGES");J&&(o.recentlyRemovedDateranges=J.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(P),1);break;case"VERSION":o.version=parseInt(P);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(P||W)&&m.tagList.push(W?[P,W]:[P]);break;case"DISCONTINUITY":g++,m.tagList.push(["DIS"]);break;case"GAP":m.gap=!0,m.tagList.push([R]);break;case"BITRATE":m.tagList.push([R,P]);break;case"DATERANGE":{const O=new ae(P);_e(o,O,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),_e(o,O,O.clientAttrs);const H=new Vs(O,o.dateRanges[O.ID]);H.isValid||o.skippedSegments?o.dateRanges[H.id]=H:x.warn(`Ignoring invalid DATERANGE tag: "${P}"`),m.tagList.push(["EXT-X-DATERANGE",P]);break}case"DEFINE":{{const O=new ae(P);_e(o,O,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in O?xu(o,O,a):Oa(o,O,t)}break}case"DISCONTINUITY-SEQUENCE":g=parseInt(P);break;case"KEY":{const O=Va(P,t,o);if(O.isSupported()){if(O.method==="NONE"){E=void 0;break}E||(E={}),E[O.keyFormat]&&(E=he({},E)),E[O.keyFormat]=O}else x.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${P}"`);break}case"START":o.startTimeOffset=Ha(P);break;case"MAP":{const O=new ae(P);if(_e(o,O,["BYTERANGE","URI"]),m.duration){const H=new di(s,t);Ya(H,O,i,E),c=H,m.initSegment=c,c.rawProgramDateTime&&!m.rawProgramDateTime&&(m.rawProgramDateTime=c.rawProgramDateTime)}else{const H=m.byteRangeEndOffset;if(H){const J=m.byteRangeStartOffset;S=`${H-J}@${J}`}else S=null;Ya(m,O,i,E),c=m,_=!0}break}case"SERVER-CONTROL":{const O=new ae(P);o.canBlockReload=O.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=O.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&O.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=O.optionalFloat("PART-HOLD-BACK",0),o.holdBack=O.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const O=new ae(P);o.partTarget=O.decimalFloatingPoint("PART-TARGET");break}case"PART":{let O=o.partList;O||(O=o.partList=[]);const H=u>0?O[O.length-1]:void 0,J=u++,Y=new ae(P);_e(o,Y,["BYTERANGE","URI"]);const V=new pa(Y,m,t,J,H);O.push(V),m.duration+=V.duration;break}case"PRELOAD-HINT":{const O=new ae(P);_e(o,O,["URI"]),o.preloadHint=O;break}case"RENDITION-REPORT":{const O=new ae(P);_e(o,O,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(O);break}default:x.warn(`line parsed but not handled: ${p}`);break}}}f&&!f.relurl?(l.pop(),d-=f.duration,o.partList&&(o.fragmentHint=f)):o.partList&&(Wa(m,f),m.cc=g,o.fragmentHint=m,E&&za(m,E,o));const A=l.length,b=l[0],D=l[A-1];if(d+=o.skippedSegments*o.targetduration,d>0&&A&&D){o.averagetargetduration=d/A;const k=D.sn;o.endSN=k!=="initSegment"?k:0,o.live||(D.endList=!0),b&&(o.startCC=b.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(d+=o.fragmentHint.duration),o.totalduration=d,o.endCC=g,T>0&&Iu(l,T),o}}function Va(n,e,t){var i,s;const r=new ae(n);_e(t,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=(i=r.METHOD)!=null?i:"",o=r.URI,l=r.hexadecimalInteger("IV"),c=r.KEYFORMATVERSIONS,h=(s=r.KEYFORMAT)!=null?s:"identity";o&&r.IV&&!l&&x.error(`Invalid IV: ${r.IV}`);const u=o?Ge.resolve(o,e):"",d=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Rt(a,u,h,d,l)}function Ha(n){const t=new ae(n).decimalFloatingPoint("TIME-OFFSET");return N(t)?t:null}function Ru(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=t.filter(r=>Lu(r,i));s.length&&(e[`${i}Codec`]=s.join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function Ka(n,e,t){const i=e[t];i&&(n[t]=i)}function Iu(n,e){let t=n[e];for(let i=e;i--;){const s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function Wa(n,e){n.rawProgramDateTime?n.programDateTime=Date.parse(n.rawProgramDateTime):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime),N(n.programDateTime)||(n.programDateTime=null,n.rawProgramDateTime=null)}function Ya(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function za(n,e,t){n.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}var Q={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},B={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function ja(n){const{type:e}=n;switch(e){case Q.AUDIO_TRACK:return B.AUDIO;case Q.SUBTITLE_TRACK:return B.SUBTITLE;default:return B.MAIN}}function tn(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class Du{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,a=new r(t);return this.loaders[e.type]=a,a}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Q.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:s,pathwayId:r,url:a,deliveryDirectives:o}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:Q.LEVEL,url:a,deliveryDirectives:o})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.AUDIO_TRACK,url:r,deliveryDirectives:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.SUBTITLE_TRACK,url:r,deliveryDirectives:a})}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const c=s.context;if(c&&c.url===e.url&&c.level===e.level){x.trace("[playlist-loader]: playlist request ongoing");return}x.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===Q.MANIFEST?r=i.manifestLoadPolicy.default:r=he({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),N((t=e.deliveryDirectives)==null?void 0:t.part)){let c;if(e.type===Q.LEVEL&&e.level!==null?c=this.hls.levels[e.level].details:e.type===Q.AUDIO_TRACK&&e.id!==null?c=this.hls.audioTracks[e.id].details:e.type===Q.SUBTITLE_TRACK&&e.id!==null&&(c=this.hls.subtitleTracks[e.id].details),c){const h=c.partTarget,u=c.targetduration;if(h&&u){const d=Math.max(h*3,u*.8)*1e3;r=he({},r,{maxTimeToFirstByteMs:Math.min(d,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(d,r.maxTimeToFirstByteMs)})}}}const a=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(c,h,u,d)=>{const g=this.getInternalLoader(u);this.resetInternalLoader(u.type);const f=c.data;if(f.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(c,u,new Error("no EXTM3U delimiter"),d||null,h);return}h.parsing.start=performance.now(),Ge.isMediaPlaylist(f)?this.handleTrackOrLevelPlaylist(c,h,u,d||null,g):this.handleMasterPlaylist(c,h,u,d)},onError:(c,h,u,d)=>{this.handleNetworkError(h,u,!1,c,d)},onTimeout:(c,h,u)=>{this.handleNetworkError(h,u,!0,void 0,c)}};s.load(e,o,l)}handleMasterPlaylist(e,t,i,s){const r=this.hls,a=e.data,o=tn(e,i),l=Ge.parseMasterPlaylist(a,o);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,s,t);return}const{contentSteering:c,levels:h,sessionData:u,sessionKeys:d,startTimeOffset:g,variableList:f}=l;this.variableList=f;const{AUDIO:m=[],SUBTITLES:p,"CLOSED-CAPTIONS":v}=Ge.parseMasterPlaylistMedia(a,o,l);m.length&&!m.some(T=>!T.url)&&h[0].audioCodec&&!h[0].attrs.AUDIO&&(x.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ae({}),bitrate:0,url:""})),r.trigger(y.MANIFEST_LOADED,{levels:h,audioTracks:m,subtitles:p,captions:v,contentSteering:c,url:o,stats:t,networkDetails:s,sessionData:u,sessionKeys:d,startTimeOffset:g,variableList:f})}handleTrackOrLevelPlaylist(e,t,i,s,r){const a=this.hls,{id:o,level:l,type:c}=i,h=tn(e,i),u=0,d=N(l)?l:N(o)?o:0,g=ja(i),f=Ge.parseLevelPlaylist(e.data,h,d,g,u,this.variableList);if(c===Q.MANIFEST){const m={attrs:new ae({}),bitrate:0,details:f,name:"",url:h};a.trigger(y.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:h,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=f,this.handlePlaylistLoaded(f,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(y.ERROR,{type:$.NETWORK_ERROR,details:C.MANIFEST_PARSING_ERROR,fatal:t.type===Q.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let a=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===Q.LEVEL?a+=`: ${e.level} id: ${e.id}`:(e.type===Q.AUDIO_TRACK||e.type===Q.SUBTITLE_TRACK)&&(a+=` id: ${e.id} group-id: "${e.groupId}"`);const o=new Error(a);x.warn(`[playlist-loader]: ${a}`);let l=C.UNKNOWN,c=!1;const h=this.getInternalLoader(e);switch(e.type){case Q.MANIFEST:l=i?C.MANIFEST_LOAD_TIMEOUT:C.MANIFEST_LOAD_ERROR,c=!0;break;case Q.LEVEL:l=i?C.LEVEL_LOAD_TIMEOUT:C.LEVEL_LOAD_ERROR,c=!1;break;case Q.AUDIO_TRACK:l=i?C.AUDIO_TRACK_LOAD_TIMEOUT:C.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case Q.SUBTITLE_TRACK:l=i?C.SUBTITLE_TRACK_LOAD_TIMEOUT:C.SUBTITLE_LOAD_ERROR,c=!1;break}h&&this.resetInternalLoader(e.type);const u={type:$.NETWORK_ERROR,details:l,fatal:c,url:e.url,loader:h,context:e,error:o,networkDetails:t,stats:r};if(s){const d=(t==null?void 0:t.url)||e.url;u.response=fe({url:d,data:void 0},s)}this.hls.trigger(y.ERROR,u)}handlePlaylistLoaded(e,t,i,s,r,a){const o=this.hls,{type:l,level:c,id:h,groupId:u,deliveryDirectives:d}=s,g=tn(t,s),f=ja(s),m=typeof s.level=="number"&&f===B.MAIN?c:void 0;if(!e.fragments.length){const v=new Error("No Segments found in Playlist");o.trigger(y.ERROR,{type:$.NETWORK_ERROR,details:C.LEVEL_EMPTY_ERROR,fatal:!1,url:g,error:v,reason:v.message,response:t,context:s,level:m,parent:f,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const p=e.playlistParsingError;if(p){o.trigger(y.ERROR,{type:$.NETWORK_ERROR,details:C.LEVEL_PARSING_ERROR,fatal:!1,url:g,error:p,reason:p.message,response:t,context:s,level:m,parent:f,networkDetails:r,stats:i});return}switch(e.live&&a&&(a.getCacheAge&&(e.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case Q.MANIFEST:case Q.LEVEL:o.trigger(y.LEVEL_LOADED,{details:e,level:m||0,id:h||0,stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.AUDIO_TRACK:o.trigger(y.AUDIO_TRACK_LOADED,{details:e,id:h||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.SUBTITLE_TRACK:o.trigger(y.SUBTITLE_TRACK_LOADED,{details:e,id:h||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break}}}function qa(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function Xa(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){x.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){x.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function It(n){const e=n.mode;if(e==="disabled"&&(n.mode="hidden"),n.cues)for(let t=n.cues.length;t--;)n.removeCue(n.cues[t]);e==="disabled"&&(n.mode=e)}function sn(n,e,t,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=ku(n.cues,e,t);for(let a=0;a<r.length;a++)(!i||i(r[a]))&&n.removeCue(r[a])}s==="disabled"&&(n.mode=s)}function Pu(n,e){if(e<n[0].startTime)return 0;const t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t;for(;i<=s;){const r=Math.floor((s+i)/2);if(e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r}return n[i].startTime-e<e-n[s].startTime?i:s}function ku(n,e,t){const i=[],s=Pu(n,e);if(s>-1)for(let r=s,a=n.length;r<a;r++){const o=n[r];if(o.startTime>=e&&o.endTime<=t)i.push(o);else if(o.startTime>t)return i}return i}function Ti(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}var Re={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const Fu=.25;function nn(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Qa(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,JSON.stringify(s?fe({type:s},i):i))}return r}const Si=(()=>{const n=nn();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function rn(n,e){return n.getTime()/1e3-e}function Ou(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class Mu{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(It(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return qa(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=nn();if(a)for(let o=0;o<r.length;o++){const l=r[o].type;if(l===Re.emsg&&!i||!s)continue;const c=_a(r[o].data);if(c){const h=r[o].pts;let u=h+r[o].duration;u>Si&&(u=Si),u-h<=0&&(u=h+Fu);for(let g=0;g<c.length;g++){const f=c[g];if(!La(f)){this.updateId3CueEnds(h,l);const m=Qa(a,h,u,f,l);m&&this.id3Track.addCue(m)}}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const a=s[r];a.type===t&&a.startTime<e&&a.endTime===Si&&(a.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:a}=this;if(!a)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=a;if(r&&(o||l)){let c;s==="audio"?c=h=>h.type===Re.audioId3&&l:s==="video"?c=h=>h.type===Re.emsg&&o:c=h=>h.type===Re.audioId3&&l||h.type===Re.emsg&&o,sn(r,t,i,c)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:s}=this,{dateRanges:r}=t,a=Object.keys(r);if(s){const h=Object.keys(i).filter(u=>!a.includes(u));for(let u=h.length;u--;){const d=h[u];Object.keys(i[d].cues).forEach(g=>{s.removeCue(i[d].cues[g])}),delete i[d]}}const o=t.fragments[t.fragments.length-1];if(a.length===0||!N(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,c=nn();for(let h=0;h<a.length;h++){const u=a[h],d=r[u],g=rn(d.startDate,l),f=i[u],m=(f==null?void 0:f.cues)||{};let p=(f==null?void 0:f.durationKnown)||!1,v=Si;const E=d.endDate;if(E)v=rn(E,l),p=!0;else if(d.endOnNext&&!p){const _=a.reduce((S,A)=>{if(A!==d.id){const b=r[A];if(b.class===d.class&&b.startDate>d.startDate&&(!S||d.startDate<S.startDate))return b}return S},null);_&&(v=rn(_.startDate,l),p=!0)}const T=Object.keys(d.attr);for(let _=0;_<T.length;_++){const S=T[_];if(!Vh(S))continue;const A=m[S];if(A)p&&!f.durationKnown&&(A.endTime=v);else if(c){let b=d.attr[S];Hh(S)&&(b=Ou(b));const D=Qa(c,g,v,{key:S,data:b},Re.dateRange);D&&(D.id=u,this.id3Track.addCue(D),m[S]=D)}}i[u]={cues:m,dateRange:d,durationKnown:p}}}}class Nu{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(e===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:a,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let c=o&&i||t;(l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=r!==void 0?r:a*s);const h=s;return c+Math.min(this.stallCount*1,h)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(e===null||t===null||i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,a=s-i.totalduration,o=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(a,r),o)}get drift(){const{levelDetails:e}=this;return e===null?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(y.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(y.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===C.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&x.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||r===1||!t.live)return;const a=this.targetLatency;if(a===null)return;const o=i-a,l=Math.min(this.maxLatency,a+t.targetduration);if(o<l&&o>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,r)),u=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;e.playbackRate=Math.min(h,Math.max(1,u))}else e.playbackRate!==1&&e.playbackRate!==0&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}const an=["NONE","TYPE-0","TYPE-1",null];function Uu(n){return an.indexOf(n)>-1}const xi=["SDR","PQ","HLG"];function Bu(n){return!!n&&xi.indexOf(n)>-1}var Dt={No:"",Yes:"YES",v2:"v2"};function $u(n,e){const{canSkipUntil:t,canSkipDateRanges:i,endSN:s}=n,r=e!==void 0?e-s:0;return t&&r<t?i?Dt.v2:Dt.Yes:Dt.No}class on{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Tt{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(t=>!!t).map(t=>t.substring(0,4)).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Za(this._audioGroups,e)}hasSubtitleGroup(e){return Za(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function Za(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function ln(n,e){const t=e.startPTS;if(N(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&(s.duration=i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.start=n.start+(n.minEndPTS-n.start):e.start=n.start+n.duration:e.start=Math.max(n.start-e.duration,0)}function Ja(n,e,t,i,s,r){i-t<=0&&(x.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let o=t,l=i;const c=e.startPTS,h=e.endPTS;if(N(c)){const p=Math.abs(c-t);N(e.deltaPTS)?e.deltaPTS=Math.max(p,e.deltaPTS):e.deltaPTS=p,o=Math.max(t,c),t=Math.min(t,c),s=Math.min(s,e.startDTS),l=Math.min(i,h),i=Math.max(i,h),r=Math.max(r,e.endDTS)}const u=t-e.start;e.start!==0&&(e.start=t),e.duration=i-e.start,e.startPTS=t,e.maxStartPTS=o,e.startDTS=s,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const d=e.sn;if(!n||d<n.startSN||d>n.endSN)return 0;let g;const f=d-n.startSN,m=n.fragments;for(m[f]=e,g=f;g>0;g--)ln(m[g],m[g-1]);for(g=f;g<m.length-1;g++)ln(m[g],m[g+1]);return n.fragmentHint&&ln(m[m.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,u}function Gu(n,e){let t=null;const i=n.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){t=c;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s=0,r;if(Ku(n,e,(l,c)=>{l.relurl&&(s=l.cc-c.cc),N(l.startPTS)&&N(l.endPTS)&&(c.start=c.startPTS=l.startPTS,c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.duration=l.endPTS-l.startPTS,c.duration&&(r=c),e.PTSKnown=e.alignedSliding=!0),c.elementaryStreams=l.elementaryStreams,c.loader=l.loader,c.stats=l.stats,l.initSegment&&(c.initSegment=l.initSegment,t=l.initSegment)}),t&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(c=>{var h;c&&(!c.initSegment||c.initSegment.relurl===((h=t)==null?void 0:h.relurl))&&(c.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some(l=>!l),e.deltaUpdateFailed){x.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=Vu(n.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const a=e.fragments;if(s){x.warn("discontinuity sliding from playlist, take drift into account");for(let l=0;l<a.length;l++)a[l].cc+=s}e.skippedSegments&&(e.startCC=e.fragments[0].cc),Hu(n.partList,e.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),r?Ja(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):eo(n,e),a.length&&(e.totalduration=e.edge-a[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const l=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=l),e.driftEndTime=o,e.driftEnd=l}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime}function Vu(n,e,t){const i=he({},n);return t&&t.forEach(s=>{delete i[s]}),Object.keys(e).forEach(s=>{const r=new Vs(e[s].attr,i[s]);r.isValid?i[s]=r:x.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[s].attr)}"`)}),i}function Hu(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){const a=n[s],o=e[s+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?t(a,o):i--}}}function Ku(n,e,t){const i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,a=e.startSN-n.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let c=s;c<=r;c++){const h=l[a+c];let u=o[c];i&&!u&&c<i&&(u=e.fragments[c]=h),h&&u&&t(h,u)}}function eo(n,e){const t=e.startSN+e.skippedSegments-n.startSN,i=n.fragments;t<0||t>=i.length||cn(e,i[t].start)}function cn(n,e){if(e){const t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].start+=e;n.fragmentHint&&(n.fragmentHint.start+=e)}}function Wu(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function Yu(n,e,t){if(!(n!=null&&n.details))return null;const i=n.details;let s=i.fragments[e-i.startSN];return s||(s=i.fragmentHint,s&&s.sn===e)?s:e<i.startSN&&t&&t.sn===e?t:null}function to(n,e,t){var i;return n!=null&&n.details?io((i=n.details)==null?void 0:i.partList,e,t):null}function io(n,e,t){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function so(n){n.forEach((e,t)=>{const{details:i}=e;i!=null&&i.fragments&&i.fragments.forEach(s=>{s.level=t})})}function Li(n){switch(n.details){case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_TIMEOUT:case C.LEVEL_LOAD_TIMEOUT:case C.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function no(n,e){const t=Li(e);return n.default[`${t?"timeout":"error"}Retry`]}function hn(n,e){const t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function ro(n){return fe(fe({},n),{errorRetry:null,timeoutRetry:null})}function _i(n,e,t,i){if(!n)return!1;const s=i==null?void 0:i.code,r=e<n.maxNumRetry&&(zu(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function zu(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}const ao={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];const a=e(r);if(a>0)t=s+1;else if(a<0)i=s-1;else return r}return null}};function ju(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!N(e))return null;const i=n[0].programDateTime;if(e<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;t=t||0;for(let r=0;r<n.length;++r){const a=n[r];if(qu(e,t,a))return a}return null}function Ci(n,e,t=0,i=0){let s=null;if(n){s=e[n.sn-e[0].sn+1]||null;const a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7)}else t===0&&e[0].start===0&&(s=e[0]);if(s&&(!n||n.level===s.level)&&un(t,i,s)===0)return s;const r=ao.search(e,un.bind(null,t,i));return r&&(r!==n||!s)?r:s}function un(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function qu(n,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function Xu(n,e){return ao.search(n,t=>t.cc<e?1:t.cc>e?-1:0)}var de={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Ie={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class oo{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=x.log.bind(x,"[info]:"),this.warn=x.warn.bind(x,"[warning]:"),this.error=x.error.bind(x,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.ERROR,this.onError,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.ERROR,this.onError,this),e.off(y.ERROR,this.onErrorOut,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===B.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i,s;if(t.fatal)return;const r=this.hls,a=t.context;switch(t.details){case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case C.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction={action:de.DoNothing,flags:Ie.None};return}case C.FRAG_GAP:case C.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=de.SendAlternateToPenaltyBox;return}case C.LEVEL_EMPTY_ERROR:case C.LEVEL_PARSING_ERROR:{var o,l;const c=t.parent===B.MAIN?t.level:r.loadLevel;t.details===C.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(l=o.levelDetails)!=null&&l.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case C.LEVEL_LOAD_ERROR:case C.LEVEL_LOAD_TIMEOUT:typeof(a==null?void 0:a.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,a.level));return;case C.AUDIO_TRACK_LOAD_ERROR:case C.AUDIO_TRACK_LOAD_TIMEOUT:case C.SUBTITLE_LOAD_ERROR:case C.SUBTITLE_TRACK_LOAD_TIMEOUT:if(a){const c=r.levels[r.loadLevel];if(c&&(a.type===Q.AUDIO_TRACK&&c.hasAudioGroup(a.groupId)||a.type===Q.SUBTITLE_TRACK&&c.hasSubtitleGroup(a.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=de.SendAlternateToPenaltyBox,t.errorAction.flags=Ie.MoveAllAlternatesMatchingHost;return}}return;case C.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=r.levels[r.loadLevel],h=c==null?void 0:c.attrs["HDCP-LEVEL"];h?t.errorAction={action:de.SendAlternateToPenaltyBox,flags:Ie.MoveAllAlternatesMatchingHDCP,hdcpLevel:h}:this.keySystemError(t)}return;case C.BUFFER_ADD_CODEC_ERROR:case C.REMUX_ALLOC_ERROR:case C.BUFFER_APPEND_ERROR:t.errorAction=this.getLevelSwitchAction(t,(s=t.level)!=null?s:r.loadLevel);return;case C.INTERNAL_EXCEPTION:case C.BUFFER_APPENDING_ERROR:case C.BUFFER_FULL_ERROR:case C.LEVEL_SWITCH_ERROR:case C.BUFFER_STALLED_ERROR:case C.BUFFER_SEEK_OVER_HOLE:case C.BUFFER_NUDGE_ON_STALL:t.errorAction={action:de.DoNothing,flags:Ie.None};return}t.type===$.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,s=no(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(_i(s,r,Li(e),e.response))return{action:de.RetryRequest,flags:Ie.None,retryConfig:s,retryCount:r};const o=this.getLevelSwitchAction(e,t);return s&&(o.retryConfig=s,o.retryCount=r),o}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=t.config,o=no(e.details.startsWith("key")?a:r,e),l=t.levels.reduce((h,u)=>h+u.fragmentError,0);if(s&&(e.details!==C.FRAG_GAP&&s.fragmentError++,_i(o,l,Li(e),e.response)))return{action:de.RetryRequest,flags:Ie.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s){var r,a;const c=e.details;s.loadError++,c===C.BUFFER_APPEND_ERROR&&s.fragmentError++;let h=-1;const{levels:u,loadLevel:d,minAutoLevel:g,maxAutoLevel:f}=i;i.autoLevelEnabled||(i.loadLevel=-1);const m=(r=e.frag)==null?void 0:r.type,v=(m===B.AUDIO&&c===C.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===C.BUFFER_ADD_CODEC_ERROR||c===C.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:A})=>s.audioCodec!==A),T=e.sourceBufferName==="video"&&(c===C.BUFFER_ADD_CODEC_ERROR||c===C.BUFFER_APPEND_ERROR)&&u.some(({codecSet:A,audioCodec:b})=>s.codecSet!==A&&s.audioCodec===b),{type:_,groupId:S}=(a=e.context)!=null?a:{};for(let A=u.length;A--;){const b=(A+d)%u.length;if(b!==d&&b>=g&&b<=f&&u[b].loadError===0){var o,l;const D=u[b];if(c===C.FRAG_GAP&&e.frag){const k=u[b].details;if(k){const R=Ci(e.frag,k.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else{if(_===Q.AUDIO_TRACK&&D.hasAudioGroup(S)||_===Q.SUBTITLE_TRACK&&D.hasSubtitleGroup(S))continue;if(m===B.AUDIO&&(o=s.audioGroups)!=null&&o.some(k=>D.hasAudioGroup(k))||m===B.SUBTITLE&&(l=s.subtitleGroups)!=null&&l.some(k=>D.hasSubtitleGroup(k))||v&&s.audioCodec===D.audioCodec||!v&&s.audioCodec!==D.audioCodec||T&&s.codecSet===D.codecSet)continue}h=b;break}}if(h>-1&&i.loadLevel!==h)return e.levelRetry=!0,this.playlistError=0,{action:de.SendAlternateToPenaltyBox,flags:Ie.None,nextAutoLevel:h}}return{action:de.SendAlternateToPenaltyBox,flags:Ie.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case de.DoNothing:break;case de.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==C.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case de.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:a}=i;switch(s){case Ie.None:this.switchLevel(e,a);break;case Ie.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=an[an.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,a)}switchLevel(e,t){t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class bi{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=x.log.bind(x,`${t}:`),this.warn=x.warn.bind(x,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=t==null?void 0:t.renditionReports;if(i){let s=-1;for(let r=0;r<i.length;r++){const a=i[r];let o;try{o=new self.URL(a.URI,t.url).href}catch(l){x.warn(`Could not construct new URL for Rendition Report: ${l}`),o=a.URI||""}if(o===e){s=r;break}else o===e.substring(0,o.length)&&(s=r)}if(s!==-1){const r=i[s],a=parseInt(r["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let o=parseInt(r["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const l=Math.min(t.age-t.partTarget,t.targetduration);o>=0&&l>t.partTarget&&(o+=1)}return new on(a,o>=0?o:void 0,Dt.No)}}}loadPlaylist(e){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:s,stats:r}=t,a=self.performance.now(),o=r.loading.first?Math.max(0,a-r.loading.first):0;if(s.advancedDateTime=Date.now()-o,s.live||i!=null&&i.live){if(s.reloaded(i),i&&this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),i&&s.fragments.length>0&&Gu(i,s),!this.canLoad||!s.live)return;let l,c,h;if(s.canBlockReload&&s.endSN&&s.advanced){const p=this.hls.config.lowLatencyMode,v=s.lastPartSn,E=s.endSN,T=s.lastPartIndex,_=T!==-1,S=v===E,A=p?0:T;_?(c=S?E+1:v,h=S?A:T+1):c=E+1;const b=s.age,D=b+s.ageHeader;let k=Math.min(D-s.partTarget,s.targetduration*1.5);if(k>0){if(i&&k>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${k} with playlist age: ${s.age}`),k=0;else{const R=Math.floor(k/s.targetduration);if(c+=R,h!==void 0){const P=Math.round(k%s.targetduration/s.partTarget);h+=P}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${b.toFixed(2)}s goal: ${k} skip sn ${R} to part ${h}`)}s.tuneInGoal=k}if(l=this.getDeliveryDirectives(s,t.deliveryDirectives,c,h),p||!S){this.loadPlaylist(l);return}}else(s.canBlockReload||s.canSkipUntil)&&(l=this.getDeliveryDirectives(s,t.deliveryDirectives,c,h));const u=this.hls.mainForwardBufferInfo,d=u?u.end-u.len:0,g=(s.edge-d)*1e3,f=Wu(s,g);s.updated&&a>this.requestScheduled+f&&(this.requestScheduled=r.loading.start),c!==void 0&&s.canBlockReload?this.requestScheduled=r.loading.first+f-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+f<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=f);let m=this.requestScheduled-a;m=Math.max(0,m),this.log(`reload live playlist ${e} in ${Math.round(m)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),m)}else this.clearTimer()}getDeliveryDirectives(e,t,i,s){let r=$u(e,i);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=Dt.No),new on(i,s,r)}checkRetry(e){const t=e.details,i=Li(e),s=e.errorAction,{action:r,retryCount:a=0,retryConfig:o}=s||{},l=!!s&&!!o&&(r===de.RetryRequest||!s.resolved&&r===de.SendAlternateToPenaltyBox);if(l){var c;if(this.requestScheduled=-1,a>=o.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const h=hn(o,a);this.timer=self.setTimeout(()=>this.loadPlaylist(),h),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${h}ms`)}e.levelRetry=!0,s.resolved=!0}return l}}class Pt{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Qu{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Pt(e),this.fast_=new Pt(t),this.defaultTTFB_=s,this.ttfb_=new Pt(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new Pt(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new Pt(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new Pt(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const lo={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},co={};function Zu(n,e,t,i,s,r){const a=n.audioCodec?n.audioGroups:null,o=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,c=l?parseInt(l):o?1/0:2;let h=null;if(a!=null&&a.length)try{a.length===1&&a[0]?h=e.groups[a[0]].channels:h=a.reduce((u,d)=>{if(d){const g=e.groups[d];if(!g)throw new Error(`Audio track group ${d} not found`);Object.keys(g.channels).forEach(f=>{u[f]=(u[f]||0)+g.channels[f]})}return u},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!h&&N(c)&&Object.keys(h).some(u=>parseInt(u)>c)}function Ju(n,e,t){const i=n.videoCodec,s=n.audioCodec;if(!i||!s||!t)return Promise.resolve(lo);const r={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(r.transferFunction=a.toLowerCase());const o=i.split(",").map(l=>({type:"media-source",video:fe(fe({},r),{},{contentType:Zt(l,"video")})}));return s&&n.audioGroups&&n.audioGroups.forEach(l=>{var c;l&&((c=e.groups[l])==null||c.tracks.forEach(h=>{if(h.groupId===l){const u=h.channels||"",d=parseFloat(u);N(d)&&d>2&&o.push.apply(o,s.split(",").map(g=>({type:"media-source",audio:{contentType:Zt(g,"audio"),channels:""+d}})))}}))}),Promise.all(o.map(l=>{const c=ed(l);return co[c]||(co[c]=t.decodingInfo(l))})).then(l=>({supported:!l.some(c=>!c.supported),configurations:o,decodingInfoResults:l})).catch(l=>({supported:!1,configurations:o,decodingInfoResults:[],error:l}))}function ed(n){const{audio:e,video:t}=n,i=t||e;if(i){const s=i.contentType.split('"')[1];if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${s}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${s}`}return""}function td(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function id(n,e){let t=!1,i=[];return n&&(t=n!=="SDR",i=[n]),e&&(i=e.allowedVideoRanges||xi.slice(0),t=e.preferHDR!==void 0?e.preferHDR:td(),t?i=i.filter(s=>s!=="SDR"):i=["SDR"]),{preferHDR:t,allowedVideoRanges:i}}function sd(n,e,t,i,s){const r=Object.keys(n),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=a&&parseInt(a)===2;let c=!0,h=!1,u=1/0,d=1/0,g=1/0,f=0,m=[];const{preferHDR:p,allowedVideoRanges:v}=id(e,s);for(let S=r.length;S--;){const A=n[r[S]];c=A.channels[2]>0,u=Math.min(u,A.minHeight),d=Math.min(d,A.minFramerate),g=Math.min(g,A.minBitrate);const b=v.filter(D=>A.videoRanges[D]>0);b.length>0&&(h=!0,m=b)}u=N(u)?u:0,d=N(d)?d:0;const E=Math.max(1080,u),T=Math.max(30,d);return g=N(g)?g:t,t=Math.max(g,t),h||(e=void 0,m=[]),{codecSet:r.reduce((S,A)=>{const b=n[A];if(A===S)return S;if(b.minBitrate>t)return je(A,`min bitrate of ${b.minBitrate} > current estimate of ${t}`),S;if(!b.hasDefaultAudio)return je(A,"no renditions with default or auto-select sound found"),S;if(o&&A.indexOf(o.substring(0,4))%5!==0)return je(A,`audio codec preference "${o}" not found`),S;if(a&&!l){if(!b.channels[a])return je(A,`no renditions with ${a} channel sound found (channels options: ${Object.keys(b.channels)})`),S}else if((!o||l)&&c&&b.channels[2]===0)return je(A,"no renditions with stereo sound found"),S;return b.minHeight>E?(je(A,`min resolution of ${b.minHeight} > maximum of ${E}`),S):b.minFramerate>T?(je(A,`min framerate of ${b.minFramerate} > maximum of ${T}`),S):m.some(D=>b.videoRanges[D]>0)?b.maxScore<f?(je(A,`max score of ${b.maxScore} < selected max of ${f}`),S):S&&(vi(A)>=vi(S)||b.fragmentError>n[S].fragmentError)?S:(f=b.maxScore,A):(je(A,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),S)},void 0),videoRanges:m,preferHDR:p,minFramerate:d,minBitrate:g}}function je(n,e){x.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function nd(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function rd(n,e,t,i){return n.slice(t,i+1).reduce((s,r)=>{if(!r.codecSet)return s;const a=r.audioGroups;let o=s[r.codecSet];o||(s[r.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,r.bitrate);const l=Math.min(r.height,r.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,r.frameRate),o.maxScore=Math.max(o.maxScore,r.score),o.fragmentError+=r.fragmentError,o.videoRanges[r.videoRange]=(o.videoRanges[r.videoRange]||0)+1,a&&a.forEach(c=>{if(!c)return;const h=e.groups[c];o.hasDefaultAudio=o.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(u=>{o.channels[u]=(o.channels[u]||0)+h.channels[u]})}),s},{})}function Ve(n,e,t){if("attrs"in n){const i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){const s=e[i];if(kt(n,s,t))return i}return-1}function kt(n,e,t){const{groupId:i,name:s,lang:r,assocLang:a,characteristics:o,default:l}=n,c=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||e.lang===r)&&(r===void 0||e.assocLang===a)&&(l===void 0||e.default===l)&&(c===void 0||e.forced===c)&&(o===void 0||ad(o,e.characteristics))&&(t===void 0||t(n,e))}function ad(n,e=""){const t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function Ft(n,e){const{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function od(n,e,t,i,s){const r=e[i],o=e.reduce((d,g,f)=>{const m=g.uri;return(d[m]||(d[m]=[])).push(f),d},{})[r.uri];o.length>1&&(i=Math.max.apply(Math,o));const l=r.videoRange,c=r.frameRate,h=r.codecSet.substring(0,4),u=ho(e,i,d=>{if(d.videoRange!==l||d.frameRate!==c||d.codecSet.substring(0,4)!==h)return!1;const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return Ve(n,f,s)>-1});return u>-1?u:ho(e,i,d=>{const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return Ve(n,f,s)>-1})}function ho(n,e,t){for(let i=e;i;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}class uo{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:t,partCurrent:i,hls:s}=this,{autoLevelEnabled:r,media:a}=s;if(!t||!a)return;const o=performance.now(),l=i?i.stats:t.stats,c=i?i.duration:t.duration,h=o-l.loading.start,u=s.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||t.level<=u){this.clearTimer(),this._nextAutoLevel=-1;return}if(!r||a.paused||!a.playbackRate||!a.readyState)return;const d=s.mainForwardBufferInfo;if(d===null)return;const g=this.bwEstimator.getEstimateTTFB(),f=Math.abs(a.playbackRate);if(h<=Math.max(g,1e3*(c/(f*2))))return;const m=d.len/f,p=l.loading.first?l.loading.first-l.loading.start:-1,v=l.loaded&&p>-1,E=this.getBwEstimate(),T=s.levels,_=T[t.level],S=l.total||Math.max(l.loaded,Math.round(c*_.maxBitrate/8));let A=v?h-p:h;A<1&&v&&(A=Math.min(h,l.loaded*8/E));const b=v?l.loaded*1e3/A:0,D=b?(S-l.loaded)/b:S*8/E+g/1e3;if(D<=m)return;const k=b?b*8:E;let R=Number.POSITIVE_INFINITY,P;for(P=t.level-1;P>u;P--){const O=T[P].maxBitrate;if(R=this.getTimeToLoadFrag(g/1e3,k,c*O,!T[P].details),R<m)break}if(R>=D||R>c*10)return;s.nextLoadLevel=s.nextAutoLevel=P,v?this.bwEstimator.sample(h-Math.min(g,p),l.loaded):this.bwEstimator.sampleTTFB(h);const W=T[P].bitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>W&&this.resetEstimator(W),this.clearTimer(),x.warn(`[abr] Fragment ${t.sn}${i?" part "+i.index:""} of level ${t.level} is loading too slowly;
      Time to underbuffer: ${m.toFixed(3)} s
      Estimated load time for current fragment: ${D.toFixed(3)} s
      Estimated load time for down switch fragment: ${R.toFixed(3)} s
      TTFB estimate: ${p|0} ms
      Current BW estimate: ${N(E)?E|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${P} @ ${W|0} bps`),s.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:i,stats:l})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(x.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new Qu(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(y.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case C.BUFFER_ADD_CODEC_ERROR:case C.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case C.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const a=performance.now(),o=r?r.stats:i.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const u=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(u,c),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,a=s?this.lastLevelLoadSec:0;return r+a}onLevelLoaded(e,t){const i=this.hls.config,{loading:s}=t.stats,r=s.end-s.start;N(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===B.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,a=this.hls.levels[t.level],o=(a.loaded?a.loaded.bytes:0)+s.loaded,l=(a.loaded?a.loaded.duration:0)+r;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(y.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==B.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;const a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return x.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const a=this.hls.levels;if(a.length>Math.max(e,r)&&a[e].loadError<=a[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){var e;return`${this.getBwEstimate()}_${(e=this.hls.mainForwardBufferInfo)==null?void 0:e.len}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:a,media:o}=i,l=t?t.duration:e?e.duration:0,c=o&&o.playbackRate!==0?Math.abs(o.playbackRate):1,h=this.getBwEstimate(),u=i.mainForwardBufferInfo,d=(u?u.len:0)/c;let g=r.abrBandWidthFactor,f=r.abrBandWidthUpFactor;if(d){const T=this.findBestLevel(h,a,s,d,0,g,f);if(T>=0)return T}let m=l?Math.min(l,r.maxStarvationDelay):r.maxStarvationDelay;if(!d){const T=this.bitrateTestDelay;T&&(m=(l?Math.min(l,r.maxLoadingDelay):r.maxLoadingDelay)-T,x.info(`[abr] bitrate test took ${Math.round(1e3*T)}ms, set first fragment max fetchDuration to ${Math.round(1e3*m)} ms`),g=f=1)}const p=this.findBestLevel(h,a,s,d,m,g,f);if(x.info(`[abr] ${d?"rebuffering expected":"buffer is empty"}, optimal quality level ${p}`),p>-1)return p;const v=i.levels[a],E=i.levels[i.loadLevel];return(v==null?void 0:v.bitrate)<(E==null?void 0:E.bitrate)?a:i.loadLevel}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,a,o){var l;const c=s+r,h=this.lastLoadedFragLevel,u=h===-1?this.hls.firstLevel:h,{fragCurrent:d,partCurrent:g}=this,{levels:f,allAudioTracks:m,loadLevel:p,config:v}=this.hls;if(f.length===1)return 0;const E=f[u],T=!!(E!=null&&(l=E.details)!=null&&l.live),_=p===-1||h===-1;let S,A="SDR",b=(E==null?void 0:E.frameRate)||0;const{audioPreference:D,videoPreference:k}=v,R=this.audioTracksByGroup||(this.audioTracksByGroup=nd(m));if(_){if(this.firstSelection!==-1)return this.firstSelection;const Y=this.codecTiers||(this.codecTiers=rd(f,R,t,i)),V=sd(Y,A,e,D,k),{codecSet:oe,videoRanges:M,minFramerate:U,minBitrate:Z,preferHDR:q}=V;S=oe,A=q?M[M.length-1]:M[0],b=U,e=Math.max(e,Z),x.log(`[abr] picked start tier ${JSON.stringify(V)}`)}else S=E==null?void 0:E.codecSet,A=E==null?void 0:E.videoRange;const P=g?g.duration:d?d.duration:0,W=this.bwEstimator.getEstimateTTFB()/1e3,O=[];for(let Y=i;Y>=t;Y--){var H,J;const V=f[Y],oe=Y>u;if(!V)continue;if(v.useMediaCapabilities&&!V.supportedResult&&!V.supportedPromise){const pe=navigator.mediaCapabilities;typeof(pe==null?void 0:pe.decodingInfo)=="function"&&Zu(V,R,A,b,e,D)?(V.supportedPromise=Ju(V,R,pe),V.supportedPromise.then(le=>{V.supportedResult=le;const Ze=this.hls.levels,Me=Ze.indexOf(V);le.error?x.warn(`[abr] MediaCapabilities decodingInfo error: "${le.error}" for level ${Me} ${JSON.stringify(le)}`):le.supported||(x.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${Me} ${JSON.stringify(le)}`),Me>-1&&Ze.length>1&&(x.log(`[abr] Removing unsupported level ${Me}`),this.hls.removeLevel(Me)))})):V.supportedResult=lo}if(S&&V.codecSet!==S||A&&V.videoRange!==A||oe&&b>V.frameRate||!oe&&b>0&&b<V.frameRate||!((H=V.supportedResult)!=null&&(J=H.decodingInfoResults)!=null&&J[0].smooth)){O.push(Y);continue}const M=V.details,U=(g?M==null?void 0:M.partTarget:M==null?void 0:M.averagetargetduration)||P;let Z;oe?Z=o*e:Z=a*e;const q=P&&s>=P*2&&r===0?f[Y].averageBitrate:f[Y].maxBitrate,ee=this.getTimeToLoadFrag(W,Z,q*U,M===void 0);if(Z>=q&&(Y===h||V.loadError===0&&V.fragmentError===0)&&(ee<=W||!N(ee)||T&&!this.bitrateTestDelay||ee<c)){const pe=this.forcedAutoLevel;return Y!==p&&(pe===-1||pe!==p)&&(O.length&&x.trace(`[abr] Skipped level(s) ${O.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${f[O[0]].codecs}" ${f[O[0]].videoRange}; not compatible with "${E.codecs}" ${A}`),x.info(`[abr] switch candidate:${u}->${Y} adjustedbw(${Math.round(Z)})-bitrate=${Math.round(Z-q)} ttfb:${W.toFixed(1)} avgDuration:${U.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${ee.toFixed(1)} firstSelection:${_} codecSet:${S} videoRange:${A} hls.loadLevel:${p}`)),_&&(this.firstSelection=Y),Y}}return-1}set nextAutoLevel(e){const t=Math.max(this.hls.minAutoLevel,e);this._nextAutoLevel!=t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}}class ld{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var ge={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class cd{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.BUFFER_APPENDED,this.onBufferAppended,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.BUFFER_APPENDED,this.onBufferAppended,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const a=r.end;if(r.start<=e&&a!==null&&e<=a)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const a=i[s[r]];if((a==null?void 0:a.body.type)===t&&a.buffered){const o=a.body;if(o.start<=e&&e<=o.end)return o}}return null}detectEvictedFragments(e,t,i,s){this.timeRanges&&(this.timeRanges[e]=t);const r=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o||r>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===i&&this.removeFragment(o.body);return}const l=o.range[e];l&&l.time.some(c=>{const h=!this.isTimeBuffered(c.startPTS,c.endPTS,t);return h&&this.removeFragment(o.body),h})})}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:s}=e;if(!t||i.sn==="initSegment")return;const r=Ot(i),a=this.fragments[r];if(!a||a.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(l=>{const c=i.elementaryStreams[l];if(!c)return;const h=t[l],u=o||c.partial===!0;a.range[l]=this.getBufferedTimes(i,s,u,h)}),a.loaded=null,Object.keys(a.range).length?(a.buffered=!0,(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),Ai(a)||this.removeParts(i.sn-1,i.type)):this.removeFragment(a.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter(s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=Ot(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},a=e.start,o=e.end,l=e.minEndPTS||o,c=e.maxStartPTS||a;for(let h=0;h<s.length;h++){const u=s.start(h)-this.bufferPadding,d=s.end(h)+this.bufferPadding;if(c>=u&&l<=d){r.time.push({startPTS:Math.max(a,s.start(h)),endPTS:Math.min(o,s.end(h))});break}else if(a<d&&o>u){const g=Math.max(a,s.start(h)),f=Math.min(o,s.end(h));f>g&&(r.partial=!0,r.time.push({startPTS:g,endPTS:f}))}else if(o<=u)break}return r}getPartialFragment(e){let t=null,i,s,r,a=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(c=>{const h=l[c];h&&Ai(h)&&(s=h.body.start-o,r=h.body.end+o,e>=s&&e<=r&&(i=Math.min(e-s,r-e),a<=i&&(t=h.body,a=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Ai(t))}getState(e){const t=Ot(e),i=this.fragments[t];return i?i.buffered?Ai(i)?ge.PARTIAL:ge.OK:ge.APPENDING:ge.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let a=0;a<i.length;a++){if(s=i.start(a)-this.bufferPadding,r=i.end(a)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:s}=t;if(i.sn==="initSegment"||i.bitrateTest)return;const r=s?null:t,a=Ot(i);this.fragments[a]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r}=t;if(i.sn==="initSegment")return;const a=i.type;if(s){let o=this.activePartLists[a];o||(this.activePartLists[a]=o=[]),o.push(s)}this.timeRanges=r,Object.keys(r).forEach(o=>{const l=r[o];this.detectEvictedFragments(o,l,a,s)})}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Ot(e);return!!this.fragments[t]}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o)return;const l=o.body;l.type!==i||s&&!l.gap||l.start<t&&l.end>e&&(o.buffered||r)&&this.removeFragment(l)})}removeFragment(e){const t=Ot(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=i.filter(r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Ai(n){var e,t,i;return n.buffered&&(n.body.gap||((e=n.range.video)==null?void 0:e.partial)||((t=n.range.audio)==null?void 0:t.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Ot(n){return`${n.type}_${n.level}_${n.sn}`}const hd={length:0,start:()=>0,end:()=>0};class se{static isBuffered(e,t){try{if(e){const i=se.getBuffered(e);for(let s=0;s<i.length;s++)if(t>=i.start(s)&&t<=i.end(s))return!0}}catch{}return!1}static bufferInfo(e,t,i){try{if(e){const s=se.getBuffered(e),r=[];let a;for(a=0;a<s.length;a++)r.push({start:s.start(a),end:s.end(a)});return this.bufferedInfo(r,t,i)}}catch{}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort(function(c,h){const u=c.start-h.start;return u||h.end-c.end});let s=[];if(i)for(let c=0;c<e.length;c++){const h=s.length;if(h){const u=s[h-1].end;e[c].start-u<i?e[c].end>u&&(s[h-1].end=e[c].end):s.push(e[c])}else s.push(e[c])}else s=e;let r=0,a,o=t,l=t;for(let c=0;c<s.length;c++){const h=s[c].start,u=s[c].end;if(t+i>=h&&t<u)o=h,l=u,r=l-t;else if(t+i<h){a=h;break}}return{len:r,start:o||0,end:l||0,nextStart:a}}static getBuffered(e){try{return e.buffered}catch(t){return x.log("failed to get media.buffered",t),hd}}}class wi{constructor(e,t,i,s=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ri(),this.buffering={audio:Ri(),video:Ri(),audiovideo:Ri()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=a}}function Ri(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Ii(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function ud(n,e,t){return!!(e&&(t.endCC>t.startCC||n&&n.cc<t.startCC))}function dd(n,e){const t=n.fragments,i=e.fragments;if(!i.length||!t.length){x.log("No fragments to align");return}const s=Ii(t,i[0].cc);if(!s||s&&!s.startPTS){x.log("No frag in previous level to align on");return}return s}function fo(n,e){if(n){const t=n.start+e;n.start=n.startPTS=t,n.endPTS=t+n.duration}}function go(n,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)fo(t[i],n);e.fragmentHint&&fo(e.fragmentHint,n),e.alignedSliding=!0}function fd(n,e,t){e&&(gd(n,t,e),!t.alignedSliding&&e&&Di(t,e),!t.alignedSliding&&e&&!t.skippedSegments&&eo(e,t))}function gd(n,e,t){if(ud(n,t,e)){const i=dd(t,e);i&&N(i.start)&&(x.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),go(i.start,e))}}function Di(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;const t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r;const a=Math.min(e.endCC,n.endCC);e.startCC<a&&n.startCC<a&&(s=Ii(i,a),r=Ii(t,a)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Ii(t,s.cc)||t[Math.floor(t.length/2)]);const o=s.programDateTime,l=r.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(r.start-s.start);go(c,n)}const mo=Math.pow(2,17);class md{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new qe({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(g=>g[0]==="GAP")){l(yo(e));return}else e.gap=!1;const c=this.loader=e.loader=r?new r(s):new a(s),h=po(e),u=ro(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:mo};e.stats=c.stats,c.load(h,d,{onSuccess:(g,f,m,p)=>{this.resetLoader(e,c);let v=g.data;m.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),o({frag:e,part:null,payload:v,networkDetails:p})},onError:(g,f,m,p)=>{this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:fe({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:p}))},onAbort:(g,f,m)=>{this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:m,stats:g}))},onTimeout:(g,f,m)=>{this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}))},onProgress:(g,f,m,p)=>{t&&t({frag:e,part:null,payload:m,networkDetails:p})}})})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(yo(e,t));return}const c=this.loader=e.loader=r?new r(s):new a(s),h=po(e,t),u=ro(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:mo};t.stats=c.stats,c.load(h,d,{onSuccess:(g,f,m,p)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const v={frag:e,part:t,payload:g.data,networkDetails:p};i(v),o(v)},onError:(g,f,m,p)=>{this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:fe({url:h.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:p}))},onAbort:(g,f,m)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:m,stats:g}))},onTimeout:(g,f,m)=>{this.resetLoader(e,c),l(new qe({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/r),l),u=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+u}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=s.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function po(n,e=null){const t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(N(s)&&N(r)){var a;let o=s,l=r;if(n.sn==="initSegment"&&((a=n.decryptdata)==null?void 0:a.method)==="AES-128"){const c=r-s;c%16&&(l=r+(16-c%16)),s!==0&&(i.resetIV=!0,o=s-16)}i.rangeStart=o,i.rangeEnd=l}return i}function yo(n,e){const t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:$.MEDIA_ERROR,details:C.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new qe(i)}class qe extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class pd{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class yd{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function vd(n){const e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?vt(n,0,e-t):n}class Ed{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],a=i[2],o=i[3],l=this.invSubMix,c=l[0],h=l[1],u=l[2],d=l[3],g=new Uint32Array(256);let f=0,m=0,p=0;for(p=0;p<256;p++)p<128?g[p]=p<<1:g[p]=p<<1^283;for(p=0;p<256;p++){let v=m^m<<1^m<<2^m<<3^m<<4;v=v>>>8^v&255^99,e[f]=v,t[v]=f;const E=g[f],T=g[E],_=g[T];let S=g[v]*257^v*16843008;s[f]=S<<24|S>>>8,r[f]=S<<16|S>>>16,a[f]=S<<8|S>>>24,o[f]=S,S=_*16843009^T*65537^E*257^f*16843008,c[v]=S<<24|S>>>8,h[v]=S<<16|S>>>16,u[v]=S<<8|S>>>24,d[v]=S,f?(f=E^g[g[g[_^E]]],m^=g[g[m]]):f=m=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const a=this.ksRows=(r+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),h=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,g=this.invSubMix,f=g[0],m=g[1],p=g[2],v=g[3];let E,T;for(o=0;o<a;o++){if(o<r){E=c[o]=t[o];continue}T=E,o%r===0?(T=T<<8|T>>>24,T=u[T>>>24]<<24|u[T>>>16&255]<<16|u[T>>>8&255]<<8|u[T&255],T^=d[o/r|0]<<24):r>6&&o%r===4&&(T=u[T>>>24]<<24|u[T>>>16&255]<<16|u[T>>>8&255]<<8|u[T&255]),c[o]=E=(c[o-r]^T)>>>0}for(l=0;l<a;l++)o=a-l,l&3?T=c[o]:T=c[o-4],l<4||o<=4?h[l]=T:h[l]=f[u[T>>>24]]^m[u[T>>>16&255]]^p[u[T>>>8&255]]^v[u[T&255]],h[l]=h[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],h=o[2],u=o[3],d=this.uint8ArrayToUint32Array_(i);let g=d[0],f=d[1],m=d[2],p=d[3];const v=new Int32Array(e),E=new Int32Array(v.length);let T,_,S,A,b,D,k,R,P,W,O,H,J,Y;const V=this.networkToHostOrderSwap;for(;t<v.length;){for(P=V(v[t]),W=V(v[t+1]),O=V(v[t+2]),H=V(v[t+3]),b=P^r[0],D=H^r[1],k=O^r[2],R=W^r[3],J=4,Y=1;Y<s;Y++)T=l[b>>>24]^c[D>>16&255]^h[k>>8&255]^u[R&255]^r[J],_=l[D>>>24]^c[k>>16&255]^h[R>>8&255]^u[b&255]^r[J+1],S=l[k>>>24]^c[R>>16&255]^h[b>>8&255]^u[D&255]^r[J+2],A=l[R>>>24]^c[b>>16&255]^h[D>>8&255]^u[k&255]^r[J+3],b=T,D=_,k=S,R=A,J=J+4;T=a[b>>>24]<<24^a[D>>16&255]<<16^a[k>>8&255]<<8^a[R&255]^r[J],_=a[D>>>24]<<24^a[k>>16&255]<<16^a[R>>8&255]<<8^a[b&255]^r[J+1],S=a[k>>>24]<<24^a[R>>16&255]<<16^a[b>>8&255]<<8^a[D&255]^r[J+2],A=a[R>>>24]<<24^a[b>>16&255]<<16^a[D>>8&255]<<8^a[k&255]^r[J+3],E[t]=V(T^g),E[t+1]=V(A^f),E[t+2]=V(S^m),E[t+3]=V(_^p),g=P,f=W,m=O,p=H,t=t+4}return E.buffer}}const Td=16;class dn{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?vd(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise((s,r)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const a=this.flush();a?s(a.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:s,currentResult:r,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(e=we(a,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;s&&(i=s);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Ed),l.expandKey(t);const c=r;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=vt(o,-16).buffer,c||null}webCryptoDecrypt(e,t,i){const s=this.subtle;return(this.key!==t||!this.fastAesKey)&&(this.key=t,this.fastAesKey=new yd(s,t)),this.fastAesKey.expandKey().then(r=>s?(this.logOnce("WebCrypto AES decrypt"),new pd(s,new Uint8Array(i)).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(x.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i)))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%Td;return i!==e.length&&(t=vt(e,0,i),this.remainderData=vt(e,i)),t}logOnce(e){this.logEnabled&&(x.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Sd={toString:function(n){let e="";const t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},I={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Pi extends ld{constructor(e,t,i,s,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=I.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=s,this.log=x.log.bind(x,`${s}:`),this.warn=x.warn.bind(x,`${s}:`),this.hls=e,this.fragmentLoader=new md(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new dn(e.config),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=I.STOPPED}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(i!=null&&i.length){const r=i[i.length-1];return se.isBuffered(this.media,r.start+r.duration/2)}const s=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===I.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const e=this.media;e!=null&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:s,state:r}=this,a=i?i.currentTime:0,o=se.bufferInfo(s||i,a,e.maxBufferHole);if(this.log(`media seeking to ${N(a)?a.toFixed(3):a}, state: ${r}`),this.state===I.ENDED)this.resetLoadingState();else if(t){const l=e.maxFragLookUpTolerance,c=t.start-l,h=t.start+t.duration+l;if(!o.len||h<o.start||c>o.end){const u=a>h;(a<c||u)&&(u&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=I.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{if(this.fragContextChanged(e)){this.warn(`Fragment ${e.sn}${r.part?" p: "+r.part.index:""} of level ${e.level} was dropped during download.`),this.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const a=this.state;if(this.fragContextChanged(e)){(a===I.FRAG_LOADING||!this.fragCurrent&&a===I.PARSING)&&(this.fragmentTracker.removeFragment(e),this.state=I.IDLE);return}"payload"in r&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(y.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===I.STOPPED||this.state===I.ERROR||(this.warn(r),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===ge.APPENDING){const r=e.type,a=this.getFwdBufferInfo(this.mediaBuffer,r),o=Math.max(e.duration,a?a.len:this.config.maxBufferLength);this.reduceMaxBufferLength(o)&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===ge.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(y.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{if(!i||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{payload:r}=i,a=e.decryptdata;if(r&&r.byteLength>0&&a!=null&&a.key&&a.iv&&a.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),a.key.buffer,a.iv.buffer).catch(l=>{throw s.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:e}),l}).then(l=>{const c=self.performance.now();return s.trigger(y.FRAG_DECRYPTED,{frag:e,payload:l,stats:{tstart:o,tdecrypt:c}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===I.STOPPED||this.state===I.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state=I.IDLE,e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var i,s,r,a;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===B.MAIN?"level":"track"} ${e.level} (frag:[${((i=e.startPTS)!=null?i:NaN).toFixed(3)}-${((s=e.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${o?Sd.toString(se.getBuffered(o)):"(detached)"})`),e.sn!=="initSegment"){var l;if(e.type!==B.SUBTITLE){const h=e.elementaryStreams;if(!Object.keys(h).some(u=>!!h[u])){this.state=I.IDLE;return}}const c=(l=this.levels)==null?void 0:l[e.level];c!=null&&c.fragmentError&&(this.log(`Resetting level fragment error count of ${c.fragmentError} on frag buffered`),c.fragmentError=0)}this.state=I.IDLE,o&&(!this.loadedmetadata&&e.type==B.MAIN&&o.buffered.length&&((r=this.fragCurrent)==null?void 0:r.sn)===((a=this.fragPrevious)==null?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,a=!r||r.length===0||r.some(l=>!l),o=new wi(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!a);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;const a=t==null?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${e.level}`),this.state=I.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(h=>{if(!this.fragContextChanged(h.frag))return this.hls.trigger(y.KEY_LOADED,h),this.state===I.KEY_LOADING&&(this.state=I.IDLE),h}),this.hls.trigger(y.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(e,a.encryptedFragments),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&e.sn!=="initSegment"){const h=a.partList;if(h&&s){i>e.end&&a.fragmentHint&&(e=a.fragmentHint);const u=this.getNextPart(h,e,i);if(u>-1){const d=h[u];this.log(`Loading part sn: ${e.sn} p: ${d.index} cc: ${e.cc} of playlist [${a.startSN}-${a.endSN}] parts [0-${u}-${h.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=I.FRAG_LOADING;let g;return o?g=o.then(f=>!f||this.fragContextChanged(f.frag)?null:this.doFragPartsLoad(e,d,t,s)).catch(f=>this.handleFragLoadError(f)):g=this.doFragPartsLoad(e,d,t,s).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(y.FRAG_LOADING,{frag:e,part:d,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(h,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${a?"of ["+a.startSN+"-"+a.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),N(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=I.FRAG_LOADING;const l=this.config.progressive;let c;return l&&o?c=o.then(h=>!h||this.fragContextChanged(h==null?void 0:h.frag)?null:this.fragmentLoader.load(e,s)).catch(h=>this.handleFragLoadError(h)):c=Promise.all([this.fragmentLoader.load(e,l?s:void 0),o]).then(([h])=>(!l&&h&&s&&s(h),h)).catch(h=>this.handleFragLoadError(h)),this.hls.trigger(y.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):c}doFragPartsLoad(e,t,i,s){return new Promise((r,a)=>{var o;const l=[],c=(o=i.details)==null?void 0:o.partList,h=u=>{this.fragmentLoader.loadPart(e,u,s).then(d=>{l[u.index]=d;const g=d.part;this.hls.trigger(y.FRAG_LOADED,d);const f=to(i,e.sn,u.index+1)||io(c,e.sn,u.index+1);if(f)h(f);else return r({frag:e,part:g,partsLoaded:l})}).catch(a)};h(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===C.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(y.ERROR,t)}else this.hls.trigger(y.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==I.PARSING){!this.fragCurrent&&this.state!==I.STOPPED&&this.state!==I.ERROR&&(this.state=I.IDLE);return}const{frag:i,part:s,level:r}=t,a=self.performance.now();i.stats.parsing.end=a,s&&(s.stats.parsing.end=a),this.updateLevelTiming(i,s,r,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:a}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of level ${s}. The current chunk will not be buffered.`),null;const o=t[s],l=a>-1?to(o,r,a):null,c=l?l.fragment:Yu(o,r,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:l,level:o}):null}bufferFragmentData(e,t,i,s,r){var a;if(!e||this.state!==I.PARSING)return;const{data1:o,data2:l}=e;let c=o;if(o&&l&&(c=we(o,l)),!((a=c)!=null&&a.length))return;const h={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:c};if(this.hls.trigger(y.BUFFER_APPENDING,h),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!se.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=se.bufferInfo(t,i,0),r=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(e.start-a,s.end-a),i+a);e.start-o>a&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return N(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:s}}=this,r=se.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(t,i);if(a&&r.nextStart<a.end)return se.bufferInfo(e,t,Math.max(r.nextStart,s))}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i?(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0):!1}getAppendedFrag(e,t=B.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,B.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,a=i[0].start;let o;if(t.live){const l=r.initialLiveManifestSize;if(s<l)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${l})`),null;(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a)&&(o=this.getInitialLiveFragment(t,i),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=a&&(o=i[0]);if(!o){const l=r.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,l,t)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===ge.OK||i===ge.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){const a=e.gap,o=this.getNextFragment(this.nextLoadPosition,t);if(o===null)return o;if(e=o,a&&e&&!e.gap&&i.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s);if(l!==null&&i.len+l.len>=r)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,a=!0;for(let o=0,l=e.length;o<l;o++){const c=e[o];if(a=a&&!c.independent,s>-1&&i<c.start)break;const h=c.loaded;h?s=-1:(r||c.independent||a)&&c.fragment===t&&(s=o),r=h}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=ju(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const a=t[r-e.startSN];i.cc===a.cc&&(s=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=Xu(t,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,c=s.maxFragLookUpTolerance,h=i.partList,u=!!(s.lowLatencyMode&&h!=null&&h.length&&l);u&&l&&!this.bitrateTest&&(a=a.concat(l),o=l.sn);let d;if(e<t){const g=e>t-c?0:c;d=Ci(r,a,e,g)}else d=a[a.length-1];if(d){const g=d.sn-i.startSN,f=this.fragmentTracker.getState(d);if((f===ge.OK||f===ge.PARTIAL&&d.gap)&&(r=d),r&&d.sn===r.sn&&(!u||h[0].fragment.sn>d.sn)&&r&&d.level===r.level){const p=a[g+1];d.sn<o&&this.fragmentTracker.getState(p)!==ge.OK?d=p:d=null}}return d}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,a=e.fragments[0].start,o=e.edge,l=r>=a-t.maxFragLookUpTolerance&&r<=o;if(s!==null&&i.duration>s&&(r<s||!l)){const c=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!l&&i.readyState<4||r<o-c)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(e,t,i){const s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=e.fragments[0].start,a=!t,o=e.alignedSliding&&N(r);if(a||!o&&!r){const{fragPrevious:l}=this;fd(l,i,e);const c=e.fragments[0].start;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${l?l.sn:"na"} fragments: ${s}`),c}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),i===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,r=s?this.startTimeOffset:e.startTimeOffset;r!==null&&N(r)?(i=t+r,r<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${r} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&e.sn!=="initSegment"&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==I.FRAG_LOADING_WAITING_RETRY)&&(this.state=I.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const h=this.getCurrentContext(t.chunkMeta);h&&(t.frag=h.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=t.details===C.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction,{action:o,retryCount:l=0,retryConfig:c}=a||{};if(a&&o===de.RetryRequest&&c){this.resetStartWhenNotLoaded(this.levelLastLoaded);const h=hn(c,l);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${l+1}/${c.maxNumRetry} in ${h}ms`),a.resolved=!0,this.retryDate=self.performance.now()+h,this.state=I.FRAG_LOADING_WAITING_RETRY}else if(c&&a)if(this.resetFragmentErrors(e),l<c.maxNumRetry)!r&&o!==de.RemoveAlternatePermanently&&(a.resolved=!0);else{x.warn(`${t.details} reached or exceeded max retry (${l})`);return}else(a==null?void 0:a.action)===de.SendAlternateToPenaltyBox?this.state=I.WAITING_LEVEL:this.state=I.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===I.PARSING||this.state===I.PARSED){const t=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,t),s=i&&i.len>.5;s&&this.reduceMaxBufferLength(i.len);const r=!s;return r&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(e){e===B.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==I.STOPPED&&(this.state=I.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=se.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===I.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=I.IDLE}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){var r;const a=i.details;if(!a){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const h=e.elementaryStreams[c];if(h){const u=h.endPTS-h.startPTS;if(u<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${u})`),l||!1;const d=s?0:Ja(a,e,h.startPTS,h.endPTS,h.startDTS,h.endDTS);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:a,level:i,drift:d,type:c,frag:e,start:h.startPTS,end:h.endPTS}),!0}return l},!1)&&((r=this.transmuxer)==null?void 0:r.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(i.fragmentError===0&&(i.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(l.message),this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=I.PARSED,this.hls.trigger(y.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class vo{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=xd(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function xd(n,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<n.length;s++){const r=n[s];t.set(r,i),i+=r.length}return t}function Ld(){return typeof __HLS_WORKER_BUNDLE__=="function"}function _d(){const n=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(n);return{worker:new self.Worker(e),objectURL:e}}function Cd(n){const e=new self.URL(n,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}function He(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class fn{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=we(this.cachedData,e),this.cachedData=null);let i=Qt(e,0),s=i?i.length:0,r;const a=this._audioTrack,o=this._id3Track,l=i?js(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&N(l))&&(this.basePTS=bd(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Re.audioId3,duration:Number.POSITIVE_INFINITY});s<c;){if(this.canParse(e,s)){const h=this.appendFrame(a,e,s);h?(this.frameIndex++,this.lastPTS=h.sample.pts,s+=h.length,r=s):s=c}else Qh(e,s)?(i=Qt(e,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Re.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===c&&r!==c){const h=vt(e,r);this.cachedData?this.cachedData=we(this.cachedData,h):this.cachedData=h}}return{audioTrack:a,videoTrack:He(),id3Track:o,textTrack:He()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:He(),id3Track:this._id3Track,textTrack:He()}}destroy(){}}const bd=(n,e,t)=>{if(N(n))return n*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};function Ad(n,e,t,i){let s,r,a,o;const l=navigator.userAgent.toLowerCase(),c=i,h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((e[t+2]&192)>>>6)+1;const u=(e[t+2]&60)>>>2;if(u>h.length-1){const d=new Error(`invalid ADTS sampling index:${u}`);n.emit(y.ERROR,y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}return a=(e[t+2]&1)<<2,a|=(e[t+3]&192)>>>6,x.log(`manifest codec:${i}, ADTS type:${s}, samplingIndex:${u}`),/firefox/i.test(l)?u>=6?(s=5,o=new Array(4),r=u-3):(s=2,o=new Array(2),r=u):l.indexOf("android")!==-1?(s=2,o=new Array(2),r=u):(s=5,o=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&u>=6?r=u-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(u>=6&&a===1||/vivaldi/i.test(l))||!i&&a===1)&&(s=2,o=new Array(2)),r=u)),o[0]=s<<3,o[0]|=(u&14)>>1,o[1]|=(u&1)<<7,o[1]|=a<<3,s===5&&(o[1]|=(r&14)>>1,o[2]=(r&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:h[u],channelCount:a,codec:"mp4a.40."+s,manifestCodec:c}}function Eo(n,e){return n[e]===255&&(n[e+1]&246)===240}function To(n,e){return n[e+1]&1?7:9}function gn(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function wd(n,e){return e+5<n.length}function ki(n,e){return e+1<n.length&&Eo(n,e)}function Rd(n,e){return wd(n,e)&&Eo(n,e)&&gn(n,e)<=n.length-e}function Id(n,e){if(ki(n,e)){const t=To(n,e);if(e+t>=n.length)return!1;const i=gn(n,e);if(i<=t)return!1;const s=e+i;return s===n.length||ki(n,s)}return!1}function So(n,e,t,i,s){if(!n.samplerate){const r=Ad(e,t,i,s);if(!r)return;n.config=r.config,n.samplerate=r.samplerate,n.channelCount=r.channelCount,n.codec=r.codec,n.manifestCodec=r.manifestCodec,x.log(`parsed codec:${n.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function xo(n){return 1024*9e4/n}function Dd(n,e){const t=To(n,e);if(e+t<=n.length){const i=gn(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function Lo(n,e,t,i,s){const r=xo(n.samplerate),a=i+s*r,o=Dd(e,t);let l;if(o){const{frameLength:u,headerLength:d}=o,g=d+u,f=Math.max(0,t+g-e.length);f?(l=new Uint8Array(g-d),l.set(e.subarray(t+d,e.length),0)):l=e.subarray(t+d,t+g);const m={unit:l,pts:a};return f||n.samples.push(m),{sample:m,length:g,missing:f}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}let Fi=null;const Pd=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],kd=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Fd=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Od=[0,1,1,4];function _o(n,e,t,i,s){if(t+24>e.length)return;const r=Co(e,t);if(r&&t+r.frameLength<=e.length){const a=r.samplesPerFrame*9e4/r.sampleRate,o=i+s*a,l={unit:e.subarray(t,t+r.frameLength),pts:o,dts:o};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function Co(n,e){const t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const a=n[e+2]>>1&1,o=n[e+3]>>6,l=t===3?3-i:i===3?3:4,c=Pd[l*14+s-1]*1e3,u=kd[(t===3?0:t===2?1:2)*3+r],d=o===3?1:2,g=Fd[t][i],f=Od[i],m=g*8*f,p=Math.floor(g*c/u+a)*f;if(Fi===null){const T=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Fi=T?parseInt(T[1]):0}return!!Fi&&Fi<=87&&i===2&&c>=224e3&&o===0&&(n[e+3]=n[e+3]|128),{sampleRate:u,channelCount:d,frameLength:p,samplesPerFrame:m}}}function mn(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function bo(n,e){return e+1<n.length&&mn(n,e)}function Md(n,e){return mn(n,e)&&4<=n.length-e}function Ao(n,e){if(e+1<n.length&&mn(n,e)){const i=Co(n,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===n.length||bo(n,r)}return!1}class Nd extends fn{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Qt(e,0);let i=(t==null?void 0:t.length)||0;if(Ao(e,i))return!1;for(let s=e.length;i<s;i++)if(Id(e,i))return x.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Rd(e,t)}appendFrame(e,t,i){So(e,this.observer,t,i,e.manifestCodec);const s=Lo(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const Ud=/\/emsg[-/]ID3/i;class Bd{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=He("video",1),a=this.audioTrack=He("audio",1),o=this.txtTrack=He("text",1);if(this.id3Track=He("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=wa(e);if(l.video){const{id:c,timescale:h,codec:u}=l.video;r.id=c,r.timescale=o.timescale=h,r.codec=u}if(l.audio){const{id:c,timescale:h,codec:u}=l.audio;a.id=c,a.timescale=h,a.codec=u}o.id=Ca.text,r.sampleDuration=0,r.duration=a.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return au(e)}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=we(this.remainderData,e));const o=gu(i);this.remainderData=o.remainder,s.samples=o.valid||new Uint8Array}else s.samples=i;const a=this.extractID3Track(s,t);return r.samples=Ia(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=Ia(e,t),{videoTrack:t,audioTrack:He(),id3Track:s,textTrack:He()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=K(e.samples,["emsg"]);s&&s.forEach(r=>{const a=yu(r);if(Ud.test(a.schemeIdUri)){const o=N(a.presentationTime)?a.presentationTime/a.timeScale:t+a.presentationTimeDelta/a.timeScale;let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;i.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:Re.emsg,duration:l})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const wo=(n,e)=>{let t=0,i=5;e+=i;const s=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=n[e];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,s[0]=(a[0]&r[0])>>l,t=t?t<<o|s[0]:s[0],e+=1,i-=o}return t};class $d extends fn{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const s=Ro(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;const t=Qt(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&js(t)!==void 0&&wo(e,i)<16}}function Ro(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const o=[48e3,44100,32e3][r],l=e[t+4]&63,h=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+r]*2;if(t+h>e.length)return-1;const u=e[t+6]>>5;let d=0;u===2?d+=2:(u&1&&u!==1&&(d+=2),u&4&&(d+=2));const g=(e[t+6]<<8|e[t+7])>>12-d&1,m=[2,1,2,3,3,4,4,5][u]+g,p=e[t+5]>>3,v=e[t+5]&7,E=new Uint8Array([r<<6|p<<1|v>>2,(v&3)<<6|u<<3|g<<2|l>>4,l<<4&224]),T=1536/o*9e4,_=i+s*T,S=e.subarray(t,t+h);return n.config=E,n.channelCount=m,n.samplerate=o,n.samples.push({unit:S,pts:_}),h}class Gd{constructor(){this.VideoSample=null}createVideoSample(e,t,i,s){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:s,length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,s=i.length;if(s){const r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}e.debug.length&&x.log(e.pts+"/"+e.dts+":"+e.debug)}}class Io{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&x.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t=8,i=8,s;for(let r=0;r<e;r++)i!==0&&(s=this.readEG(),i=(t+s+256)%256),t=i===0?t:i}readSPS(){let e=0,t=0,i=0,s=0,r,a,o;const l=this.readUByte.bind(this),c=this.readBits.bind(this),h=this.readUEG.bind(this),u=this.readBoolean.bind(this),d=this.skipBits.bind(this),g=this.skipEG.bind(this),f=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);l();const p=l();if(c(5),d(3),l(),f(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){const A=h();if(A===3&&d(1),f(),f(),d(1),u())for(a=A!==3?8:12,o=0;o<a;o++)u()&&(o<6?m(16):m(64))}f();const v=h();if(v===0)h();else if(v===1)for(d(1),g(),g(),r=h(),o=0;o<r;o++)g();f(),d(1);const E=h(),T=h(),_=c(1);_===0&&d(1),d(1),u()&&(e=h(),t=h(),i=h(),s=h());let S=[1,1];if(u()&&u())switch(l()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:{S=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((E+1)*16-e*2-t*2),height:(2-_)*(T+1)*16-(_?2:4)*(i+s),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Vd extends Gd{parseAVCPES(e,t,i,s,r){const a=this.parseAVCNALu(e,i.data);let o=this.VideoSample,l,c=!1;i.data=null,o&&a.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),a.forEach(h=>{var u;switch(h.type){case 1:{let m=!1;l=!0;const p=h.data;if(c&&p.length>4){const v=new Io(p).readSliceType();(v===2||v===4||v===7||v===9)&&(m=!0)}if(m){var d;(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=m;break}case 5:l=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:{l=!0,Da(h.data,1,i.pts,t.samples);break}case 7:{var g,f;l=!0,c=!0;const m=h.data,v=new Io(m).readSPS();if(!e.sps||e.width!==v.width||e.height!==v.height||((g=e.pixelRatio)==null?void 0:g[0])!==v.pixelRatio[0]||((f=e.pixelRatio)==null?void 0:f[1])!==v.pixelRatio[1]){e.width=v.width,e.height=v.height,e.pixelRatio=v.pixelRatio,e.sps=[m],e.duration=r;const E=m.subarray(1,4);let T="avc1.";for(let _=0;_<3;_++){let S=E[_].toString(16);S.length<2&&(S="0"+S),T+=S}e.codec=T}break}case 8:l=!0,e.pps=[h.data];break;case 9:l=!0,e.audFound=!0,o&&this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:l=!0;break;default:l=!1,o&&(o.debug+="unknown NAL "+h.type+" ");break}o&&l&&o.units.push(h)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}parseAVCNALu(e,t){const i=t.byteLength;let s=e.naluState||0;const r=s,a=[];let o=0,l,c,h,u=-1,d=0;for(s===-1&&(u=0,d=t[0]&31,s=0,o=1);o<i;){if(l=t[o++],!s){s=l?0:1;continue}if(s===1){s=l?0:2;continue}if(!l)s=3;else if(l===1){if(c=o-s-1,u>=0){const g={data:t.subarray(u,c),type:d};a.push(g)}else{const g=this.getLastNalUnit(e.samples);g&&(r&&o<=4-r&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-r)),c>0&&(g.data=we(g.data,t.subarray(0,c)),g.state=0))}o<i?(h=t[o]&31,u=o,d=h,s=0):s=-1}else s=0}if(u>=0&&s>=0){const g={data:t.subarray(u,i),type:d,state:s};a.push(g)}if(a.length===0){const g=this.getLastNalUnit(e.samples);g&&(g.data=we(g.data,t))}return e.naluState=s,a}}class Hd{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new dn(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const a=Pa(r.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const a=r[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,i,s,a),!this.decrypter.isSync()))return}}}}const me=188;class rt{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.videoParser=new Vd}static probe(e){const t=rt.syncOffset(e);return t>0&&x.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),t!==-1}static syncOffset(e){const t=e.length;let i=Math.min(me*5,t-me)+1,s=0;for(;s<i;){let r=!1,a=-1,o=0;for(let l=s;l<t;l+=me)if(e[l]===71&&(t-l===me||e[l+me]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+me*99,e.length-me)+1)),r||(r=pn(e,l)===0),r&&o>1&&(a===0&&o>2||l+me>i))return a}else{if(o)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Ca[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=rt.createTrack("video"),this._audioTrack=rt.createTrack("audio",s),this._id3Track=rt.createTrack("id3"),this._txtTrack=rt.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let h=a.pid,u=a.pesData,d=o.pid,g=l.pid,f=o.pesData,m=l.pesData,p=null,v=this.pmtParsed,E=this._pmtId,T=e.length;if(this.remainderData&&(e=we(this.remainderData,e),T=e.length,this.remainderData=null),T<me&&!s)return this.remainderData=e,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const _=Math.max(0,rt.syncOffset(e));T-=(T-_)%me,T<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,T,e.buffer.byteLength-T));let S=0;for(let b=_;b<T;b+=me)if(e[b]===71){const D=!!(e[b+1]&64),k=pn(e,b),R=(e[b+3]&48)>>4;let P;if(R>1){if(P=b+5+e[b+4],P===b+me)continue}else P=b+4;switch(k){case h:D&&(u&&(r=Mt(u))&&this.videoParser.parseAVCPES(a,c,r,!1,this._duration),u={data:[],size:0}),u&&(u.data.push(e.subarray(P,b+me)),u.size+=b+me-P);break;case d:if(D){if(f&&(r=Mt(f)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break;case"ac3":this.parseAC3PES(o,r);break}f={data:[],size:0}}f&&(f.data.push(e.subarray(P,b+me)),f.size+=b+me-P);break;case g:D&&(m&&(r=Mt(m))&&this.parseID3PES(l,r),m={data:[],size:0}),m&&(m.data.push(e.subarray(P,b+me)),m.size+=b+me-P);break;case 0:D&&(P+=e[P]+1),E=this._pmtId=Kd(e,P);break;case E:{D&&(P+=e[P]+1);const W=Wd(e,P,this.typeSupported,i);h=W.videoPid,h>0&&(a.pid=h,a.segmentCodec=W.segmentVideoCodec),d=W.audioPid,d>0&&(o.pid=d,o.segmentCodec=W.segmentAudioCodec),g=W.id3Pid,g>0&&(l.pid=g),p!==null&&!v&&(x.warn(`MPEG-TS PMT found at ${b} after unknown PID '${p}'. Backtracking to sync byte @${_} to parse all TS packets.`),p=null,b=_-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=k;break}}else S++;if(S>0){const b=new Error(`Found ${S} TS packet/s that do not start with 0x47`);this.observer.emit(y.ERROR,y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:b,reason:b.message})}a.pesData=u,o.pesData=f,l.pesData=m;const A={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return s&&this.extractRemainingSamples(A),A}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,a=i.pesData,o=t.pesData,l=s.pesData;let c;if(a&&(c=Mt(a))?(this.videoParser.parseAVCPES(i,r,c,!0,this._duration),i.pesData=null):i.pesData=a,o&&(c=Mt(o))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else o!=null&&o.size&&x.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(c=Mt(l))?(this.parseID3PES(s,c),s.pesData=null):s.pesData=l}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new Hd(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this._duration=0}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const u=s.missing,d=s.sample.unit.byteLength;if(u===-1)r=we(s.sample.unit,r);else{const g=d-u;s.sample.unit.set(r.subarray(0,u),g),e.samples.push(s.sample),i=s.missing}}let a,o;for(a=i,o=r.length;a<o-1&&!ki(r,a);a++);if(a!==i){let u;const d=a<o-1;d?u=`AAC PES did not start with ADTS header,offset:${a}`:u="No ADTS header found in AAC PES";const g=new Error(u);if(x.warn(`parsing error: ${u}`),this.observer.emit(y.ERROR,y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,levelRetry:d,error:g,reason:u}),!d)return}So(e,this.observer,r,a,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(s){const u=xo(e.samplerate);l=s.sample.pts+u}else{x.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,h;for(;a<o;)if(h=Lo(e,r,a,l,c),a+=h.length,h.missing){this.aacOverFlow=h;break}else for(c++;a<o-1&&!ki(r,a);a++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,a=0;const o=t.pts;if(o===void 0){x.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<s;)if(bo(i,a)){const l=_o(e,i,a,o,r);if(l)a+=l.length,r++;else break}else a++}parseAC3PES(e,t){{const i=t.data,s=t.pts;if(s===void 0){x.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let a=0,o=0,l;for(;o<r&&(l=Ro(e,i,o,s,a++))>0;)o+=l}}parseID3PES(e,t){if(t.pts===void 0){x.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=he({},t,{type:this._videoTrack?Re.emsg:Re.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function pn(n,e){return((n[e+1]&31)<<8)+n[e+2]}function Kd(n,e){return(n[e+10]&31)<<8|n[e+11]}function Wd(n,e,t,i){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},r=(n[e+1]&15)<<8|n[e+2],a=e+3+r-4,o=(n[e+10]&15)<<8|n[e+11];for(e+=12+o;e<a;){const l=pn(n,e),c=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){yn("ADTS AAC");break}case 15:s.audioPid===-1&&(s.audioPid=l);break;case 21:s.id3Pid===-1&&(s.id3Pid=l);break;case 219:if(!i){yn("H.264");break}case 27:s.videoPid===-1&&(s.videoPid=l,s.segmentVideoCodec="avc");break;case 3:case 4:!t.mpeg&&!t.mp3?x.log("MPEG audio found, not supported in this browser"):s.audioPid===-1&&(s.audioPid=l,s.segmentAudioCodec="mp3");break;case 193:if(!i){yn("AC-3");break}case 129:t.ac3?s.audioPid===-1&&(s.audioPid=l,s.segmentAudioCodec="ac3"):x.log("AC-3 audio found, not supported in this browser");break;case 6:if(s.audioPid===-1&&c>0){let h=e+5,u=c;for(;u>2;){switch(n[h]){case 106:t.ac3!==!0?x.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=l,s.segmentAudioCodec="ac3");break}const g=n[h+1]+2;h+=g,u-=g}}break;case 194:case 135:x.warn("Unsupported EC-3 in M2TS found");break;case 36:x.warn("Unsupported HEVC in M2TS found");break}e+=c+5}return s}function yn(n){x.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Mt(n){let e=0,t,i,s,r,a;const o=n.data;if(!n||n.size===0)return null;for(;o[0].length<19&&o.length>1;)o[0]=we(o[0],o[1]),o.splice(1,1);if(t=o[0],(t[0]<<16)+(t[1]<<8)+t[2]===1){if(i=(t[4]<<8)+t[5],i&&i>n.size-6)return null;const c=t[7];c&192&&(r=(t[9]&14)*536870912+(t[10]&255)*4194304+(t[11]&254)*16384+(t[12]&255)*128+(t[13]&254)/2,c&64?(a=(t[14]&14)*536870912+(t[15]&255)*4194304+(t[16]&254)*16384+(t[17]&255)*128+(t[18]&254)/2,r-a>60*9e4&&(x.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),s=t[8];let h=s+9;if(n.size<=h)return null;n.size-=h;const u=new Uint8Array(n.size);for(let d=0,g=o.length;d<g;d++){t=o[d];let f=t.byteLength;if(h)if(h>f){h-=f;continue}else t=t.subarray(h),f-=h,h=0;u.set(t,e),e+=f}return i&&(i-=s+3),{data:u,pts:r,dts:a,len:i}}return null}class Yd extends fn{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Qt(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&js(t)!==void 0&&wo(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(Ao(e,i))return x.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return Md(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return _o(e,t,i,this.basePTS,this.frameIndex)}}class Do{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const at=Math.pow(2,32)-1;class L{static init(){L.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in L.types)L.types.hasOwnProperty(e)&&(L.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);L.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);L.STTS=L.STSC=L.STCO=r,L.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),L.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),L.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),L.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);L.FTYP=L.box(L.types.ftyp,a,l,a,o),L.DINF=L.box(L.types.dinf,L.box(L.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(e,4),s=0,i=8;s<r;s++)a.set(t[s],i),i+=t[s].byteLength;return a}static hdlr(e){return L.box(L.types.hdlr,L.HDLR_TYPES[e])}static mdat(e){return L.box(L.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(at+1)),s=Math.floor(t%(at+1));return L.box(L.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return L.box(L.types.mdia,L.mdhd(e.timescale,e.duration),L.hdlr(e.type),L.minf(e))}static mfhd(e){return L.box(L.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?L.box(L.types.minf,L.box(L.types.smhd,L.SMHD),L.DINF,L.stbl(e)):L.box(L.types.minf,L.box(L.types.vmhd,L.VMHD),L.DINF,L.stbl(e))}static moof(e,t,i){return L.box(L.types.moof,L.mfhd(e),L.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=L.trak(e[t]);return L.box.apply(null,[L.types.moov,L.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(L.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=L.trex(e[t]);return L.box.apply(null,[L.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(at+1)),s=Math.floor(t%(at+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return L.box(L.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return L.box(L.types.sdtp,i)}static stbl(e){return L.box(L.types.stbl,L.stsd(e),L.box(L.types.stts,L.STTS),L.box(L.types.stsc,L.STSC),L.box(L.types.stsz,L.STSZ),L.box(L.types.stco,L.STCO))}static avc1(e){let t=[],i=[],s,r,a;for(s=0;s<e.sps.length;s++)r=e.sps[s],a=r.byteLength,t.push(a>>>8&255),t.push(a&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],a=r.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(r));const o=L.box(L.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,h=e.pixelRatio[0],u=e.pixelRatio[1];return L.box(L.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,L.box(L.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),L.box(L.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,h&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return L.box(L.types.mp4a,L.audioStsd(e),L.box(L.types.esds,L.esds(e)))}static mp3(e){return L.box(L.types[".mp3"],L.audioStsd(e))}static ac3(e){return L.box(L.types["ac-3"],L.audioStsd(e),L.box(L.types.dac3,e.config))}static stsd(e){return e.type==="audio"?e.segmentCodec==="mp3"&&e.codec==="mp3"?L.box(L.types.stsd,L.STSD,L.mp3(e)):e.segmentCodec==="ac3"?L.box(L.types.stsd,L.STSD,L.ac3(e)):L.box(L.types.stsd,L.STSD,L.mp4a(e)):L.box(L.types.stsd,L.STSD,L.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,s=e.width,r=e.height,a=Math.floor(i/(at+1)),o=Math.floor(i%(at+1));return L.box(L.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=L.sdtp(e),s=e.id,r=Math.floor(t/(at+1)),a=Math.floor(t%(at+1));return L.box(L.types.traf,L.box(L.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),L.box(L.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255])),L.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,L.box(L.types.trak,L.tkhd(e),L.mdia(e))}static trex(e){const t=e.id;return L.box(L.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,a=new Uint8Array(r);let o,l,c,h,u,d;for(t+=8+r,a.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<s;o++)l=i[o],c=l.duration,h=l.size,u=l.flags,d=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*o);return L.box(L.types.trun,a)}static initSegment(e){L.types||L.init();const t=L.moov(e);return we(L.FTYP,t)}}L.types=void 0,L.HDLR_TYPES=void 0,L.STTS=void 0,L.STSC=void 0,L.STCO=void 0,L.STSZ=void 0,L.VMHD=void 0,L.SMHD=void 0,L.STSD=void 0,L.FTYP=void 0,L.DINF=void 0;const Po=9e4;function vn(n,e,t=1,i=!1){const s=n*e*t;return i?Math.round(s):s}function zd(n,e,t=1,i=!1){return vn(n,e,1/t,i)}function Jt(n,e=!1){return vn(n,1e3,1/Po,e)}function jd(n,e=1){return vn(n,Po,1/e)}const qd=10*1e3,ko=1024,Xd=1152,Qd=1536;let Nt=null,En=null;class Oi{constructor(e,t,i,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,Nt===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Nt=a?parseInt(a[1]):0}if(En===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);En=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){x.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){x.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){x.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e.reduce((s,r)=>{const a=r.pts-s;return a<-4294967296?(t=!0,De(s,r.pts)):a>0?s:r.pts},e[0].pts);return t&&x.debug("PTS rollover detected"),i}remux(e,t,i,s,r,a,o,l){let c,h,u,d,g,f,m=r,p=r;const v=e.pid>-1,E=t.pid>-1,T=t.samples.length,_=e.samples.length>0,S=o&&T>0||T>1;if((!v||_)&&(!E||S)||this.ISGenerated||o){if(this.ISGenerated){var b,D,k,R;const H=this.videoTrackConfig;H&&(t.width!==H.width||t.height!==H.height||((b=t.pixelRatio)==null?void 0:b[0])!==((D=H.pixelRatio)==null?void 0:D[0])||((k=t.pixelRatio)==null?void 0:k[1])!==((R=H.pixelRatio)==null?void 0:R[1]))&&this.resetInitSegment()}else u=this.generateIS(e,t,r,a);const P=this.isVideoContiguous;let W=-1,O;if(S&&(W=Zd(t.samples),!P&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,W>0){x.warn(`[mp4-remuxer]: Dropped ${W} out of ${T} video samples due to a missing keyframe`);const H=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(W),t.dropped+=W,p+=(t.samples[0].pts-H)/t.inputTimeScale,O=p}else W===-1&&(x.warn(`[mp4-remuxer]: No keyframe found out of ${T} video samples`),f=!1);if(this.ISGenerated){if(_&&S){const H=this.getVideoStartPts(t.samples),Y=(De(e.samples[0].pts,H)-H)/t.inputTimeScale;m+=Math.max(0,Y),p+=Math.max(0,-Y)}if(_){if(e.samplerate||(x.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),u=this.generateIS(e,t,r,a)),h=this.remuxAudio(e,m,this.isAudioContiguous,a,E||S||l===B.AUDIO?p:void 0),S){const H=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(x.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),u=this.generateIS(e,t,r,a)),c=this.remuxVideo(t,p,P,H)}}else S&&(c=this.remuxVideo(t,p,P,0));c&&(c.firstKeyFrame=W,c.independent=W!==-1,c.firstKeyFramePTS=O)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(g=Fo(i,r,this._initPTS,this._initDTS)),s.samples.length&&(d=Oo(s,r,this._initPTS))),{audio:h,video:c,initSegment:u,independent:f,text:d,id3:g}}generateIS(e,t,i,s){const r=e.samples,a=t.samples,o=this.typeSupported,l={},c=this._initPTS;let h=!c||s,u="audio/mp4",d,g,f;if(h&&(d=g=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(u="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:u,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):L.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(f=e.inputTimeScale,!c||f!==c.timescale?d=g=r[0].pts-Math.round(f*i):h=!1)}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:L.initSegment([t]),metadata:{width:t.width,height:t.height}},h)if(f=t.inputTimeScale,!c||f!==c.timescale){const m=this.getVideoStartPts(a),p=Math.round(f*i);g=Math.min(g,De(a[0].dts,m)-p),d=Math.min(d,m-p)}else h=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,h?(this._initPTS={baseTime:d,timescale:f},this._initDTS={baseTime:g,timescale:f}):d=f=void 0,{tracks:l,initPTS:d,timescale:f}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,a=e.samples,o=[],l=a.length,c=this._initPTS;let h=this.nextAvcDts,u=8,d=this.videoSampleDuration,g,f,m=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,v=!1;if(!i||h===null){const M=t*r,U=a[0].pts-De(a[0].dts,a[0].pts);Nt&&h!==null&&Math.abs(M-U-h)<15e3?i=!0:h=M-U}const E=c.baseTime*r/c.timescale;for(let M=0;M<l;M++){const U=a[M];U.pts=De(U.pts-E,h),U.dts=De(U.dts-E,h),U.dts<a[M>0?M-1:M].dts&&(v=!0)}v&&a.sort(function(M,U){const Z=M.dts-U.dts,q=M.pts-U.pts;return Z||q}),g=a[0].dts,f=a[a.length-1].dts;const T=f-g,_=T?Math.round(T/(l-1)):d||e.inputTimeScale/30;if(i){const M=g-h,U=M>_,Z=M<-1;if((U||Z)&&(U?x.warn(`AVC: ${Jt(M,!0)} ms (${M}dts) hole between fragments detected at ${t.toFixed(3)}`):x.warn(`AVC: ${Jt(-M,!0)} ms (${M}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!Z||h>=a[0].pts||Nt)){g=h;const q=a[0].pts-M;if(U)a[0].dts=g,a[0].pts=q;else for(let ee=0;ee<a.length&&!(a[ee].dts>q);ee++)a[ee].dts-=M,a[ee].pts-=M;x.log(`Video: Initial PTS/DTS adjusted: ${Jt(q,!0)}/${Jt(g,!0)}, delta: ${Jt(M,!0)} ms`)}}g=Math.max(0,g);let S=0,A=0,b=g;for(let M=0;M<l;M++){const U=a[M],Z=U.units,q=Z.length;let ee=0;for(let Ce=0;Ce<q;Ce++)ee+=Z[Ce].data.length;A+=ee,S+=q,U.length=ee,U.dts<b?(U.dts=b,b+=_/4|0||1):b=U.dts,m=Math.min(U.pts,m),p=Math.max(U.pts,p)}f=a[l-1].dts;const D=A+4*S+8;let k;try{k=new Uint8Array(D)}catch(M){this.observer.emit(y.ERROR,y.ERROR,{type:$.MUX_ERROR,details:C.REMUX_ALLOC_ERROR,fatal:!1,error:M,bytes:D,reason:`fail allocating video mdat ${D}`});return}const R=new DataView(k.buffer);R.setUint32(0,D),k.set(L.types.mdat,4);let P=!1,W=Number.POSITIVE_INFINITY,O=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,J=Number.NEGATIVE_INFINITY;for(let M=0;M<l;M++){const U=a[M],Z=U.units;let q=0;for(let pe=0,le=Z.length;pe<le;pe++){const Ze=Z[pe],Me=Ze.data,$n=Ze.data.byteLength;R.setUint32(u,$n),u+=4,k.set(Me,u),u+=$n,q+=4+$n}let ee;if(M<l-1)d=a[M+1].dts-U.dts,ee=a[M+1].pts-U.pts;else{const pe=this.config,le=M>0?U.dts-a[M-1].dts:_;if(ee=M>0?U.pts-a[M-1].pts:_,pe.stretchShortVideoTrack&&this.nextAudioPts!==null){const Ze=Math.floor(pe.maxBufferHole*r),Me=(s?m+s*r:this.nextAudioPts)-U.pts;Me>Ze?(d=Me-le,d<0?d=le:P=!0,x.log(`[mp4-remuxer]: It is approximately ${Me/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=le}else d=le}const Ce=Math.round(U.pts-U.dts);W=Math.min(W,d),H=Math.max(H,d),O=Math.min(O,ee),J=Math.max(J,ee),o.push(new Mo(U.key,d,q,Ce))}if(o.length){if(Nt){if(Nt<70){const M=o[0].flags;M.dependsOn=2,M.isNonSync=0}}else if(En&&J-O<H-W&&_/H<.025&&o[0].cts===0){x.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let M=g;for(let U=0,Z=o.length;U<Z;U++){const q=M+o[U].duration,ee=M+o[U].cts;if(U<Z-1){const Ce=q+o[U+1].cts;o[U].duration=Ce-ee}else o[U].duration=U?o[U-1].duration:_;o[U].cts=0,M=q}}}d=P||!d?_:d,this.nextAvcDts=h=f+d,this.videoSampleDuration=d,this.isVideoContiguous=!0;const oe={data1:L.moof(e.sequenceNumber++,g,he({},e,{samples:o})),data2:k,startPTS:m/r,endPTS:(p+d)/r,startDTS:g/r,endDTS:h/r,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,oe}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return Xd;case"ac3":return Qd;default:return ko}}remuxAudio(e,t,i,s,r){const a=e.inputTimeScale,o=e.samplerate?e.samplerate:a,l=a/o,c=this.getSamplesPerFrame(e),h=c*l,u=this._initPTS,d=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],f=r!==void 0;let m=e.samples,p=d?0:8,v=this.nextAudioPts||-1;const E=t*a,T=u.baseTime*a/u.timescale;if(this.isAudioContiguous=i=i||m.length&&v>0&&(s&&Math.abs(E-v)<9e3||Math.abs(De(m[0].pts-T,E)-v)<20*h),m.forEach(function(Y){Y.pts=De(Y.pts-T,E)}),!i||v<0){if(m=m.filter(Y=>Y.pts>=0),!m.length)return;r===0?v=0:s&&!f?v=Math.max(0,E):v=m[0].pts}if(e.segmentCodec==="aac"){const Y=this.config.maxAudioFramesDrift;for(let V=0,oe=v;V<m.length;V++){const M=m[V],U=M.pts,Z=U-oe,q=Math.abs(1e3*Z/a);if(Z<=-Y*h&&f)V===0&&(x.warn(`Audio frame @ ${(U/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*Z/a)} ms.`),this.nextAudioPts=v=oe=U);else if(Z>=Y*h&&q<qd&&f){let ee=Math.round(Z/h);oe=U-ee*h,oe<0&&(ee--,oe+=h),V===0&&(this.nextAudioPts=v=oe),x.warn(`[mp4-remuxer]: Injecting ${ee} audio frame @ ${(oe/a).toFixed(3)}s due to ${Math.round(1e3*Z/a)} ms gap.`);for(let Ce=0;Ce<ee;Ce++){const pe=Math.max(oe,0);let le=Do.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);le||(x.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),le=M.unit.subarray()),m.splice(V,0,{unit:le,pts:pe}),oe+=h,V++}}M.pts=oe,oe+=h}}let _=null,S=null,A,b=0,D=m.length;for(;D--;)b+=m[D].unit.byteLength;for(let Y=0,V=m.length;Y<V;Y++){const oe=m[Y],M=oe.unit;let U=oe.pts;if(S!==null){const q=g[Y-1];q.duration=Math.round((U-S)/l)}else if(i&&e.segmentCodec==="aac"&&(U=v),_=U,b>0){b+=p;try{A=new Uint8Array(b)}catch(q){this.observer.emit(y.ERROR,y.ERROR,{type:$.MUX_ERROR,details:C.REMUX_ALLOC_ERROR,fatal:!1,error:q,bytes:b,reason:`fail allocating audio mdat ${b}`});return}d||(new DataView(A.buffer).setUint32(0,b),A.set(L.types.mdat,4))}else return;A.set(M,p);const Z=M.byteLength;p+=Z,g.push(new Mo(!0,c,Z,0)),S=U}const k=g.length;if(!k)return;const R=g[g.length-1];this.nextAudioPts=v=S+l*R.duration;const P=d?new Uint8Array(0):L.moof(e.sequenceNumber++,_/l,he({},e,{samples:g}));e.samples=[];const W=_/a,O=v/a,J={data1:P,data2:A,startPTS:W,endPTS:O,startDTS:W,endDTS:O,type:"audio",hasAudio:!0,hasVideo:!1,nb:k};return this.isAudioContiguous=!0,J}remuxEmptyAudio(e,t,i,s){const r=e.inputTimeScale,a=e.samplerate?e.samplerate:r,o=r/a,l=this.nextAudioPts,c=this._initDTS,h=c.baseTime*9e4/c.timescale,u=(l!==null?l:s.startDTS*r)+h,d=s.endDTS*r+h,g=o*ko,f=Math.ceil((d-u)/g),m=Do.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(x.warn("[mp4-remuxer]: remux empty Audio"),!m){x.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const p=[];for(let v=0;v<f;v++){const E=u+v*g;p.push({unit:m,pts:E,dts:E})}return e.samples=p,this.remuxAudio(e,t,i,!1)}}function De(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function Zd(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function Fo(n,e,t,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let o=0;o<s;o++){const l=n.samples[o];l.pts=De(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=De(l.dts-i.baseTime*r/i.timescale,e*r)/r}const a=n.samples;return n.samples=[],{samples:a}}function Oo(n,e,t){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let a=0;a<i;a++){const o=n.samples[a];o.pts=De(o.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((a,o)=>a.pts-o.pts);const r=n.samples;return n.samples=[],{samples:r}}class Mo{constructor(e,t,i,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=s,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class Jd{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(cu(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=wa(e);s.audio&&(t=No(s.audio,te.AUDIO)),s.video&&(i=No(s.video,te.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:x.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,a){var o,l;let{initPTS:c,lastEndTime:h}=this;const u={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};N(h)||(h=this.lastEndTime=r||0);const d=t.samples;if(!(d!=null&&d.length))return u;const g={initPTS:void 0,timescale:1};let f=this.initData;if((o=f)!=null&&o.length||(this.generateInitSegment(d),f=this.initData),!((l=f)!=null&&l.length))return x.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),u;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);const m=uu(d,f),p=hu(f,d),v=p===null?r:p;(ef(c,v,r,m)||g.timescale!==c.timescale&&a)&&(g.initPTS=v-r,c&&c.timescale===1&&x.warn(`Adjusting initPTS by ${g.initPTS-c.baseTime}`),this.initPTS=c={baseTime:g.initPTS,timescale:1});const E=e?v-c.baseTime/c.timescale:h,T=E+m;fu(f,d,c.baseTime/c.timescale),m>0?this.lastEndTime=T:(x.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const _=!!f.audio,S=!!f.video;let A="";_&&(A+="audio"),S&&(A+="video");const b={data1:d,startPTS:E,startDTS:E,endPTS:T,endDTS:T,type:A,hasAudio:_,hasVideo:S,nb:1,dropped:0};return u.audio=b.type==="audio"?b:void 0,u.video=b.type!=="audio"?b:void 0,u.initSegment=g,u.id3=Fo(i,r,c,c),s.samples.length&&(u.text=Oo(s,r,c)),u}}function ef(n,e,t,i){if(n===null)return!0;const s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function No(n,e){const t=n==null?void 0:n.codec;if(t&&t.length>4)return t;if(e===te.AUDIO){if(t==="ec-3"||t==="ac-3"||t==="alac")return t;if(t==="fLaC"||t==="Opus")return Ei(t,!1);const i="mp4a.40.5";return x.info(`Parsed audio codec "${t}" or audio object type not handled. Using "${i}"`),i}return x.warn(`Unhandled video codec "${t}"`),t==="hvc1"||t==="hev1"?"hvc1.1.6.L120.90":t==="av01"?"av01.0.04M.08":"avc1.42e01e"}let Xe;try{Xe=self.performance.now.bind(self.performance)}catch{x.debug("Unable to use Performance API on this environment"),Xe=wt==null?void 0:wt.Date.now}const Mi=[{demux:Bd,remux:Jd},{demux:rt,remux:Oi},{demux:Nd,remux:Oi},{demux:Yd,remux:Oi}];Mi.splice(2,0,{demux:$d,remux:Oi});class Uo{constructor(e,t,i,s,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.id=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=Xe();let a=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:c,discontinuity:h,trackSwitch:u,accurateTimeOffset:d,timeOffset:g,initSegmentChange:f}=s||o,{audioCodec:m,videoCodec:p,defaultInitPts:v,duration:E,initSegmentData:T}=l,_=tf(a,t);if(_&&_.method==="AES-128"){const D=this.getDecrypter();if(D.isSync()){let k=D.softwareDecrypt(a,_.key.buffer,_.iv.buffer);if(i.part>-1&&(k=D.flush()),!k)return r.executeEnd=Xe(),Tn(i);a=new Uint8Array(k)}else return this.decryptionPromise=D.webCryptoDecrypt(a,_.key.buffer,_.iv.buffer).then(k=>{const R=this.push(k,null,i);return this.decryptionPromise=null,R}),this.decryptionPromise}const S=this.needsProbing(h,u);if(S){const D=this.configureTransmuxer(a);if(D)return x.warn(`[transmuxer] ${D.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:D,reason:D.message}),r.executeEnd=Xe(),Tn(i)}(h||u||f||S)&&this.resetInitSegment(T,m,p,E,t),(h||f||S)&&this.resetInitialTimestamp(v),c||this.resetContiguity();const A=this.transmux(a,_,g,d,i),b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,r.executeEnd=Xe(),A}flush(e){const t=e.transmuxing;t.executeStart=Xe();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(e));const a=[],{timeOffset:o}=s;if(i){const u=i.flush();u&&a.push(this.push(u,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c)return t.executeEnd=Xe(),[Tn(e)];const h=l.flush(o);return Ni(h)?h.then(u=>(this.flushRemux(a,u,e),a)):(this.flushRemux(a,h,e),a)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:a,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;x.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const h=this.remuxer.remux(s,r,a,o,c,l,!0,this.id);e.push({remuxResult:h,chunkMeta:i}),i.transmuxing.executeEnd=Xe()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,i,s),o.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let a;return t&&t.method==="SAMPLE-AES"?a=this.transmuxSampleAes(e,t,i,s,r):a=this.transmuxUnencrypted(e,i,s,r),a}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,o,l,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s,vendor:r}=this;let a;for(let d=0,g=Mi.length;d<g;d++){var o;if((o=Mi[d].demux)!=null&&o.probe(e)){a=Mi[d];break}}if(!a)return new Error("Failed to find demuxer by probing fragment data");const l=this.demuxer,c=this.remuxer,h=a.remux,u=a.demux;(!c||!(c instanceof h))&&(this.remuxer=new h(i,t,s,r)),(!l||!(l instanceof u))&&(this.demuxer=new u(i,t,s),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new dn(this.config)),e}}function tf(n,e){let t=null;return n.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Tn=n=>({remuxResult:{},chunkMeta:n});function Ni(n){return"then"in n&&n.then instanceof Function}class sf{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class nf{constructor(e,t,i,s,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=a}}var Bo={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(l,c,h){this.fn=l,this.context=c,this.once=h||!1}function r(l,c,h,u,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var g=new s(h,u||l,d),f=t?t+c:c;return l._events[f]?l._events[f].fn?l._events[f]=[l._events[f],g]:l._events[f].push(g):(l._events[f]=g,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],h,u;if(this._eventsCount===0)return c;for(u in h=this._events)e.call(h,u)&&c.push(t?u.slice(1):u);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(h)):c},o.prototype.listeners=function(c){var h=t?t+c:c,u=this._events[h];if(!u)return[];if(u.fn)return[u.fn];for(var d=0,g=u.length,f=new Array(g);d<g;d++)f[d]=u[d].fn;return f},o.prototype.listenerCount=function(c){var h=t?t+c:c,u=this._events[h];return u?u.fn?1:u.length:0},o.prototype.emit=function(c,h,u,d,g,f){var m=t?t+c:c;if(!this._events[m])return!1;var p=this._events[m],v=arguments.length,E,T;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),v){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,h),!0;case 3:return p.fn.call(p.context,h,u),!0;case 4:return p.fn.call(p.context,h,u,d),!0;case 5:return p.fn.call(p.context,h,u,d,g),!0;case 6:return p.fn.call(p.context,h,u,d,g,f),!0}for(T=1,E=new Array(v-1);T<v;T++)E[T-1]=arguments[T];p.fn.apply(p.context,E)}else{var _=p.length,S;for(T=0;T<_;T++)switch(p[T].once&&this.removeListener(c,p[T].fn,void 0,!0),v){case 1:p[T].fn.call(p[T].context);break;case 2:p[T].fn.call(p[T].context,h);break;case 3:p[T].fn.call(p[T].context,h,u);break;case 4:p[T].fn.call(p[T].context,h,u,d);break;default:if(!E)for(S=1,E=new Array(v-1);S<v;S++)E[S-1]=arguments[S];p[T].fn.apply(p[T].context,E)}}return!0},o.prototype.on=function(c,h,u){return r(this,c,h,u,!1)},o.prototype.once=function(c,h,u){return r(this,c,h,u,!0)},o.prototype.removeListener=function(c,h,u,d){var g=t?t+c:c;if(!this._events[g])return this;if(!h)return a(this,g),this;var f=this._events[g];if(f.fn)f.fn===h&&(!d||f.once)&&(!u||f.context===u)&&a(this,g);else{for(var m=0,p=[],v=f.length;m<v;m++)(f[m].fn!==h||d&&!f[m].once||u&&f[m].context!==u)&&p.push(f[m]);p.length?this._events[g]=p.length===1?p[0]:p:a(this,g)}return this},o.prototype.removeAllListeners=function(c){var h;return c?(h=t?t+c:c,this._events[h]&&a(this,h)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(Bo);var rf=Bo.exports,Sn=Ph(rf);class $o{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const a=(h,u)=>{u=u||{},u.frag=this.frag,u.id=this.id,h===y.ERROR&&(this.error=u.error),this.hls.trigger(h,u)};this.observer=new Sn,this.observer.on(y.FRAG_DECRYPTED,a),this.observer.on(y.ERROR,a);const o=Et(r.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')},c=navigator.vendor;if(this.useWorker&&typeof Worker<"u"&&(r.workerPath||Ld())){try{r.workerPath?(x.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=Cd(r.workerPath)):(x.log(`injecting Web Worker for "${t}"`),this.workerContext=_d()),this.onwmsg=d=>this.onWorkerMessage(d);const{worker:u}=this.workerContext;u.addEventListener("message",this.onwmsg),u.onerror=d=>{const g=new Error(`${d.message}  (${d.filename}:${d.lineno})`);r.enableWorker=!1,x.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:g})},u.postMessage({cmd:"init",typeSupported:l,vendor:c,id:t,config:JSON.stringify(r)})}catch(u){x.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.resetWorker(),this.error=null,this.transmuxer=new Uo(this.observer,l,r,c,t)}return}this.transmuxer=new Uo(this.observer,l,r,c,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,s,r,a,o,l,c,h){var u,d;c.transmuxing.start=self.performance.now();const{transmuxer:g}=this,f=a?a.start:r.start,m=r.decryptdata,p=this.frag,v=!(p&&r.cc===p.cc),E=!(p&&c.level===p.level),T=p?c.sn-p.sn:-1,_=this.part?c.part-this.part.index:-1,S=T===0&&c.id>1&&c.id===(p==null?void 0:p.stats.chunkCount),A=!E&&(T===1||T===0&&(_===1||S&&_<=0)),b=self.performance.now();(E||T||r.stats.parsing.start===0)&&(r.stats.parsing.start=b),a&&(_||!A)&&(a.stats.parsing.start=b);const D=!(p&&((u=r.initSegment)==null?void 0:u.url)===((d=p.initSegment)==null?void 0:d.url)),k=new nf(v,A,l,E,f,D);if(!A||v||D){x.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${c.sn} p: ${c.part} level: ${c.level} id: ${c.id}
        discontinuity: ${v}
        trackSwitch: ${E}
        contiguous: ${A}
        accurateTimeOffset: ${l}
        timeOffset: ${f}
        initSegmentChange: ${D}`);const R=new sf(i,s,t,o,h);this.configureTransmuxer(R)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:m,chunkMeta:c,state:k},e instanceof ArrayBuffer?[e]:[]);else if(g){const R=g.push(e,m,c,k);Ni(R)?(g.async=!0,R.then(P=>{this.handleTransmuxComplete(P)}).catch(P=>{this.transmuxerError(P,c,"transmuxer-interface push error")})):(g.async=!1,this.handleTransmuxComplete(R))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);Ni(i)||t.async?(Ni(i)||(i=Promise.resolve(i)),i.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")})):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":{var s;const r=(s=this.workerContext)==null?void 0:s.objectURL;r&&self.URL.revokeObjectURL(r);break}case"transmuxComplete":{this.handleTransmuxComplete(t.data);break}case"flush":{this.onFlush(t.data);break}case"workerLog":x[t.data.logType]&&x[t.data.logType](t.data.message);break;default:{t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data);break}}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}function Go(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!Ut(n[t].attrs,e[t].attrs))return!1;return!0}function Ut(n,e,t){const i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function xn(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}const Vo=100;class Ho extends Pi{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",B.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i==="main"){const a=t.cc;this.initPTS[t.cc]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${a} found from main: ${s}`),this.videoTrackCC=a,this.state===I.WAITING_INIT_PTS&&this.tick()}}startLoad(e){if(!this.levels){this.startPosition=e,this.state=I.STOPPED;return}const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(Vo),t>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=I.IDLE):(this.loadedmetadata=!1,this.state=I.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case I.IDLE:this.doTickIdle();break;case I.WAITING_TRACK:{var e;const{levels:i,trackId:s}=this,r=i==null||(e=i[s])==null?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=I.WAITING_INIT_PTS}break}case I.FRAG_LOADING_WAITING_RETRY:{var t;const i=performance.now(),s=this.retryDate;if(!s||i>=s||(t=this.media)!=null&&t.seeking){const{levels:r,trackId:a}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((r==null?void 0:r[a])||null),this.state=I.IDLE}break}case I.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:s,part:r,cache:a,complete:o}=i;if(this.initPTS[s.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=I.FRAG_LOADING;const l=a.flush(),c={frag:s,part:r,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),o&&super._handleFragmentLoadComplete(c)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${s.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const l=this.getLoadPosition(),c=se.bufferInfo(this.mediaBuffer,l,this.config.maxBufferHole);un(c.end,this.config.maxFragLookUpTolerance,s)<0&&(this.log(`Waiting fragment cc (${s.cc}) @ ${s.start} cancelled because another fragment at ${c.end} is needed`),this.clearWaitingFragment())}}else this.state=I.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=I.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:s}=this,r=e.config;if(!i&&(this.startFragRequested||!r.startFragPrefetch)||!(t!=null&&t[s]))return;const a=t[s],o=a.details;if(!o||o.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(o)){this.state=I.WAITING_TRACK;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,te.AUDIO,B.AUDIO));const c=this.getFwdBufferInfo(l,B.AUDIO);if(c===null)return;const{bufferedTrack:h,switchingTrack:u}=this;if(!u&&this._streamEnded(c,o)){e.trigger(y.BUFFER_EOS,{type:"audio"}),this.state=I.ENDED;return}const d=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,B.MAIN),g=c.len,f=this.getMaxBufferLength(d==null?void 0:d.len),m=o.fragments,p=m[0].start;let v=this.flushing?this.getLoadPosition():c.end;if(u&&i){const S=this.getLoadPosition();h&&!Ut(u.attrs,h.attrs)&&(v=S),o.PTSKnown&&S<p&&(c.end>p||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=p+.05)}if(g>=f&&!u&&v<m[m.length-1].start)return;let E=this.getNextFragment(v,o),T=!1;if(E&&this.isLoopLoading(E,v)&&(T=!!E.gap,E=this.getNextFragmentLoopLoading(E,o,c,B.MAIN,f)),!E){this.bufferFlushed=!0;return}const _=d&&E.start>d.end+o.targetduration;if(_||!(d!=null&&d.len)&&c.len){const S=this.getAppendedFrag(E.start,B.MAIN);if(S===null||(T||(T=!!S.gap||!!_&&d.len===0),_&&!T||T&&c.nextStart&&c.nextStart<S.end))return}this.loadFragment(E,a,v)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Tt(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?this.setInterval(Vo):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=I.IDLE,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=I.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(y.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=t;return}const{levels:s}=this,{details:r,id:a}=t;if(!s){this.warn(`Audio tracks were reset while loading level ${a}`);return}this.log(`Audio track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const o=s[a];let l=0;if(r.live||(i=o.details)!=null&&i.live){this.checkLiveUpdate(r);const h=this.mainDetails;if(r.deltaUpdateFailed||!h)return;if(!o.details&&r.hasProgramDateTime&&h.hasProgramDateTime)Di(r,h),l=r.fragments[0].start;else{var c;l=this.alignPlaylists(r,o.details,(c=this.levelLastLoaded)==null?void 0:c.details)}}o.details=r,this.levelLastLoaded=o,!this.startFragRequested&&(this.mainDetails||!r.live)&&this.setStartPosition(o.details,l),this.state===I.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=I.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const h=c.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const u=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new $o(this.hls,B.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[i.cc],f=(t=i.initSegment)==null?void 0:t.data;if(g!==void 0){const p=s?s.index:-1,v=p!==-1,E=new wi(i.level,i.sn,i.stats.chunkCount,r.byteLength,p,v);d.push(r,f,u,"",i,s,h.totalduration,!1,E,g)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${h.startSN} ,${h.endSN}],track ${o}`);const{cache:m}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new vo,complete:!1};m.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=I.WAITING_INIT_PTS}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==B.AUDIO){if(!this.loadedmetadata&&i.type===B.MAIN){const r=this.videoBuffer||this.media;r&&se.getBuffered(r).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,fe({},r)))}this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=I.ERROR;return}switch(t.details){case C.FRAG_GAP:case C.FRAG_PARSING_ERROR:case C.FRAG_DECRYPT_ERROR:case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(B.AUDIO,t);break;case C.AUDIO_TRACK_LOAD_ERROR:case C.AUDIO_TRACK_LOAD_TIMEOUT:case C.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===I.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Q.AUDIO_TRACK&&(this.state=I.IDLE);break;case C.BUFFER_APPEND_ERROR:case C.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="audio")return;if(t.details===C.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case C.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==te.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==te.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===I.ENDED&&(this.state=I.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,B.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:h}=o,{details:u}=h,{audio:d,text:g,id3:f,initSegment:m}=r;if(this.fragContextChanged(l)||!u){this.fragmentTracker.removeFragment(l);return}if(this.state=I.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){const p=l.initSegment||l;this._bufferInitSegment(h,m.tracks,p,a),s.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:i,tracks:m.tracks})}if(d){const{startPTS:p,endPTS:v,startDTS:E,endDTS:T}=d;c&&(c.elementaryStreams[te.AUDIO]={startPTS:p,endPTS:v,startDTS:E,endDTS:T}),l.setElementaryStreamInfo(te.AUDIO,p,v,E,T),this.bufferFragmentData(d,l,c,a)}if(f!=null&&(t=f.samples)!=null&&t.length){const p=he({id:i,frag:l,details:u},f);s.trigger(y.FRAG_PARSING_METADATA,p)}if(g){const p=he({id:i,frag:l,details:u},g);s.trigger(y.FRAG_PARSING_USERDATA,p)}}_bufferInitSegment(e,t,i,s){if(this.state!==I.PARSING)return;t.video&&delete t.video;const r=t.audio;if(!r)return;r.id="audio";const a=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&a.split(",").length===1&&(r.levelCodec=a),this.hls.trigger(y.BUFFER_CODECS,t);const o=r.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:o};this.hls.trigger(y.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.fragCurrent=e,this.switchingTrack||s===ge.NOT_LOADED||s===ge.PARTIAL){var r;if(e.sn==="initSegment")this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=I.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragments[0].start!==t.details.fragments[0].start&&Di(t.details,a)}else this.startFragRequested=!0,super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){const{media:t,bufferedTrack:i}=this,s=i==null?void 0:i.attrs,r=e.attrs;t&&s&&(s.CHANNELS!==r.CHANNELS||i.name!==e.name||i.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(y.AUDIO_TRACK_SWITCHED,fe({},e))}}class Ko extends bi{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(d=>!i||i.indexOf(d.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(d=>d.default)&&(this.selectDefaultTrack=!1),o.forEach((d,g)=>{d.id=g});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!r&&l){const d=Ve(l,o,Ft);if(d>-1)r=o[d];else{const g=Ve(l,this.tracks);r=this.tracks[g]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const h={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,h);const u=this.trackId;if(c!==-1&&u===-1)this.setAudioTrack(c);else if(o.length&&u===-1){var a;const d=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(d.message),this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:d})}}else this.shouldReloadPlaylist(r)&&this.setAudioTrack(this.trackId)}onError(e,t){t.fatal||!t.context||t.context.type===Q.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&(this.requestScheduled=-1,this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&kt(e,s,Ft))return s;const r=Ve(e,this.tracksInGroup,Ft);if(r>-1){const a=this.tracksInGroup[r];return this.setAudioTrack(r),a}else if(s){let a=t.loadLevel;a===-1&&(a=t.firstAutoLevel);const o=od(e,t.levels,i,a,Ft);if(o===-1)return null;t.nextLoadLevel=o}if(e.channels||e.audioCodec){const a=Ve(e,i);if(a>-1)return i[a]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,fe({},s)),r))return;const a=this.switchParams(s.url,i==null?void 0:i.details);this.loadPlaylist(a)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||kt(e,s,Ft)))return i}if(e){const{name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l}=e;for(let c=0;c<t.length;c++){const h=t[c];if(kt({name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l},h,Ft))return c}for(let c=0;c<t.length;c++){const h=t[c];if(Ut(e.attrs,h.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const h=t[c];if(Ut(e.attrs,h.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`loading audio-track playlist ${i} "${t.name}" lang:${t.lang} group:${s}`),this.clearTimer(),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}}const Wo=500;class Yo extends Pi{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",B.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.ERROR,this.onError,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.ERROR,this.onError,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=I.IDLE,this.setInterval(Wo),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(this.fragPrevious=i,this.state=I.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let a;const o=i.start;for(let c=0;c<r.length;c++)if(o>=r[c].start&&o<=r[c].end){a=r[c];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},r.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=r){a.shift();continue}else if(a[o].start<r)a[o].start=r;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,r,B.SUBTITLE)}}onFragBuffered(e,t){if(!this.loadedmetadata&&t.frag.type===B.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===B.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==I.STOPPED&&(this.state=I.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(!this.levels||Go(this.levels,t)){this.levels=t.map(i=>new Tt(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new Tt(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,B.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.setInterval(Wo)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:s,levels:r}=this,{details:a,id:o}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=r[s];if(o>=r.length||o!==s||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(i=l.details)!=null&&i.live){const u=this.mainDetails;if(a.deltaUpdateFailed||!u)return;const d=u.fragments[0];if(!l.details)a.hasProgramDateTime&&u.hasProgramDateTime?(Di(a,u),c=a.fragments[0].start):d&&(c=d.start,cn(a,c));else{var h;c=this.alignPlaylists(a,l.details,(h=this.levelLastLoaded)==null?void 0:h.details),c===0&&d&&(c=d.start,cn(a,c))}}l.details=a,this.levelLastLoaded=l,!this.startFragRequested&&(this.mainDetails||!a.live)&&this.setStartPosition(l.details,c),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===I.IDLE&&(Ci(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&s.method==="AES-128"){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer).catch(o=>{throw r.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();r.trigger(y.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=I.IDLE})}}doTick(){if(!this.media){this.state=I.IDLE;return}if(this.state===I.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details)return;const{config:s}=this,r=this.getLoadPosition(),a=se.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:o,len:l}=a,c=this.getFwdBufferInfo(this.media,B.MAIN),h=i.details,u=this.getMaxBufferLength(c==null?void 0:c.len)+h.levelTargetDuration;if(l>u)return;const d=h.fragments,g=d.length,f=h.edge;let m=null;const p=this.fragPrevious;if(o<f){const v=s.maxFragLookUpTolerance,E=o>f-v?0:v;m=Ci(p,d,Math.max(d[0].start,o),E),!m&&p&&p.start<d[0].start&&(m=d[0])}else m=d[g-1];if(!m)return;if(m=this.mapToInitFragWhenRequired(m),m.sn!=="initSegment"){const v=m.sn-h.startSN,E=d[v-1];E&&E.cc===m.cc&&this.fragmentTracker.getState(E)===ge.NOT_LOADED&&(m=E)}this.fragmentTracker.getState(m)===ge.NOT_LOADED&&this.loadFragment(m,i,o)}}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,e.sn==="initSegment"?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new af(this.tracksBuffered[this.currentTrackId]||[])}}class af{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}class zo extends bi{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=Ti(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),Ti(this.media.textTracks).forEach(t=>{It(t)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(h=>!i||i.indexOf(h.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(h=>h.default)&&(this.selectDefaultTrack=!1),a.forEach((h,u)=>{h.id=u});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!r&&o){this.selectDefaultTrack=!1;const h=Ve(o,a);if(h>-1)r=a[h];else{const u=Ve(o,this.tracks);r=this.tracks[u]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){const r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||kt(r,e)))return s}if(e){for(let s=0;s<t.length;s++){const r=t[s];if(Ut(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const r=t[s];if(Ut(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(xn(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Q.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&kt(e,i))return i;const s=Ve(e,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=Ve(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=Ti(e.textTracks),i=this.currentTrack;let s;if(i&&(s=t.filter(r=>xn(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!N(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:h}=s;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:h});const u=this.switchParams(s.url,i==null?void 0:i.details);this.loadPlaylist(u)}}class of{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,i){const s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise(r=>{t=r}),s={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,e),i}executeNext(e){const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(s){x.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${s}`),i.onError(s);const r=this.buffers[e];r!=null&&r.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const jo=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class qo{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=i=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:i,mediaSource:s}=this;this.log("Media source opened"),i&&(i.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:i,mediaSource:s})),s&&s.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&x.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e;const t="[buffer-controller]";this.appendSource=e.config.preferManagedMediaSource,this.log=x.log.bind(x,t),this.warn=x.warn.bind(x,t),this.error=x.error.bind(x,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_APPENDING,this.onBufferAppending,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.BUFFER_EOS,this.onBufferEos,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.FRAG_PARSED,this.onFragParsed,this),e.on(y.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_APPENDING,this.onBufferAppending,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_EOS,this.onBufferEos,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.FRAG_PARSED,this.onFragParsed,this),e.off(y.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new of(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media,s=Et(this.appendSource);if(i&&s){var r;const a=this.mediaSource=new s;this.log(`created media source: ${(r=a.constructor)==null?void 0:r.name}`),a.addEventListener("sourceopen",this._onMediaSourceOpen),a.addEventListener("sourceended",this._onMediaSourceEnded),a.addEventListener("sourceclose",this._onMediaSourceClose),a.addEventListener("startstreaming",this._onStartStreaming),a.addEventListener("endstreaming",this._onEndStreaming);const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,Xo(i),lf(i,o),i.load()}catch{i.src=o}else i.src=o;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(this.log("media source detaching"),t.readyState==="open")try{t.endOfStream()}catch(s){this.warn(`onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(e.removeAttribute("src"),this.appendSource&&Xo(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(y.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(e=>{this.resetBuffer(e)}),this._initSourceBuffer()}resetBuffer(e){const t=this.sourceBuffer[e];try{if(t){var i;this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}}catch(s){this.warn(`onBufferReset ${e}`,s)}}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length,s=Object.keys(t);if(s.forEach(a=>{if(i){const l=this.tracks[a];if(l&&typeof l.buffer.changeType=="function"){var o;const{id:c,codec:h,levelCodec:u,container:d,metadata:g}=t[a],f=Ua(l.codec,l.levelCodec),m=f==null?void 0:f.replace(jo,"$1");let p=Ua(h,u);const v=(o=p)==null?void 0:o.replace(jo,"$1");if(p&&m!==v){a.slice(0,5)==="audio"&&(p=Ei(p,this.hls.config.preferManagedMediaSource));const E=`${d};codecs=${p}`;this.appendChangeType(a,E),this.log(`switching codec ${f} to ${p}`),this.tracks[a]={buffer:l.buffer,codec:h,container:d,levelCodec:u,metadata:g,id:c}}}}else this.pendingTracks[a]=t[a]}),i)return;const r=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==r&&(this.log(`${r} bufferCodec event(s) expected ${s.join(",")}`),this.bufferCodecEventsExpected=r),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:i}=this,s={execute:()=>{const r=this.sourceBuffer[e];r&&(this.log(`changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${e} SourceBuffer type`,r)}};i.append(s,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:i,operationQueue:s,tracks:r}=this,{data:a,type:o,frag:l,part:c,chunkMeta:h}=t,u=h.buffering[o],d=self.performance.now();u.start=d;const g=l.stats.buffering,f=c?c.stats.buffering:null;g.start===0&&(g.start=d),f&&f.start===0&&(f.start=d);const m=r.audio;let p=!1;o==="audio"&&(m==null?void 0:m.container)==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||h.id===1||this.lastMpegAudioChunk.sn!==h.sn,this.lastMpegAudioChunk=h);const v=l.start,E={execute:()=>{if(u.executeStart=self.performance.now(),p){const T=this.sourceBuffer[o];if(T){const _=v-T.timestampOffset;Math.abs(_)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${v} (delta: ${_}) sn: ${l.sn})`),T.timestampOffset=v)}}this.appendExecutor(a,o)},onStart:()=>{},onComplete:()=>{const T=self.performance.now();u.executeEnd=u.end=T,g.first===0&&(g.first=T),f&&f.first===0&&(f.first=T);const{sourceBuffer:_}=this,S={};for(const A in _)S[A]=se.getBuffered(_[A]);this.appendErrors[o]=0,o==="audio"||o==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:o,frag:l,part:c,chunkMeta:h,parent:l.type,timeRanges:S})},onError:T=>{const _={type:$.MEDIA_ERROR,parent:l.type,details:C.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:l,part:c,chunkMeta:h,error:T,err:T,fatal:!1};if(T.code===DOMException.QUOTA_EXCEEDED_ERR)_.details=C.BUFFER_FULL_ERROR;else{const S=++this.appendErrors[o];_.details=C.BUFFER_APPEND_ERROR,this.warn(`Failed ${S}/${i.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),S>=i.config.appendErrorMaxRetry&&(_.fatal=!0)}i.trigger(y.ERROR,_)}};s.append(E,o,!!this.pendingTracks[o])}onBufferFlushing(e,t){const{operationQueue:i}=this,s=r=>({execute:this.removeExecutor.bind(this,r,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:r})},onError:a=>{this.warn(`Failed to remove from ${r} SourceBuffer`,a)}});t.type?i.append(s(t.type),t.type):this.getSourceBufferTypes().forEach(r=>{i.append(s(r),r)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],a=s?s.elementaryStreams:i.elementaryStreams;a[te.AUDIOVIDEO]?r.push("audiovideo"):(a[te.AUDIO]&&r.push("audio"),a[te.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const c=s?s.stats:i.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:i,part:s,stats:c,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce((s,r)=>{const a=this.sourceBuffer[r];return a&&(!t.type||t.type===r)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${r} sourceBuffer now EOS`))),s&&!!(!a||a.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(r=>{const a=this.sourceBuffer[r];a&&(a.ending=!1)});const{mediaSource:s}=this;if(!s||s.readyState!=="open"){s&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${s.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),s.endOfStream()}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.getSourceBufferTypes().length)return;const r=e.config,a=i.currentTime,o=t.levelTargetDuration,l=t.live&&r.liveBackBufferLength!==null?r.liveBackBufferLength:r.backBufferLength;if(N(l)&&l>0){const c=Math.max(l,o),h=Math.floor(a/o)*o-c;this.flushBackBuffer(a,o,h)}if(N(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const c=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),h=Math.max(c,o),u=Math.floor(a/o)*o+h;this.flushFrontBuffer(a,o,u)}}flushBackBuffer(e,t,i){const{details:s,sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(o=>{const l=r[o];if(l){const c=se.getBuffered(l);if(c.length>0&&i>c.start(0)){if(this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:i}),s!=null&&s.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l.ended&&c.end(c.length-1)-e<t*2){this.log(`Cannot flush ${o} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:o})}}})}flushFrontBuffer(e,t,i){const{sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(a=>{const o=s[a];if(o){const l=se.getBuffered(o),c=l.length;if(c<2)return;const h=l.start(c-1),u=l.end(c-1);if(i>h||e>=h&&e<=u)return;if(o.ended&&e-u<2*t){this.log(`Cannot flush ${a} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:h,endOffset:1/0,type:a})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:e,hls:t,media:i,mediaSource:s}=this,r=e.fragments[0].start+e.totalduration,a=i.duration,o=N(s.duration)?s.duration:0;e.live&&t.config.liveDurationInfinity?(s.duration=1/0,this.updateSeekableRange(e)):(r>o&&r>a||!N(a))&&(this.log(`Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&t!=null&&t.setLiveSeekableRange){const r=Math.max(0,i[0].start),a=Math.max(r,r+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${r}-${a}.`),t.setLiveSeekableRange(r,a)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&(!e||s===2||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const r=this.getSourceBufferTypes();if(r.length)this.hls.trigger(y.BUFFER_CREATED,{tracks:this.tracks}),r.forEach(a=>{t.executeNext(a)});else{const a=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const s in e)if(!t[s]){const r=e[s];if(!r)throw Error(`source buffer exists for track ${s}, however track does not`);let a=r.levelCodec||r.codec;a&&s.slice(0,5)==="audio"&&(a=Ei(a,this.hls.config.preferManagedMediaSource));const o=`${r.container};codecs=${a}`;this.log(`creating sourceBuffer(${o})`);try{const l=t[s]=i.addSourceBuffer(o),c=s;this.addBufferListener(c,"updatestart",this._onSBUpdateStart),this.addBufferListener(c,"updateend",this._onSBUpdateEnd),this.addBufferListener(c,"error",this._onSBUpdateError),this.addBufferListener(c,"bufferedchange",(h,u)=>{const d=u.removedRanges;d!=null&&d.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:s})}),this.tracks[s]={buffer:l,codec:a,container:r.container,levelCodec:r.levelCodec,metadata:r.metadata,id:r.id}}catch(l){this.error(`error while trying to add sourceBuffer: ${l.message}`),this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:l,sourceBufferName:s,mimeType:o})}}}get mediaSrc(){var e;const t=((e=this.media)==null?void 0:e.firstChild)||this.media;return t==null?void 0:t.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const{operationQueue:i}=this;i.current(e).onComplete(),i.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var i;const s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});const r=this.operationQueue.current(e);r&&r.onError(s)}removeExecutor(e,t,i){const{media:s,mediaSource:r,operationQueue:a,sourceBuffer:o}=this,l=o[e];if(!s||!r||!l){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),a.shiftAndExecuteNext(e);return}const c=N(s.duration)?s.duration:1/0,h=N(r.duration)?r.duration:1/0,u=Math.max(0,t),d=Math.min(i,c,h);d>u&&(!l.ending||l.ended)?(l.ended=!1,this.log(`Removing [${u},${d}] from the ${e} SourceBuffer`),l.remove(u,d)):a.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.sourceBuffer[t];if(!i){if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);return}i.ended=!1,i.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}const{operationQueue:i}=this,s=t.map(r=>i.appendBlocker(r));Promise.all(s).then(()=>{e(),t.forEach(r=>{const a=this.sourceBuffer[r];a!=null&&a.updating||i.shiftAndExecuteNext(r)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const s=this.sourceBuffer[e];if(!s)return;const r=i.bind(this,e);this.listeners[e].push({event:t,listener:r}),s.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach(i=>{t.removeEventListener(i.event,i.listener)})}}function Xo(n){const e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function lf(n,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}const Qo={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Zo=function(e){let t=e;return Qo.hasOwnProperty(e)&&(t=Qo[e]),String.fromCharCode(t)},Oe=15,Qe=100,cf={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},hf={17:2,18:4,21:6,22:8,23:10,19:13,20:15},uf={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},df={25:2,26:4,29:6,30:8,31:10,27:13,28:15},ff=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class gf{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;x.log(`${this.time} [${e}] ${i}`)}}}const St=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Jo{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class mf{constructor(){this.uchar=" ",this.penState=new Jo}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class pf{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Jo,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Qe;t++)this.chars.push(new mf);this.logger=e}equals(e){for(let t=0;t<Qe;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<Qe;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Qe;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Qe&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Qe)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Zo(e);if(this.pos>=Qe){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<Qe;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<Qe;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Ln{constructor(e){this.rows=[],this.currRow=Oe-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Oe;t++)this.rows.push(new pf(e));this.logger=e}reset(){for(let e=0;e<Oe;e++)this.rows[e].clear();this.currRow=Oe-1}equals(e){let t=!0;for(let i=0;i<Oe;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Oe;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Oe;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+JSON.stringify(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<Oe;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[r].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(a.rows[r+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,a=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[a].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<Oe;r++){const a=this.rows[r].getTextString();a&&(s=r+1,e?t.push("Row "+s+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class el{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ln(i),this.nonDisplayedMemory=new Ln(i),this.lastOutputScreen=new Ln(i),this.currRollUpRow=this.displayedMemory.rows[Oe-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Oe-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class tl{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=sl(),this.logger=void 0;const s=this.logger=new gf;this.channels=[null,new el(e,t,s),new el(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,s,r,a=!1;this.logger.time=e;for(let o=0;o<t.length;o+=2)if(s=t[o]&127,r=t[o+1]&127,!(s===0&&r===0)){if(this.logger.log(3,"["+St([t[o],t[o+1]])+"] -> ("+St([s,r])+")"),i=this.parseCmd(s,r),i||(i=this.parseMidrow(s,r)),i||(i=this.parsePAC(s,r)),i||(i=this.parseBackgroundAttributes(s,r)),!i&&(a=this.parseChars(s,r),a)){const l=this.currentChannel;l&&l>0?this.channels[l].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!i&&!a&&this.logger.log(2,"Couldn't parse cleaned data "+St([s,r])+" orig: "+St([t[o],t[o+1]]))}}parseCmd(e,t){const{cmdHistory:i}=this,s=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,r=(e===23||e===31)&&t>=33&&t<=35;if(!(s||r))return!1;if(il(e,t,i))return Bt(null,null,i),this.logger.log(3,"Repeated command ("+St([e,t])+") is dropped"),!0;const a=e===20||e===21||e===23?1:2,o=this.channels[a];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),Bt(e,t,i),this.currentChannel=a,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,"MIDROW ("+St([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=this.cmdHistory,r=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,a=(e===16||e===24)&&t>=64&&t<=95;if(!(r||a))return!1;if(il(e,t,s))return Bt(null,null,s),!0;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?cf[e]:uf[e]:i=o===1?hf[e]:df[e];const l=this.channels[o];return l?(l.setPAC(this.interpretPAC(i,t)),Bt(e,t,s),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let a;r===17?a=t+80:r===18?a=t+112:a=t+144,this.logger.log(2,"Special char '"+Zo(a)+"' in channel "+i),s=[a]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);if(s){const a=St(s);this.logger.log(3,"Char codes =  "+a.join(",")),Bt(e,t,this.cmdHistory)}return s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const a={};e===16||e===24?(r=Math.floor((t-32)/2),a.background=ff[r],t%2===1&&(a.background=a.background+"_semi")):t===45?a.background="transparent":(a.foreground="black",t===47&&(a.underline=!0));const o=e<=23?1:2;return this.channels[o].setBkgData(a),Bt(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory=sl()}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Bt(n,e,t){t.a=n,t.b=e}function il(n,e,t){return t.a===n&&t.b===e}function sl(){return{a:null,b:null}}class Ui{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var _n=function(){if(wt!=null&&wt.VTTCue)return self.VTTCue;const n=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const c=l.toLowerCase();return~o.indexOf(c)?c:!1}function i(o){return t(n,o)}function s(o){return t(e,o)}function r(o,...l){let c=1;for(;c<arguments.length;c++){const h=arguments[c];for(const u in h)o[u]=h[u]}return o}function a(o,l,c){const h=this,u={enumerable:!0};h.hasBeenReset=!1;let d="",g=!1,f=o,m=l,p=c,v=null,E="",T=!0,_="auto",S="start",A=50,b="middle",D=50,k="middle";Object.defineProperty(h,"id",r({},u,{get:function(){return d},set:function(R){d=""+R}})),Object.defineProperty(h,"pauseOnExit",r({},u,{get:function(){return g},set:function(R){g=!!R}})),Object.defineProperty(h,"startTime",r({},u,{get:function(){return f},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");f=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"endTime",r({},u,{get:function(){return m},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");m=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"text",r({},u,{get:function(){return p},set:function(R){p=""+R,this.hasBeenReset=!0}})),Object.defineProperty(h,"region",r({},u,{get:function(){return v},set:function(R){v=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"vertical",r({},u,{get:function(){return E},set:function(R){const P=i(R);if(P===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=P,this.hasBeenReset=!0}})),Object.defineProperty(h,"snapToLines",r({},u,{get:function(){return T},set:function(R){T=!!R,this.hasBeenReset=!0}})),Object.defineProperty(h,"line",r({},u,{get:function(){return _},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");_=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"lineAlign",r({},u,{get:function(){return S},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");S=P,this.hasBeenReset=!0}})),Object.defineProperty(h,"position",r({},u,{get:function(){return A},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");A=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"positionAlign",r({},u,{get:function(){return b},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");b=P,this.hasBeenReset=!0}})),Object.defineProperty(h,"size",r({},u,{get:function(){return D},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");D=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"align",r({},u,{get:function(){return k},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");k=P,this.hasBeenReset=!0}})),h.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class yf{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function nl(n){function e(i,s,r,a){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(a||0)}const t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class vf{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function rl(n,e,t,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const a=s[r].split(t);if(a.length!==2)continue;const o=a[0],l=a[1];e(o,l)}}const Cn=new _n(0,0,""),Bi=Cn.align==="middle"?"middle":"center";function Ef(n,e,t){const i=n;function s(){const o=nl(n);if(o===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const c=new vf;rl(o,function(d,g){let f;switch(d){case"region":for(let m=t.length-1;m>=0;m--)if(t[m].id===g){c.set(d,t[m].region);break}break;case"vertical":c.alt(d,g,["rl","lr"]);break;case"line":f=g.split(","),c.integer(d,f[0]),c.percent(d,f[0])&&c.set("snapToLines",!1),c.alt(d,f[0],["auto"]),f.length===2&&c.alt("lineAlign",f[1],["start",Bi,"end"]);break;case"position":f=g.split(","),c.percent(d,f[0]),f.length===2&&c.alt("positionAlign",f[1],["start",Bi,"end","line-left","line-right","auto"]);break;case"size":c.percent(d,g);break;case"align":c.alt(d,g,["start",Bi,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let h=c.get("line","auto");h==="auto"&&Cn.line===-1&&(h=-1),l.line=h,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",Bi);let u=c.get("position","auto");u==="auto"&&Cn.position===50&&(u=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=u}function a(){n=n.replace(/^\s+/,"")}if(a(),e.startTime=s(),a(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),a(),e.endTime=s(),a(),r(n,e)}function al(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class Tf{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new yf,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,a=0;for(r=al(r);a<r.length&&r[a]!=="\r"&&r[a]!==`
`;)++a;const o=r.slice(0,a);return r[a]==="\r"&&++a,r[a]===`
`&&++a,t.buffer=r.slice(a),o}function s(r){rl(r,function(a,o){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const o=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let a=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(a?a=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new _n(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{Ef(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(a=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Sf=/\r\n|\n\r|\n|\r/g,bn=function(e,t,i=0){return e.slice(i,i+t.length)===t},xf=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!N(t)||!N(i)||!N(s)||!N(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t},An=function(e){let t=5381,i=e.length;for(;i;)t=t*33^e.charCodeAt(--i);return(t>>>0).toString()};function wn(n,e,t){return An(n.toString())+An(e.toString())+An(t)}const Lf=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(a=r)!=null&&a.new;){var a;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function _f(n,e,t,i,s,r,a){const o=new Tf,l=Ue(new Uint8Array(n)).trim().replace(Sf,`
`).split(`
`),c=[],h=e?jd(e.baseTime,e.timescale):0;let u="00:00.000",d=0,g=0,f,m=!0;o.oncue=function(p){const v=t[i];let E=t.ccOffset;const T=(d-h)/9e4;if(v!=null&&v.new&&(g!==void 0?E=t.ccOffset=v.start:Lf(t,i,T)),T){if(!e){f=new Error("Missing initPTS for VTT MPEGTS");return}E=T-t.presentationOffset}const _=p.endTime-p.startTime,S=De((p.startTime+E-g)*9e4,s*9e4)/9e4;p.startTime=Math.max(S,0),p.endTime=Math.max(S+_,0);const A=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(A)),p.id||(p.id=wn(p.startTime,p.endTime,A)),p.endTime>0&&c.push(p)},o.onparsingerror=function(p){f=p},o.onflush=function(){if(f){a(f);return}r(c)},l.forEach(p=>{if(m)if(bn(p,"X-TIMESTAMP-MAP=")){m=!1,p.slice(16).split(",").forEach(v=>{bn(v,"LOCAL:")?u=v.slice(6):bn(v,"MPEGTS:")&&(d=parseInt(v.slice(7)))});try{g=xf(u)/1e3}catch(v){f=v}return}else p===""&&(m=!1);o.parse(p+`
`)}),o.flush()}const Rn="stpp.ttml.im1t",ol=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,ll=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Cf={left:"start",center:"center",right:"end",start:"start",end:"end"};function cl(n,e,t,i){const s=K(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(o=>Ue(o)),a=zd(e.baseTime,1,e.timescale);try{r.forEach(o=>t(bf(o,a)))}catch(o){i(o)}}function bf(n,e){const s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(r).reduce((u,d)=>(u[d]=s.getAttribute(`ttp:${d}`)||r[d],u),{}),o=s.getAttribute("xml:space")!=="preserve",l=hl(In(s,"styling","style")),c=hl(In(s,"layout","region")),h=In(s,"body","[begin]");return[].map.call(h,u=>{const d=ul(u,o);if(!d||!u.hasAttribute("begin"))return null;const g=Pn(u.getAttribute("begin"),a),f=Pn(u.getAttribute("dur"),a);let m=Pn(u.getAttribute("end"),a);if(g===null)throw dl(u);if(m===null){if(f===null)throw dl(u);m=g+f}const p=new _n(g-e,m-e,d);p.id=wn(p.startTime,p.endTime,p.text);const v=c[u.getAttribute("region")],E=l[u.getAttribute("style")],T=Af(v,E,l),{textAlign:_}=T;if(_){const S=Cf[_];S&&(p.lineAlign=S),p.align=_}return he(p,T),p}).filter(u=>u!==null)}function In(n,e,t){const i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function hl(n){return n.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function ul(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?ul(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function Af(n,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return a&&t.hasOwnProperty(a)&&(s=t[a]),r.reduce((o,l)=>{const c=Dn(e,i,l)||Dn(n,i,l)||Dn(s,i,l);return c&&(o[l]=c),o},{})}function Dn(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function dl(n){return new Error(`Could not parse ttml timestamp ${n}`)}function Pn(n,e){if(!n)return null;let t=nl(n);return t===null&&(ol.test(n)?t=wf(n,e):ll.test(n)&&(t=Rf(n,e))),t}function wf(n,e){const t=ol.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function Rf(n,e){const t=ll.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class fl{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=pl(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new Ui(this,"textTrack1"),t=new Ui(this,"textTrack2"),i=new Ui(this,"textTrack3"),s=new Ui(this,"textTrack4");this.cea608Parser1=new tl(1,e,t),this.cea608Parser2=new tl(3,i,s)}}addCues(e,t,i,s,r){let a=!1;for(let o=r.length;o--;){const l=r[o],c=If(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),a=!0,c/(i-t)>.5))return}if(a||r.push([t,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,i,s)}else{const o=this.Cues.newCue(null,t,i,s);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:o,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:a}=this;i==="main"&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(y.FRAG_LOADED,o)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(ml(r,{name:e,lang:t,attrs:{}}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:a}=t[e],o=this.getExistingTrack(r,a);if(o)i[e]=o,It(i[e]),qa(i[e],s);else{const l=this.createTextTrack("captions",r,a);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach(t=>{It(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=pl(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)It(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===Rn);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(Go(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const a=this.media,o=a?Ti(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let h;if(o){let u=null;for(let d=0;d<o.length;d++)if(o[d]&&ml(o[d],l)){u=o[d],o[d]=null;break}u&&(h=u)}if(h)It(h);else{const u=gl(l);h=this.createTextTrack(u,l.name,l.lang),h&&(h.mode="disabled")}h&&this.textTracks.push(h)}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&x.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,a=this.captionsProperties[r];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s,lastCc:r,lastSn:a,lastPartIndex:o}=this;if(!(!this.enabled||!i||!s)&&t.frag.type===B.MAIN){var l,c;const{cc:h,sn:u}=t.frag,d=(l=t==null||(c=t.part)==null?void 0:c.index)!=null?l:-1;u===a+1||u===a&&d===o+1||h===r||(i.reset(),s.reset()),this.lastCc=h,this.lastSn=u,this.lastPartIndex=d}}onFragLoaded(e,t){const{frag:i,payload:s}=t;if(i.type===B.SUBTITLE)if(s.byteLength){const r=i.decryptdata,a="stats"in t;if(r==null||!r.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===Rn?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;cl(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{x.log(`Failed to parse IMSC1: ${s}`),i.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;const{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[i.cc]&&o===-1){a.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?we(i.initSegment.data,new Uint8Array(s)):s;_f(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,h=>{this._appendCues(h,i.level),l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},h=>{const u=h.message==="Missing initPTS for VTT MPEGTS";u?a.push(e):this._fallbackToIMSC1(i,s),x.log(`Failed to parse VTT cue: ${h}`),!(u&&o>i.cc)&&l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:h})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||cl(t,this.initPTS[e.cc],()=>{i.textCodec=Rn,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>Xa(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(y.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===B.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s}=this;if(!this.enabled||!i||!s)return;const{frag:r,samples:a}=t;if(!(r.type===B.MAIN&&this.closedCaptionsForLevel(r)==="NONE"))for(let o=0;o<a.length;o++){const l=a[o].bytes;if(l){const c=this.extractCea608Data(l);i.addData(a[o].pts,c[0]),s.addData(a[o].pts,c[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>sn(o[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>sn(o[l],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const a=e[s++],o=127&e[s++],l=127&e[s++];if(o===0&&l===0)continue;if((4&a)!==0){const h=3&a;(h===0||h===1)&&(t[h].push(o),t[h].push(l))}}return t}}function gl(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function ml(n,e){return!!n&&n.kind===gl(e)&&xn(e,n)}function If(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function pl(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class $i{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&N(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&x.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,$i.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return e}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let r=e.length-1;const a=Math.max(t,i);for(let o=0;o<e.length;o+=1){const l=e[o];if((l.width>=a||l.height>=a)&&s(l,e[o+1])){r=o;break}}return r}}class yl{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,a=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*a/r,c=this.hls;if(c.trigger(y.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let h=c.currentLevel;x.warn("drop FPS ratio greater than max allowed value for currentLevel: "+h),h>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=h)&&(h=h-1,c.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:h,droppedLevel:c.currentLevel}),c.autoLevelCapping=h,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const Gi="[eme]";class xt{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=xt.CDMCleanupPromise?[xt.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=x.debug.bind(x,Gi),this.log=x.log.bind(x,Gi),this.warn=x.warn.bind(x,Gi),this.error=x.error.bind(x,Gi),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t[e];if(s)return s.licenseUrl;if(e===re.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,s=t.map(a=>a.audioCodec).filter(i),r=t.map(a=>a.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const h=c.shift();this.getMediaKeysPromise(h,s,r).then(u=>a({keySystem:h,mediaKeys:u})).catch(u=>{c.length?l(c):u instanceof Pe?o(u):o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_ACCESS,error:u,fatal:!0},u.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return Sa===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){const s=qh(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let a=r==null?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(s)}`),a=this.requestMediaKeySystemAccess(e,s);const o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),o.mediaKeys=l.createMediaKeys().then(h=>(this.log(`Media-keys created for "${e}"`),c.then(u=>u?this.setMediaKeysServerCertificate(h,e,u):h))),o.mediaKeys.catch(h=>{this.error(`Failed to create media-keys for "${e}"}: ${h}`)}),o.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Be.hexDump(e.keyId||[])}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return Be.hexDump(e.keyId)}updateKeySession(e,t){var i;const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${Be.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),s.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const s=Ys(this.config),r=e.map(va).filter(a=>!!a&&s.indexOf(a)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:a})=>{const o=Ta(a);o?t(o):i(new Error(`Unable to find format for key-system "${a}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then(({keySystem:a,mediaKeys:o})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(a,o).then(()=>{this.throwIfDestroyed();const l=this.createMediaKeySessionContext({keySystem:a,mediaKeys:o,decryptdata:t});return this.generateRequestWithPreferredKeySession(l,"cenc",t.pssh,"playlist-key")}))),r.catch(a=>this.handleError(a))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Pe?this.hls.trigger(y.ERROR,e.data):this.hls.trigger(y.ERROR,{type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=va(e.keyFormat),r=s?[s]:Ys(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=Ys(this.config)),e.length===0)throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),i===null)return;let s,r;if(t==="sinf"&&this.config.drmSystems[re.FAIRPLAY]){const h=ue(new Uint8Array(i));try{const u=Ks(JSON.parse(h).sinf),d=Ra(new Uint8Array(u));if(!d)return;s=d.subarray(8,24),r=re.FAIRPLAY}catch{this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{const h=Tu(i);if(h===null)return;h.version===0&&h.systemId===Ea.WIDEVINE&&h.data&&(s=h.data.subarray(8,24)),r=jh(h.systemId)}if(!r||!s)return;const a=Be.hexDump(s),{keyIdToKeySessionPromise:o,mediaKeySessions:l}=this;let c=o[a];for(let h=0;h<l.length;h++){const u=l[h],d=u.decryptdata;if(d.pssh||!d.keyId)continue;const g=Be.hexDump(d.keyId);if(a===g||d.uri.replace(/-/g,"").indexOf(a)!==-1){c=o[g],delete o[g],d.pssh=new Uint8Array(i),d.keyId=s,c=o[a]=c.then(()=>this.generateRequestWithPreferredKeySession(u,t,i,"encrypted-event-key-match"));break}}c||(c=o[a]=this.getKeySystemSelectionPromise([r]).then(({keySystem:h,mediaKeys:u})=>{var d;this.throwIfDestroyed();const g=new Rt("ISO-23001-7",a,(d=Ta(h))!=null?d:"");return g.pssh=new Uint8Array(i),g.keyId=s,this.attemptSetMediaKeys(h,u).then(()=>{this.throwIfDestroyed();const f=this.createMediaKeySessionContext({decryptdata:g,keySystem:h,mediaKeys:u});return this.generateRequestWithPreferredKeySession(f,t,i,"encrypted-event-no-match")})})),c.catch(h=>this.handleError(h))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r,a;const o=(r=this.config.drmSystems)==null||(a=r[e.keySystem])==null?void 0:a.generateRequest;if(o)try{const f=o.call(this.hls,t,i,e);if(!f)throw new Error("Invalid response from configured generateRequest filter");t=f.initDataType,i=e.decryptdata.pssh=f.initData?new Uint8Array(f.initData):null}catch(f){var l;if(this.warn(f.message),(l=this.hls)!=null&&l.config.debug)throw f}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${s}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const h=new Sn,u=e._onmessage=f=>{const m=e.mediaKeysSession;if(!m){h.emit("error",new Error("invalid state"));return}const{messageType:p,message:v}=f;this.log(`"${p}" message event for session "${m.sessionId}" message size: ${v.byteLength}`),p==="license-request"||p==="license-renewal"?this.renewLicense(e,v).catch(E=>{this.handleError(E),h.emit("error",E)}):p==="license-release"?e.keySystem===re.FAIRPLAY&&(this.updateKeySession(e,Ws("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${p}"`)},d=e._onkeystatuseschange=f=>{if(!e.mediaKeysSession){h.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const p=e.keyStatus;h.emit("keyStatus",p),p==="expired"&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",u),e.mediaKeysSession.addEventListener("keystatuseschange",d);const g=new Promise((f,m)=>{h.on("error",m),h.on("keyStatus",p=>{p.startsWith("usable")?f():p==="output-restricted"?m(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):p==="internal-error"?m(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${p}"`)):p==="expired"?m(new Error("key expired while generating request")):this.warn(`unhandled key status change "${p}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var f;this.log(`Request generated for key-session "${(f=e.mediaKeysSession)==null?void 0:f.sessionId}" keyId: ${c}`)}).catch(f=>{throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_SESSION,error:f,fatal:!1},`Error generating key-session request: ${f}`)}).then(()=>g).catch(f=>{throw h.removeAllListeners(),this.removeSession(e),f}).then(()=>(h.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${Be.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Be.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:r},c=t.certLoadPolicy.default,h={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,m)=>{a(d.data)},onError:(d,g,f,m)=>{o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:fe({url:l.url,data:void 0},d)},`"${e}" certificate request failed (${r}). Status: ${d.code} (${d.text})`))},onTimeout:(d,g,f)=>{o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(d,g,f)=>{o(new Error("aborted"))}};s.load(l,h,u)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),s(e)}).catch(a=>{r(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let h;for(let u=0,d=r.length;u<d;u++){var a,o;h=r[u];const g=(a=h.querySelector("name"))==null?void 0:a.textContent,f=(o=h.querySelector("value"))==null?void 0:o.textContent;g&&f&&e.setRequestHeader(g,f)}}const l=s.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Ws(atob(c))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(a=>{if(!i.decryptdata)throw a;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(a=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:a||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const a=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,e)}catch(h){this.error(h)}s(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)r(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const h=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${h} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==re.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Rt.clearKeyUriToKeyIdMap();const i=t.length;xt.CDMCleanupPromise=Promise.all(t.map(s=>this.removeSession(s)).concat(e==null?void 0:e.setMediaKeys(null).catch(s=>{this.log(`Could not clear media keys: ${s}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)}).catch(s=>{this.log(`Could not close sessions and clear media keys: ${s}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);return s>-1&&this.mediaKeySessions.splice(s,1),t.remove().catch(r=>{this.log(`Could not remove session: ${r}`)}).then(()=>t.close()).catch(r=>{this.log(`Could not close session: ${r}`)})}}}xt.CDMCleanupPromise=void 0;class Pe extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var Ee;(function(n){n.MANIFEST="m",n.AUDIO="a",n.VIDEO="v",n.MUXED="av",n.INIT="i",n.CAPTION="c",n.TIMED_TEXT="tt",n.KEY="k",n.OTHER="o"})(Ee||(Ee={}));var kn;(function(n){n.DASH="d",n.HLS="h",n.SMOOTH="s",n.OTHER="o"})(kn||(kn={}));var Lt;(function(n){n.OBJECT="CMCD-Object",n.REQUEST="CMCD-Request",n.SESSION="CMCD-Session",n.STATUS="CMCD-Status"})(Lt||(Lt={}));const Df={[Lt.OBJECT]:["br","d","ot","tb"],[Lt.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[Lt.SESSION]:["cid","pr","sf","sid","st","v"],[Lt.STATUS]:["bs","rtp"]};class $t{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map(i=>i instanceof $t?i:new $t(i))),this.value=e,this.params=t}}class vl{constructor(e){this.description=void 0,this.description=e}}const Pf="Dict";function kf(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function Ff(n,e,t,i){return new Error(`failed to ${n} "${kf(e)}" as ${t}`,{cause:i})}const El="Bare Item",Of="Boolean",Mf="Byte Sequence",Nf="Decimal",Uf="Integer";function Bf(n){return n<-999999999999999||999999999999999<n}const $f=/[\x00-\x1f\x7f]+/,Gf="Token",Vf="Key";function Ke(n,e,t){return Ff("serialize",n,e,t)}function Hf(n){if(typeof n!="boolean")throw Ke(n,Of);return n?"?1":"?0"}function Kf(n){return btoa(String.fromCharCode(...n))}function Wf(n){if(ArrayBuffer.isView(n)===!1)throw Ke(n,Mf);return`:${Kf(n)}:`}function Tl(n){if(Bf(n))throw Ke(n,Uf);return n.toString()}function Yf(n){return`@${Tl(n.getTime()/1e3)}`}function Sl(n,e){if(n<0)return-Sl(-n,e);const t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){const s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}function zf(n){const e=Sl(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Ke(n,Nf);const t=e.toString();return t.includes(".")?t:`${t}.0`}const jf="String";function qf(n){if($f.test(n))throw Ke(n,jf);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function Xf(n){return n.description||n.toString().slice(7,-1)}function xl(n){const e=Xf(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Ke(e,Gf);return e}function Fn(n){switch(typeof n){case"number":if(!N(n))throw Ke(n,El);return Number.isInteger(n)?Tl(n):zf(n);case"string":return qf(n);case"symbol":return xl(n);case"boolean":return Hf(n);case"object":if(n instanceof Date)return Yf(n);if(n instanceof Uint8Array)return Wf(n);if(n instanceof vl)return xl(n);default:throw Ke(n,El)}}function On(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw Ke(n,Vf);return n}function Mn(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${On(e)}`:`;${On(e)}=${Fn(t)}`).join("")}function Ll(n){return n instanceof $t?`${Fn(n.value)}${Mn(n.params)}`:Fn(n)}function Qf(n){return`(${n.value.map(Ll).join(" ")})${Mn(n.params)}`}function Zf(n,e={whitespace:!0}){if(typeof n!="object")throw Ke(n,Pf);const t=n instanceof Map?n.entries():Object.entries(n),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof $t||(r=new $t(r));let a=On(s);return r.value===!0?a+=Mn(r.params):(a+="=",Array.isArray(r.value)?a+=Qf(r):a+=Ll(r)),a}).join(`,${i}`)}function Jf(n,e){return Zf(n,e)}const eg=n=>n==="ot"||n==="sf"||n==="st",tg=n=>typeof n=="number"?N(n):n!=null&&n!==""&&n!==!1;function ig(n,e){const t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;const s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}function sg(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}const Vi=n=>Math.round(n),ng=(n,e)=>(e!=null&&e.baseUrl&&(n=ig(n,e.baseUrl)),encodeURIComponent(n)),Hi=n=>Vi(n/100)*100,rg={br:Vi,d:Vi,bl:Hi,dl:Hi,mtp:Hi,nor:ng,rtp:Hi,tb:Vi};function ag(n,e){const t={};if(n==null||typeof n!="object")return t;const i=Object.keys(n).sort(),s=he({},rg,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(a=>{if(r!=null&&r(a))return;let o=n[a];const l=s[a];l&&(o=l(o,e)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||tg(o)&&(eg(a)&&typeof o=="string"&&(o=new vl(o)),t[a]=o))}),t}function _l(n,e={}){return n?Jf(ag(n,e),he({whitespace:!1},e)):""}function og(n,e={}){if(!n)return{};const t=Object.entries(n),i=Object.entries(Df).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),s=t.reduce((r,a)=>{var o,l;const[c,h]=a,u=((o=i.find(d=>d[1].includes(c)))==null?void 0:o[0])||Lt.REQUEST;return(l=r[u])!=null||(r[u]={}),r[u][c]=h,r},{});return Object.entries(s).reduce((r,[a,o])=>(r[a]=_l(o,e),r),{})}function lg(n,e,t){return he(n,og(e,t))}const cg="CMCD";function hg(n,e={}){if(!n)return"";const t=_l(n,e);return`${cg}=${encodeURIComponent(t)}`}const Cl=/CMCD=[^&#]+/;function ug(n,e,t){const i=hg(e,t);if(!i)return n;if(Cl.test(n))return n.replace(Cl,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class bl{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:Ee.MANIFEST,su:!this.initialized})}catch(r){x.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const r=s.frag,a=this.hls.levels[r.level],o=this.getObjectType(r),l={d:r.duration*1e3,ot:o};(o===Ee.VIDEO||o===Ee.AUDIO||o==Ee.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(o)/1e3,l.bl=this.getBufferLength(o)),this.apply(s,l)}catch(r){x.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||sg(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHED,this.onMediaDetached,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHED,this.onMediaDetached,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:kn.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){he(t,this.createData());const i=t.ot===Ee.INIT||t.ot===Ee.VIDEO||t.ot===Ee.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((r,a)=>(s.includes(a)&&(r[a]=t[a]),r),{})),this.useHeaders?(e.headers||(e.headers={}),lg(e.headers,t)):e.url=ug(e.url,t)}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Ee.TIMED_TEXT;if(e.sn==="initSegment")return Ee.INIT;if(t==="audio")return Ee.AUDIO;if(t==="main")return this.hls.audioTracks.length?Ee.VIDEO:Ee.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===Ee.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,a=r>-1?r+1:s.levels.length;i=s.levels.slice(0,a)}for(const r of i)r.bitrate>t&&(t=r.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.hls.media,i=e===Ee.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:se.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}}const dg=3e5;class Al{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=x.log.bind(x,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===de.SendAlternateToPenaltyBox&&i.flags===Ie.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this.pathwayPriority,a=this.pathwayId;if(t.context){const{groupId:o,pathwayId:l,type:c}=t.context;o&&s?a=this.getPathwayForGroupId(o,c,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!r&&s&&(r=s.reduce((o,l)=>(o.indexOf(l.pathwayId)===-1&&o.push(l.pathwayId),o),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==a),i.resolved||x.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${a} levels: ${s&&s.length} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this.pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>dg&&delete i[r]});for(let r=0;r<e.length;r++){const a=e[r];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(a),t.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,so(t),this.hls.trigger(y.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(e,t,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===Q.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===Q.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(t.some(h=>h.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(h=>{const u=new ae(h.attrs);u["PATHWAY-ID"]=a;const d=u.AUDIO&&`${u.AUDIO}_clone_${a}`,g=u.SUBTITLES&&`${u.SUBTITLES}_clone_${a}`;d&&(i[u.AUDIO]=d,u.AUDIO=d),g&&(s[u.SUBTITLES]=g,u.SUBTITLES=g);const f=Rl(h.uri,u["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),m=new Tt({attrs:u,audioCodec:h.audioCodec,bitrate:h.bitrate,height:h.height,name:h.name,url:f,videoCodec:h.videoCodec,width:h.width});if(h.audioGroups)for(let p=1;p<h.audioGroups.length;p++)m.addGroupId("audio",`${h.audioGroups[p]}_clone_${a}`);if(h.subtitleGroups)for(let p=1;p<h.subtitleGroups.length;p++)m.addGroupId("text",`${h.subtitleGroups[p]}_clone_${a}`);return m});t.push(...c),wl(this.audioTracks,i,l,a),wl(this.subtitleTracks,s,l,a)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const h=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+h)}const r={responseType:"json",url:s.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(h,u,d,g)=>{this.log(`Loaded steering manifest: "${s}"`);const f=h.data;if(f.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":v}=f;if(m)try{this.uri=new self.URL(m,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||d.url),p&&this.clonePathways(p);const E={steeringManifest:f,url:s.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,E),v&&this.updatePathwayPriority(v)},onError:(h,u,d,g)=>{if(this.log(`Error loading steering manifest: ${h.code} ${h.text} (${u.url})`),this.stopLoad(),h.code===410){this.enabled=!1,this.log(`Steering manifest ${u.url} no longer available`);return}let f=this.timeToLoad*1e3;if(h.code===429){const m=this.loader;if(typeof(m==null?void 0:m.getResponseHeader)=="function"){const p=m.getResponseHeader("Retry-After");p&&(f=parseFloat(p)*1e3)}this.log(`Steering manifest ${u.url} rate limited`);return}this.scheduleRefresh(this.uri||u.url,f)},onTimeout:(h,u,d)=>{this.log(`Timeout loading steering manifest (${u.url})`),this.scheduleRefresh(this.uri||u.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function wl(n,e,t,i){n&&Object.keys(e).forEach(s=>{const r=n.filter(a=>a.groupId===s).map(a=>{const o=he({},a);return o.details=void 0,o.attrs=new ae(o.attrs),o.url=o.attrs.URI=Rl(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[s],o.attrs["PATHWAY-ID"]=i,o});n.push(...r)})}function Rl(n,e,t,i){const{HOST:s,PARAMS:r,[t]:a}=i;let o;e&&(o=a==null?void 0:a[e],o&&(n=o));const l=new self.URL(n);return s&&!o&&(l.host=s),r&&Object.keys(r).sort().forEach(c=>{c&&l.searchParams.set(c,r[c])}),l.href}const fg=/^age:\s*[\d.]+\s*$/im;class Il{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Xt,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!this.stats.aborted)return r(i,t.url)}).catch(a=>(i.open("GET",t.url,!0),r(i,t.url))).then(()=>{this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(a=>{this.callbacks.onError({code:i.status,text:a.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=i.loadPolicy;if(s)for(const o in s)e.setRequestHeader(o,s[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&N(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const a=t.status,o=t.responseType!=="text";if(a>=200&&a<300&&(o&&t.response||t.responseText!==null)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const l=o?t.response:t.responseText,c=t.responseType==="arraybuffer"?l.byteLength:l.length;if(i.loaded=i.total=c,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const h=this.callbacks.onProgress;if(h&&h(i,e,l,t),!this.callbacks)return;const u={url:t.responseURL,data:l,code:a};this.callbacks.onSuccess(u,i,e,t)}else{const l=r.loadPolicy.errorRetry,c=i.retry,h={url:e.url,data:void 0,code:a};_i(l,c,!1,h)?this.retry(l):(x.error(`${a} while loading ${e.url}`),this.callbacks.onError({code:a,text:t.statusText},e,t,i))}}}loadtimeout(){var e;const t=(e=this.config)==null?void 0:e.loadPolicy.timeoutRetry,i=this.stats.retry;if(_i(t,i,!0))this.retry(t);else{var s;x.warn(`timeout while loading ${(s=this.context)==null?void 0:s.url}`);const r=this.callbacks;r&&(this.abortInternal(),r.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=hn(e,i.retry),i.retry++,x.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&fg.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}function gg(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const mg=/(\d+)-(\d+)\/(\d+)/;class Dl{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Eg,this.controller=new self.AbortController,this.stats=new Xt}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=pg(e,this.controller.signal),a=i.onProgress,o=e.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:h}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=c&&N(c)?c:h,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},t.timeout),self.fetch(this.request).then(u=>{this.response=this.loader=u;const d=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=h,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},h-(d-s.loading.start)),!u.ok){const{status:g,statusText:f}=u;throw new Tg(f||"fetch, bad network response",g,u)}return s.loading.first=d,s.total=vg(u.headers)||s.total,a&&N(t.highWaterMark)?this.loadProgressively(u,s,e,t.highWaterMark,a):o?u.arrayBuffer():e.responseType==="json"?u.json():u.text()}).then(u=>{const d=this.response;if(!d)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const g=u[l];g&&(s.loaded=s.total=g);const f={url:d.url,data:u,code:d.status};a&&!N(t.highWaterMark)&&a(s,e,u,d),i.onSuccess(f,s,e,d)}).catch(u=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const d=u&&u.code||0,g=u?u.message:null;i.onError({code:d,text:g},e,u?u.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const a=new vo,o=e.body.getReader(),l=()=>o.read().then(c=>{if(c.done)return a.dataLength&&r(t,i,a.flush(),e),Promise.resolve(new ArrayBuffer(0));const h=c.value,u=h.length;return t.loaded+=u,u<s||a.dataLength?(a.push(h),a.dataLength>=s&&r(t,i,a.flush(),e)):r(t,i,h,e),l()}).catch(()=>Promise.reject());return l()}}function pg(n,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(he({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function yg(n){const e=mg.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function vg(n){const e=n.get("Content-Range");if(e){const i=yg(e);if(N(i))return i}const t=n.get("Content-Length");if(t)return parseInt(t)}function Eg(n,e){return new self.Request(n.url,e)}class Tg extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const Sg=/\s/,xg={newCue(n,e,t,i){const s=[];let r,a,o,l,c;const h=self.VTTCue||self.TextTrackCue;for(let d=0;d<i.rows.length;d++)if(r=i.rows[d],o=!0,l=0,c="",!r.isEmpty()){var u;for(let m=0;m<r.chars.length;m++)Sg.test(r.chars[m].uchar)&&o?l++:(c+=r.chars[m].uchar,o=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const g=al(c.trim()),f=wn(e,t,g);n!=null&&(u=n.cues)!=null&&u.getCueById(f)||(a=new h(e,t,g),a.id=f,a.line=d+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),s.push(a))}return n&&s.length&&(s.sort((d,g)=>d.line==="auto"||g.line==="auto"?0:d.line>8&&g.line>8?g.line-d.line:d.line-g.line),s.forEach(d=>Xa(n,d))),s}},Lg={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Pl=fe(fe({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Il,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:uo,bufferController:qo,capLevelController:$i,errorController:oo,fpsController:yl,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Sa,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:Lg},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},_g()),{},{subtitleStreamController:Yo,subtitleTrackController:zo,timelineController:fl,audioStreamController:Ho,audioTrackController:Ko,emeController:xt,cmcdController:bl,contentSteeringController:Al});function _g(){return{cueHandler:xg,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Cg(n,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const t=Nn(n),i=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const a=`${r==="level"?"playlist":r}LoadPolicy`,o=e[a]===void 0,l=[];s.forEach(c=>{const h=`${r}Loading${c}`,u=e[h];if(u!==void 0&&o){l.push(h);const d=t[a].default;switch(e[a]={default:d},c){case"TimeOut":d.maxLoadTimeMs=u,d.maxTimeToFirstByteMs=u;break;case"MaxRetry":d.errorRetry.maxNumRetry=u,d.timeoutRetry.maxNumRetry=u;break;case"RetryDelay":d.errorRetry.retryDelayMs=u,d.timeoutRetry.retryDelayMs=u;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=u,d.timeoutRetry.maxRetryDelayMs=u;break}}}),l.length&&x.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${JSON.stringify(e[a])}`)}),fe(fe({},t),e)}function Nn(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(Nn):Object.keys(n).reduce((e,t)=>(e[t]=Nn(n[t]),e),{}):n}function bg(n){const e=n.loader;e!==Dl&&e!==Il?(x.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):gg()&&(n.loader=Dl,n.progressive=!0,n.enableSoftwareAES=!0,x.log("[config]: Progressive streaming enabled, using FetchLoader"))}let Un;class Ag extends bi{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,s=[],r={},a={};let o=!1,l=!1,c=!1;t.levels.forEach(h=>{var u,d;const g=h.attrs;let{audioCodec:f,videoCodec:m}=h;((u=f)==null?void 0:u.indexOf("mp4a.40.34"))!==-1&&(Un||(Un=/chrome|firefox/i.test(navigator.userAgent)),Un&&(h.audioCodec=f=void 0)),f&&(h.audioCodec=f=Ei(f,i)),((d=m)==null?void 0:d.indexOf("avc1"))===0&&(m=h.videoCodec=bu(m));const{width:p,height:v,unknownCodecs:E}=h;if(o||(o=!!(p&&v)),l||(l=!!m),c||(c=!!f),E!=null&&E.length||f&&!Js(f,"audio",i)||m&&!Js(m,"video",i))return;const{CODECS:T,"FRAME-RATE":_,"HDCP-LEVEL":S,"PATHWAY-ID":A,RESOLUTION:b,"VIDEO-RANGE":D}=g,R=`${`${A||"."}-`}${h.bitrate}-${b}-${_}-${T}-${D}-${S}`;if(r[R])if(r[R].uri!==h.url&&!h.attrs["PATHWAY-ID"]){const P=a[R]+=1;h.attrs["PATHWAY-ID"]=new Array(P+1).join(".");const W=new Tt(h);r[R]=W,s.push(W)}else r[R].addGroupId("audio",g.AUDIO),r[R].addGroupId("text",g.SUBTITLES);else{const P=new Tt(h);r[R]=P,a[R]=1,s.push(P)}}),this.filterAndSortMediaOptions(s,t,o,l,c)}filterAndSortMediaOptions(e,t,i,s,r){let a=[],o=[],l=e;if((i||s)&&r&&(l=l.filter(({videoCodec:f,videoRange:m,width:p,height:v})=>(!!f||!!(p&&v))&&Bu(m))),l.length===0){Promise.resolve().then(()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const f=new Error("no level with compatible codecs found in manifest");this.hls.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:f,reason:f.message})}});return}if(t.audioTracks){const{preferManagedMediaSource:f}=this.hls.config;a=t.audioTracks.filter(m=>!m.audioCodec||Js(m.audioCodec,"audio",f)),kl(a)}t.subtitles&&(o=t.subtitles,kl(o));const c=l.slice(0);l.sort((f,m)=>{if(f.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"])return(f.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&f.height!==m.height)return f.height-m.height;if(f.frameRate!==m.frameRate)return f.frameRate-m.frameRate;if(f.videoRange!==m.videoRange)return xi.indexOf(f.videoRange)-xi.indexOf(m.videoRange);if(f.videoCodec!==m.videoCodec){const p=Na(f.videoCodec),v=Na(m.videoCodec);if(p!==v)return v-p}if(f.uri===m.uri&&f.codecSet!==m.codecSet){const p=vi(f.codecSet),v=vi(m.codecSet);if(p!==v)return v-p}return f.bitrate!==m.bitrate?f.bitrate-m.bitrate:0});let h=c[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==c.length)){for(let f=0;f<c.length;f++)if(c[f].pathwayId===l[0].pathwayId){h=c[f];break}}this._levels=l;for(let f=0;f<l.length;f++)if(l[f]===h){var u;this._firstLevel=f;const m=h.bitrate,p=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${m}`),((u=this.hls.userConfig)==null?void 0:u.abrEwmaDefaultEstimate)===void 0){const v=Math.min(m,this.hls.config.abrEwmaDefaultEstimateMax);v>p&&p===Pl.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=v)}break}const d=r&&!s,g={levels:l,audioTracks:a,subtitleTracks:o,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:!d&&a.some(f=>!!f.url)};this.hls.trigger(y.MANIFEST_PARSED,g),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const h=new Error("invalid level idx"),u=e<0;if(this.hls.trigger(y.ERROR,{type:$.OTHER_ERROR,details:C.LEVEL_SWITCH_ERROR,level:e,fatal:u,error:h,reason:h.message}),u)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,a=t[e],o=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=a,i===e&&a.details&&s&&r===o)return;this.log(`Switching to level ${e} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${o?" with Pathway "+o:""} from level ${i}${r?" with Pathway "+r:""}`);const l={level:e,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(y.LEVEL_SWITCHING,l);const c=a.details;if(!c||c.live){const h=this.switchParams(a.uri,s==null?void 0:s.details);this.loadPlaylist(h)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){t.fatal||!t.context||t.context.type===Q.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===B.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,a=this._levels[s];if(!a){var o;this.warn(`Invalid level index ${s}`),(o=t.deliveryDirectives)!=null&&o.skip&&(r.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0),this.playlistLoaded(s,t,a.details)):(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let s=i.uri;if(e)try{s=e.addDirectives(s)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}const r=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${(e==null?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""} with${r?" Pathway "+r:""} ${s}`),this.clearTimer(),this.hls.trigger(y.LEVEL_LOADING,{url:s,level:t,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const i=this._levels.filter((s,r)=>r!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));so(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(y.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(y.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function kl(n){const e={};n.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}class wg{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=C.KEY_LOAD_ERROR,i,s,r){return new qe({type:$.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){const a=t[r];if(s<=a.cc&&(i==="initSegment"||a.sn==="initSegment"||i<a.sn)){this.emeController.selectKeySystemFormat(a).then(o=>{a.setKeyFormat(o)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const c=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,c))}const a=r.uri;if(!a)return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${a}"`)));let o=this.keyUriToKeyInfo[a];if((i=o)!=null&&i.decryptdata.key)return r.key=o.decryptdata.key,Promise.resolve({frag:e,keyInfo:o});if((s=o)!=null&&s.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(c=>(r.key=c.keyInfo.decryptdata.key,{frag:e,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[a]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(o,e):this.loadKeyEME(o,e);case"AES-128":return this.loadKeyHTTP(o,e);default:return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((a,o)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},c=i.keyLoadPolicy.default,h={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,m)=>{const{frag:p,keyInfo:v,url:E}=f;if(!p.decryptdata||v!==this.keyUriToKeyInfo[E])return o(this.createKeyLoadError(p,C.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));v.decryptdata.key=p.decryptdata.key=new Uint8Array(d.data),p.keyLoader=null,v.loader=null,a({frag:p,keyInfo:v})},onError:(d,g,f,m)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.KEY_LOAD_ERROR,new Error(`HTTP Error ${d.code} loading key ${d.text}`),f,fe({url:l.url,data:void 0},d)))},onTimeout:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),f))},onAbort:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.INTERNAL_ABORTED,new Error("key loading aborted"),f))}};r.load(l,h,u)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function Fl(){return self.SourceBuffer||self.WebKitSourceBuffer}function Bn(){if(!Et())return!1;const e=Fl();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function Ol(){if(!Bn())return!1;const n=Et();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(Zt(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(Zt(e,"audio"))))}function Rg(){var n;const e=Fl();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}const Ig=250,Ki=2,Dg=.1,Pg=.05;class kg{constructor(e,t,i,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:s,stalled:r}=this;if(s===null)return;const{currentTime:a,seeking:o}=s,l=this.seeking&&!o,c=!this.seeking&&o;if(this.seeking=o,a!==e){if(this.moved=!0,o||(this.nudgeRetry=0),r!==null){if(this.stallReported){const p=self.performance.now()-r;x.warn(`playback not stuck anymore @${a}, after ${Math.round(p)}ms`),this.stallReported=!1}this.stalled=null}return}if(c||l){this.stalled=null;return}if(s.paused&&!o||s.ended||s.playbackRate===0||!se.getBuffered(s).length){this.nudgeRetry=0;return}const h=se.bufferInfo(s,a,0),u=h.nextStart||0;if(o){const p=h.len>Ki,v=!u||t&&t.start<=a||u-a>Ki&&!this.fragmentTracker.getPartialFragment(a);if(p||v)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var d;if(!(h.len>0)&&!u)return;const v=Math.max(u,h.start||0)-a,E=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,_=(E==null||(d=E.details)==null?void 0:d.live)?E.details.targetduration*2:Ki,S=this.fragmentTracker.getPartialFragment(a);if(v>0&&(v<=_||S)){s.paused||this._trySkipBufferHole(S);return}}const g=self.performance.now();if(r===null){this.stalled=g;return}const f=g-r;if(!o&&f>=Ig&&(this._reportStall(h),!this.media))return;const m=se.bufferInfo(s,a,i.maxBufferHole);this._tryFixBufferStall(m,f)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:s,media:r}=this;if(r===null)return;const a=r.currentTime,o=s.getPartialFragment(a);o&&(this._trySkipBufferHole(o)||!this.media)||(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-a<i.maxBufferHole)&&t>i.highBufferWatchdogPeriod*1e3&&(x.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:s}=this;if(!s&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);x.warn(r.message),t.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:s}=this;if(s===null)return 0;const r=s.currentTime,a=se.bufferInfo(s,r,0),o=r<a.start?a.start:a.nextStart;if(o){const l=a.len<=t.maxBufferHole,c=a.len>0&&a.len<1&&s.readyState<3,h=o-r;if(h>0&&(l||c)){if(h>t.maxBufferHole){const{fragmentTracker:d}=this;let g=!1;if(r===0){const f=d.getAppendedFrag(0,B.MAIN);f&&o<f.end&&(g=!0)}if(!g){const f=e||d.getAppendedFrag(r,B.MAIN);if(f){let m=!1,p=f.end;for(;p<o;){const v=d.getPartialFragment(p);if(v)p+=v.duration;else{m=!0;break}}if(m)return 0}}}const u=Math.max(o+Pg,r+Dg);if(x.warn(`skipping hole, adjusting currentTime from ${r} to ${u}`),this.moved=!0,this.stalled=null,s.currentTime=u,e&&!e.gap){const d=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${u}`);i.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:d,reason:d.message,frag:e})}return u}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:s}=this;if(i===null)return;const r=i.currentTime;if(this.nudgeRetry++,s<e.nudgeMaxRetry){const a=r+(s+1)*e.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${r} to ${a}`);x.warn(o.message),i.currentTime=a,t.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const a=new Error(`Playhead still not moving while enough data buffered @${r} after ${e.nudgeMaxRetry} nudges`);x.error(a.message),t.trigger(y.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_STALLED_ERROR,error:a,fatal:!0})}}}const Fg=100;class Og extends Pi{constructor(e,t,i){super(e,t,i,"[stream-controller]",B.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(y.ERROR,this.onError,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(y.ERROR,this.onError,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(Fg),this.level=-1,!this.startFragRequested){let s=i.startLevel;s===-1&&(i.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=i.firstAutoLevel),this.level=i.nextLoadLevel=s,this.loadedmetadata=!1}t>0&&e===-1&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=I.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=I.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case I.WAITING_LEVEL:{const{levels:t,level:i}=this,s=t==null?void 0:t[i],r=s==null?void 0:s.details;if(r&&(!r.live||this.levelLastLoaded===s)){if(this.waitForCdnTuneIn(r))break;this.state=I.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=I.IDLE;break}break}case I.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:s,level:r}=this,a=s==null?void 0:s[r];this.resetStartWhenNotLoaded(a||null),this.state=I.IDLE}}break}this.state===I.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this,{config:r,nextLoadLevel:a}=e;if(t===null||!s&&(this.startFragRequested||!r.startFragPrefetch)||this.altAudio&&this.audioOnly||!(i!=null&&i[a]))return;const o=i[a],l=this.getMainFwdBufferInfo();if(l===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(l,c)){const p={};this.altAudio&&(p.type="video"),this.hls.trigger(y.BUFFER_EOS,p),this.state=I.ENDED;return}e.loadLevel!==a&&e.manualLevel===-1&&this.log(`Adapting to level ${a} from level ${this.level}`),this.level=e.nextLoadLevel=a;const h=o.details;if(!h||this.state===I.WAITING_LEVEL||h.live&&this.levelLastLoaded!==o){this.level=a,this.state=I.WAITING_LEVEL;return}const u=l.len,d=this.getMaxBufferLength(o.maxBitrate);if(u>=d)return;this.backtrackFragment&&this.backtrackFragment.start>l.end&&(this.backtrackFragment=null);const g=this.backtrackFragment?this.backtrackFragment.start:l.end;let f=this.getNextFragment(g,h);if(this.couldBacktrack&&!this.fragPrevious&&f&&f.sn!=="initSegment"&&this.fragmentTracker.getState(f)!==ge.OK){var m;const v=((m=this.backtrackFragment)!=null?m:f).sn-h.startSN,E=h.fragments[v-1];E&&f.cc===E.cc&&(f=E,this.fragmentTracker.removeFragment(E))}else this.backtrackFragment&&l.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,g)){if(!f.gap){const v=this.audioOnly&&!this.altAudio?te.AUDIO:te.VIDEO,E=(v===te.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;E&&this.afterBufferFlushed(E,v,B.MAIN)}f=this.getNextFragmentLoopLoading(f,h,l,B.MAIN,d)}f&&(f.initSegment&&!f.initSegment.data&&!this.bitrateTest&&(f=f.initSegment),this.loadFragment(f,o,g))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);this.fragCurrent=e,s===ge.NOT_LOADED||s===ge.PARTIAL?e.sn==="initSegment"?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,B.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<r.targetduration*2)return}if(!t.paused&&e){const o=this.hls.nextLoadLevel,l=e[o],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const a=this.getBufferedFrag(t.currentTime+i);if(a){const o=this.followingBufferedFrag(a);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,c=o.duration,h=Math.max(a.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(h,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case I.KEY_LOADING:case I.FRAG_LOADING:case I.FRAG_LOADING_WAITING_RETRY:case I.PARSING:case I.PARSED:this.state=I.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new kg(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;N(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(y.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let i=!1,s=!1;t.levels.forEach(r=>{const a=r.audioCodec;a&&(i=i||a.indexOf("mp4a.40.2")!==-1,s=s||a.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!Rg(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==I.IDLE)return;const s=i[t.level];(!s.details||s.details.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(s.details))&&(this.state=I.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s}=this,r=t.level,a=t.details,o=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=s[r],c=this.fragCurrent;c&&(this.state===I.FRAG_LOADING||this.state===I.FRAG_LOADING_WAITING_RETRY)&&c.level!==t.level&&c.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=l.details)!=null&&i.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details)}if(l.details=a,this.levelLastLoaded=l,this.hls.trigger(y.LEVEL_UPDATED,{details:a,level:r}),this.state===I.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=I.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,h),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{levels:a}=this;if(!a){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const o=a[i.level],l=o.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=o.videoCodec,h=l.PTSKnown||!l.live,u=(t=i.initSegment)==null?void 0:t.data,d=this._getAudioCodec(o),g=this.transmuxer=this.transmuxer||new $o(this.hls,B.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=s?s.index:-1,m=f!==-1,p=new wi(i.level,i.sn,i.stats.chunkCount,r.byteLength,f,m),v=this.initPTS[i.cc];g.push(r,u,d,c,i,s,l.totalduration,h,p,v)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const a=this.fragCurrent;a&&(this.log("Switching to main audio track, cancel main fragment load"),a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const r=this.hls;i&&(r.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),r.trigger(y.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,s=!!this.hls.audioTracks[i].url;if(s){const r=this.videoBuffer;r&&this.mediaBuffer!==r&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=r)}this.altAudio=s,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,a=!1;for(const o in i){const l=i[o];if(l.id==="main"){if(r=o,s=l,o==="video"){const c=i[o];c&&(this.videoBuffer=c.buffer)}}else a=!0}a&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i&&i.type!==B.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===I.PARSED&&(this.state=I.IDLE);return}const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=I.ERROR;return}switch(t.details){case C.FRAG_GAP:case C.FRAG_PARSING_ERROR:case C.FRAG_DECRYPT_ERROR:case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(B.MAIN,t);break;case C.LEVEL_LOAD_ERROR:case C.LEVEL_LOAD_TIMEOUT:case C.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===I.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Q.LEVEL&&(this.state=I.IDLE);break;case C.BUFFER_APPEND_ERROR:case C.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="main")return;if(t.details===C.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case C.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}checkBuffer(){const{media:e,gapController:t}=this;if(!(!e||!t||!e.readyState)){if(this.loadedmetadata||!se.getBuffered(e).length){const i=this.state!==I.IDLE?this.fragCurrent:null;t.poll(this.lastCurrentTime,i)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=I.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==te.AUDIO||this.audioOnly&&!this.altAudio){const i=(t===te.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,t,B.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=se.getBuffered(e),a=(s.length?s.start(0):0)-i;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${a} to match buffer start`),i+=a,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=I.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=e.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),s.trigger(y.FRAG_LOADED,i),e.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:h}=o,{video:u,text:d,id3:g,initSegment:f}=r,{details:m}=h,p=this.altAudio?void 0:r.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=I.PARSING,f){if(f!=null&&f.tracks){const T=l.initSegment||l;this._bufferInitSegment(h,f.tracks,T,a),s.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:i,tracks:f.tracks})}const v=f.initPTS,E=f.timescale;N(v)&&(this.initPTS[l.cc]={baseTime:v,timescale:E},s.trigger(y.INIT_PTS_FOUND,{frag:l,id:i,initPTS:v,timescale:E}))}if(u&&m&&l.sn!=="initSegment"){const v=m.fragments[l.sn-1-m.startSN],E=l.sn===m.startSN,T=!v||l.cc>v.cc;if(r.independent!==!1){const{startPTS:_,endPTS:S,startDTS:A,endDTS:b}=u;if(c)c.elementaryStreams[u.type]={startPTS:_,endPTS:S,startDTS:A,endDTS:b};else if(u.firstKeyFrame&&u.independent&&a.id===1&&!T&&(this.couldBacktrack=!0),u.dropped&&u.independent){const D=this.getMainFwdBufferInfo(),k=(D?D.end:this.getLoadPosition())+this.config.maxBufferHole,R=u.firstKeyFramePTS?u.firstKeyFramePTS:_;if(!E&&k<R-this.config.maxBufferHole&&!T){this.backtrack(l);return}else T&&(l.gap=!0);l.setElementaryStreamInfo(u.type,l.start,S,l.start,b,!0)}else E&&_>Ki&&(l.gap=!0);l.setElementaryStreamInfo(u.type,_,S,A,b),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(u,l,c,a,E||T)}else if(E||T)l.gap=!0;else{this.backtrack(l);return}}if(p){const{startPTS:v,endPTS:E,startDTS:T,endDTS:_}=p;c&&(c.elementaryStreams[te.AUDIO]={startPTS:v,endPTS:E,startDTS:T,endDTS:_}),l.setElementaryStreamInfo(te.AUDIO,v,E,T,_),this.bufferFragmentData(p,l,c,a)}if(m&&g!=null&&(t=g.samples)!=null&&t.length){const v={id:i,frag:l,details:m,samples:g.samples};s.trigger(y.FRAG_PARSING_METADATA,v)}if(m&&d){const v={id:i,frag:l,details:m,samples:d.samples};s.trigger(y.FRAG_PARSING_USERDATA,v)}}_bufferInitSegment(e,t,i,s){if(this.state!==I.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:a,audiovideo:o}=t;if(r){let l=e.audioCodec;const c=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5"),r.metadata.channelCount!==1&&c.indexOf("firefox")===-1&&(l="mp4a.40.5")),l&&l.indexOf("mp4a.40.5")!==-1&&c.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),e.audioCodec&&e.audioCodec!==l&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${l}"`),r.levelCodec=l,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${l||""}/${e.audioCodec||""}/${r.codec}]`)}a&&(a.levelCodec=e.videoCodec,a.id="main",this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${e.videoCodec||""}/${a.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${e.codecs}/${o.codec}]`),this.hls.trigger(y.BUFFER_CODECS,t),Object.keys(t).forEach(l=>{const h=t[l].initSegment;h!=null&&h.byteLength&&this.hls.trigger(y.BUFFER_APPENDING,{type:l,data:h,frag:i,part:null,chunkMeta:s,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,B.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=I.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(se.isBuffered(e,i)?t=this.getAppendedFrag(i):se.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(y.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(y.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&N(t)&&N(i.programDateTime)){const s=i.programDateTime+(t-i.start)*1e3;return new Date(s)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class ot{static get version(){return"1.5.1"}static isMSESupported(){return Bn()}static isSupported(){return Ol()}static getMediaSource(){return Et()}static get Events(){return y}static get ErrorTypes(){return $}static get ErrorDetails(){return C}static get DefaultConfig(){return ot.defaultConfig?ot.defaultConfig:Pl}static set DefaultConfig(e){ot.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new Sn,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,$h(e.debug||!1,"Hls instance");const t=this.config=Cg(ot.DefaultConfig,e);this.userConfig=e,t.progressive&&bg(t);const{abrController:i,bufferController:s,capLevelController:r,errorController:a,fpsController:o}=t,l=new a(this),c=this.abrController=new i(this),h=this.bufferController=new s(this),u=this.capLevelController=new r(this),d=new o(this),g=new Du(this),f=new Mu(this),m=t.contentSteeringController,p=m?new m(this):null,v=this.levelController=new Ag(this,p),E=new cd(this),T=new wg(this.config),_=this.streamController=new Og(this,E,T);u.setStreamController(_),d.setStreamController(_);const S=[g,v,_];p&&S.splice(1,0,p),this.networkControllers=S;const A=[c,h,u,d,f,E];this.audioTrackController=this.createController(t.audioTrackController,S);const b=t.audioStreamController;b&&S.push(new b(this,E,T)),this.subtitleTrackController=this.createController(t.subtitleTrackController,S);const D=t.subtitleStreamController;D&&S.push(new D(this,E,T)),this.createController(t.timelineController,A),T.emeController=this.emeController=this.createController(t.emeController,A),this.cmcdController=this.createController(t.cmcdController,A),this.latencyController=this.createController(Nu,A),this.coreComponents=A,S.push(l);const k=l.onErrorOut;typeof k=="function"&&this.on(y.ERROR,k,l)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(x.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=e===y.ERROR;this.trigger(y.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,fatal:s,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){x.log("destroy"),this.trigger(y.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){x.log("attachMedia"),this._media=e,this.trigger(y.MEDIA_ATTACHING,{media:e})}detachMedia(){x.log("detachMedia"),this.trigger(y.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,s=this.url=$s.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,x.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(y.MANIFEST_LOADING,{url:e})}startLoad(e=-1){x.log(`startLoad(${e})`),this.started=!0,this.networkControllers.forEach(t=>{t.startLoad(e)})}stopLoad(){x.log("stopLoad"),this.started=!1,this.networkControllers.forEach(e=>{e.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.stopLoad()})}swapAudioCodec(){x.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){x.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){x.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){x.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){x.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){x.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){x.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(x.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Uu(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e!=null&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const a=e[r].attrs["HDCP-LEVEL"];if(a&&a<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return(t=this.audioTrackController)==null?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return(t=this.subtitleTrackController)==null||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}ot.defaultConfig=void 0;const Mg=Object.freeze(Object.defineProperty({__proto__:null,AbrController:uo,AttrList:ae,AudioStreamController:Ho,AudioTrackController:Ko,BasePlaylistController:bi,BaseSegment:Hs,BaseStreamController:Pi,BufferController:qo,CMCDController:bl,CapLevelController:$i,ChunkMetadata:wi,ContentSteeringController:Al,DateRange:Vs,EMEController:xt,ErrorActionFlags:Ie,ErrorController:oo,ErrorDetails:C,ErrorTypes:$,Events:y,FPSController:yl,Fragment:di,Hls:ot,HlsSkip:Dt,HlsUrlParameters:on,KeySystemFormats:Se,KeySystems:re,Level:Tt,LevelDetails:ya,LevelKey:Rt,LoadStats:Xt,MetadataSchema:Re,NetworkErrorAction:de,Part:pa,PlaylistLevelType:B,SubtitleStreamController:Yo,SubtitleTrackController:zo,TimelineController:fl,default:ot,getMediaSource:Et,isMSESupported:Bn,isSupported:Ol},Symbol.toStringTag,{value:"Module"}));w.AudioOnlyVideo=hr,w.AudioTrackData=Ji,w.AudioVideoPlugin=ur,w.ButtonGroupPlugin=qr,w.ButtonPlugin=Es,w.Canvas=_s,w.CanvasButtonPlugin=Fc,w.CanvasButtonPosition=ne,w.CanvasPlugin=Cs,w.Captions=os,w.CaptionsPlugin=as,w.DFXPParser=xr,w.Data=jr,w.DataPlugin=Ds,w.DefaultKeyShortcutsPlugin=Sr,w.DfxpManifestCaptionsPlugin=Lr,w.DomClass=be,w.DualVideoDynamicLayoutPlugin=ws,w.DualVideoLayoutPlugin=Vr,w.EventLogPlugin=Eh,w.Events=F,w.HlsSupport=ve,w.HlsVideo=ss,w.HlsVideoFormatPlugin=mr,w.ImageVideo=yr,w.ImageVideoFormatPlugin=vr,w.KeyCodes=Te,w.KeyShortcutPlugin=Tr,w.LOG_LEVEL=ce,w.Loader=or,w.Log=ra,w.ManifestParser=ca,w.MenuButtonPlugin=Ih,w.Mp4Video=ri,w.Mp4VideoFormatPlugin=fr,w.Paella=Rh,w.PlayPauseButtonPlugin=Fr,w.PlayerResource=ut,w.PlayerState=z,w.PlayerStateNames=Fe,w.Plugin=Ye,w.PluginModule=Vt,w.PopUp=Le,w.PopUpButtonPlugin=ui,w.ProgressIndicatorPlugin=Dh,w.SingleVideoLayoutPlugin=Kr,w.TripleVideoLayoutPlugin=Wr,w.UserInterfacePlugin=oi,w.Video=si,w.VideoCanvas=Yr,w.VideoCanvasPlugin=zr,w.VideoContainerMessagePosition=ye,w.VideoLayout=pt,w.VideoPlugin=ft,w.VideoQualityItem=gt,w.VttManifestCaptionsPlugin=Nr,w.WebVTTParser=Mr,w.addDictionary=At,w.bindEvent=ie,w.checkManifestIntegrity=Qr,w.createElement=Wi,w.createElementWithHtmlText=j,w.defaultAddDictionaryFunction=fs,w.defaultGetCookieConsentCallback=Ns,w.defaultGetCookieDescriptionCallback=Us,w.defaultGetDefaultLanguageFunction=ms,w.defaultGetDictionariesFunction=gs,w.defaultGetLanguageFunction=ds,w.defaultGetManifestFileUrlFunction=rr,w.defaultGetManifestUrlFunction=nr,w.defaultGetVideoIdFunction=sr,w.defaultHlsConfig=es,w.defaultLoadConfigFunction=ir,w.defaultLoadVideoManifestFunction=ar,w.defaultSetLanguageFunction=us,w.defaultTranslateFunction=hs,w.getCurrentTabIndex=Lc,w.getDefaultLanguage=ys,w.getDictionaries=Pr,w.getHlsSupport=ke,w.getLanguage=Dr,w.getNextTabIndex=vs,w.getPluginsOfType=Os,w.getShortcuts=Er,w.importPlugins=Jc,w.isVolumeApiAvailable=cr,w.loadPluginsOfType=Ae,w.log=nt,w.parseDFXP=ls,w.parseWebVTT=Ts,w.setLanguage=ps,w.translate=mt,w.triggerEvent=X,w.triggerIfReady=ht,w.utils=Hl,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
